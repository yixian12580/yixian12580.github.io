<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1"><link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.1",sidebar:{position:"left",display:"post",offset:12,onmobile:!0,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!0,fastclick:!0,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"shrinkIn",post_header:"slideLeftIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideDownIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,c,a,i,n){e.DaoVoiceObject=a,e[a]=e[a]||function(){(e[a].q=e[a].q||[]).push(arguments)},e[a].l=+new Date,i=t.createElement(o),n=t.getElementsByTagName(o)[0],i.async=1,i.src=c,i.charset="utf-8",n.parentNode.insertBefore(i,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"aac7f9b5"}),daovoice("update")</script><meta name="description" content="cert-manager 是一个云原生证书管理开源项目，用于在 Kubernetes 集群中自动管理和颁发来自各种颁发源的 TLS 证书，它可以从各种受支持的来源颁发证书，包括 Let’s Encrypt、HashiCorp Vault和Venafi以及私有 PKI，它将确保证书定期有效和更新，并在到期前的适当时间尝试更新证书。"><meta name="keywords" content="免费证书"><meta property="og:type" content="article"><meta property="og:title" content="k8s安装cert-manager及签发泛域名证书"><meta property="og:url" content="https://yixian12580.github.io/2024/067bd705c5.html"><meta property="og:site_name" content="逸贤 | Blog"><meta property="og:description" content="cert-manager 是一个云原生证书管理开源项目，用于在 Kubernetes 集群中自动管理和颁发来自各种颁发源的 TLS 证书，它可以从各种受支持的来源颁发证书，包括 Let’s Encrypt、HashiCorp Vault和Venafi以及私有 PKI，它将确保证书定期有效和更新，并在到期前的适当时间尝试更新证书。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://yixian12580.github.io/2024/067bd705c5/image-20250122154920890.png"><meta property="og:image" content="https://yixian12580.github.io/2024/067bd705c5/image-20250122155625590.png"><meta property="og:image" content="https://yixian12580.github.io/2024/067bd705c5/image-20250122160225810.png"><meta property="og:image" content="https://yixian12580.github.io/2024/067bd705c5/image-20250122160310979.png"><meta property="og:image" content="https://yixian12580.github.io/2024/067bd705c5/image-20250122160335156.png"><meta property="og:updated_time" content="2025-02-13T03:15:21.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="k8s安装cert-manager及签发泛域名证书"><meta name="twitter:description" content="cert-manager 是一个云原生证书管理开源项目，用于在 Kubernetes 集群中自动管理和颁发来自各种颁发源的 TLS 证书，它可以从各种受支持的来源颁发证书，包括 Let’s Encrypt、HashiCorp Vault和Venafi以及私有 PKI，它将确保证书定期有效和更新，并在到期前的适当时间尝试更新证书。"><meta name="twitter:image" content="https://yixian12580.github.io/2024/067bd705c5/image-20250122154920890.png"><link rel="alternate" href="/atom.xml" title="逸贤 | Blog" type="application/atom+xml"><link rel="canonical" href="https://yixian12580.github.io/2024/067bd705c5"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>k8s安装cert-manager及签发泛域名证书 | 逸贤 | Blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">逸贤 | Blog</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-bookmark"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-互动"><a href="/guestbook/" rel="section"><i class="menu-item-icon fa fa-fw fa-comments"></i><br>互动</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://yixian12580.github.io/2024/067bd705c5.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="丨逸贤丨"><meta itemprop="description" content="三十年众生牛马，搏十年丰功伟绩。"><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="逸贤 | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">k8s安装cert-manager及签发泛域名证书</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-06-20 15:44:33" itemprop="dateCreated datePublished" datetime="2024-06-20T15:44:33+08:00">2024-06-20</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-02-13 11:15:21" itemprop="dateModified" datetime="2025-02-13T11:15:21+08:00">2025-02-13</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/" itemprop="url" rel="index"><span itemprop="name">技术</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/域名证书/" itemprop="url" rel="index"><span itemprop="name">域名证书</span></a></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数： <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">29k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">26 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>cert-manager 是一个云原生证书管理开源项目，用于在 Kubernetes 集群中自动管理和颁发来自各种颁发源的 TLS 证书，它可以从各种受支持的来源颁发证书，包括 <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>、<a href="https://www.vaultproject.io/" target="_blank" rel="noopener">HashiCorp Vault</a>和<a href="https://www.venafi.com/" target="_blank" rel="noopener">Venafi</a>以及私有 PKI，它将确保证书定期有效和更新，并在到期前的适当时间尝试更新证书。</p><a id="more"></a><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><img src="/2024/067bd705c5/image-20250122154920890.png"><p>Issuers/ClusterIssuers：定义使用 什么证书颁发机构 (CA) 来去颁发证书，Issuers和ClusterIssuers区别是issuers是一个名称空间级别的资源， 只能用来签发自己所在 namespace 下的证书，ClusterIssuer是个集群级别的资源 可以签发任意 namespace 下的证书</p><p>Certificate：定义所需的 X.509 证书，该证书将更新并保持最新。Certificate是一个命名空间资源，当Certificate被创建时，它会去创建相应的CertificateRequest资源来去申请证书。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装cert-manager相对比较简单，这里安装的cert-manager版本为v1.4，注意该版本要求kubectl版本&gt;= v1.19.0-rc.1</p><p>所有资源（CustomResourceDefinitions和 cert-manager、cainjector 和 webhook 组件）都包含在一个 YAML 清单文件中：</p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="name">https</span>://github.com/jetstack/cert-manager/releases/download/v1<span class="number">.4</span><span class="number">.0</span>/cert-manager.yaml</span><br><span class="line">root@i-<span class="name">tsfhx8p6</span>:~/qke-k8s/cert-manager# vi cert-manager.yaml</span><br><span class="line">root@i-<span class="name">tsfhx8p6</span>:~/qke-k8s/cert-manager# kubectl apply -f cert-manager.yaml </span><br><span class="line">customresourcedefinition.apiextensions.k8s.<span class="built_in">io</span>/certificaterequests.cert-manager.<span class="built_in">io</span> created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.<span class="built_in">io</span>/certificates.cert-manager.<span class="built_in">io</span> created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.<span class="built_in">io</span>/challenges.acme.cert-manager.<span class="built_in">io</span> created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.<span class="built_in">io</span>/clusterissuers.cert-manager.<span class="built_in">io</span> created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.<span class="built_in">io</span>/issuers.cert-manager.<span class="built_in">io</span> created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.<span class="built_in">io</span>/orders.acme.cert-manager.<span class="built_in">io</span> created</span><br><span class="line">namespace/cert-manager unchanged</span><br><span class="line">serviceaccount/cert-manager-cainjector created</span><br><span class="line">serviceaccount/cert-manager created</span><br><span class="line">serviceaccount/cert-manager-webhook created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-cainjector created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-issuers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-clusterissuers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-certificates created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-orders created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-challenges created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-ingress-shim created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-view created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-edit created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-<span class="name">approve</span>:cert-manager-<span class="built_in">io</span> created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-certificatesigningrequests created</span><br><span class="line">clusterrole.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-<span class="name">webhook</span>:subjectaccessreviews created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-cainjector created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-issuers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-clusterissuers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-certificates created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-orders created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-challenges created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-ingress-shim created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-<span class="name">approve</span>:cert-manager-<span class="built_in">io</span> created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-controller-certificatesigningrequests created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-<span class="name">webhook</span>:subjectaccessreviews created</span><br><span class="line">role.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-<span class="name">cainjector</span>:leaderelection created</span><br><span class="line">role.rbac.authorization.k8s.<span class="built_in">io</span>/cert-<span class="name">manager</span>:leaderelection created</span><br><span class="line">role.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-<span class="name">webhook</span>:dynamic-serving created</span><br><span class="line">rolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-<span class="name">cainjector</span>:leaderelection created</span><br><span class="line">rolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-<span class="name">manager</span>:leaderelection created</span><br><span class="line">rolebinding.rbac.authorization.k8s.<span class="built_in">io</span>/cert-manager-<span class="name">webhook</span>:dynamic-serving created</span><br><span class="line">service/cert-manager created</span><br><span class="line">service/cert-manager-webhook created</span><br><span class="line">deployment.apps/cert-manager-cainjector created</span><br><span class="line">deployment.apps/cert-manager created</span><br><span class="line">deployment.apps/cert-manager-webhook created</span><br><span class="line">mutatingwebhookconfiguration.admissionregistration.k8s.<span class="built_in">io</span>/cert-manager-webhook created</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.<span class="built_in">io</span>/cert-manager-webhook created</span><br></pre></td></tr></table></figure><p>默认情况下，cert-manager 将安装到<code>cert-manager</code> 命名空间中，我们可以使用如下命令验证安装</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@i-tsfhx8p6:~/qke-k8s/cert-manager# kubectl get pod -n cert-manager </span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">cert-manager<span class="string">-7456795566</span><span class="string">-9</span>xcth              1/1     Running   0          47s</span><br><span class="line">cert-manager-cainjector<span class="string">-75</span>d558f967<span class="string">-5</span>tjvc   1/1     Running   0          47s</span><br><span class="line">cert-manager-webhook<span class="string">-7</span>bb859bd44<span class="string">-7</span>zsx5      1/1     Running   0          47s</span><br></pre></td></tr></table></figure><h2 id="配置Issuer-ClusterIssuer"><a href="#配置Issuer-ClusterIssuer" class="headerlink" title="配置Issuer/ClusterIssuer"></a>配置Issuer/ClusterIssuer</h2><p>cert-manager支持以下几种证书颁发者</p><ul><li>SelfSigned</li><li>CA</li><li>Vault</li><li>Venafi</li><li>External</li><li>ACME</li></ul><p>这里只介绍使用ACME作为证书颁发者的方式。</p><h3 id="HTTP-01-校验原理"><a href="#HTTP-01-校验原理" class="headerlink" title="HTTP-01 校验原理"></a>HTTP-01 校验原理</h3><p>HTTP-01 的校验原理是给你域名指向的 HTTP 服务增加一个临时 location ，Let’s Encrypt 会发送 http 请求到 http:///.well-known/acme-challenge/，YOUR_DOMAIN 就是被校验的域名，TOKEN 是 ACME 协议的客户端负责放置的文件，在这里 ACME 客户端就是 cert-manager，它通过修改或创建 Ingress 规则来增加这个临时校验路径并指向提供 TOKEN 的服务。Let’s Encrypt 会对比 TOKEN 是否符合预期，校验成功后就会颁发证书。此方法仅适用于给使用 Ingress 暴露流量的服务颁发证书，并且不支持泛域名证书。</p><h3 id="DNS-01-校验原理"><a href="#DNS-01-校验原理" class="headerlink" title="DNS-01 校验原理"></a>DNS-01 校验原理</h3><p>DNS-01 的校验原理是利用 DNS 提供商的 API Key 拿到你的 DNS 控制权限， 在 Let’s Encrypt 为 ACME 客户端提供令牌后，ACME 客户端 (cert-manager) 将创建从该令牌和您的帐户密钥派生的 TXT 记录，并将该记录放在 _acme-challenge.。 然后 Let’s Encrypt 将向 DNS 系统查询该记录，如果找到匹配项，就可以颁发证书。此方法不需要你的服务使用 Ingress，并且支持泛域名证书。</p><h3 id="校验方式对比"><a href="#校验方式对比" class="headerlink" title="校验方式对比"></a>校验方式对比</h3><p>HTTP-01 的校验方式的优点是: 配置简单通用，不管使用哪个 DNS 提供商都可以使用相同的配置方法；缺点是：需要依赖 Ingress，如果你的服务不是用 Ingress 暴露流量的就不适用，而且不支持泛域名证书。</p><p>DNS-01 的校验方式的优点是没有 HTTP-01 校验方式缺点，不依赖 Ingress，也支持泛域名；缺点就是不同 DNS 提供商的配置方式不一样，而且 DNS 提供商有很多，cert-manager 的 Issuer 不可能每个都去支持，支持如下的dns提供商：</p><ul><li><p>Akamai</p></li><li><p>AzureDNS</p></li><li><p>CloudFlare</p></li><li><p>Google</p></li><li><p>Route53</p></li><li><p>DigitalOcean</p></li><li><p>RFC2136</p><p>Cert-manager 还支持使用外部 webhook 的接入 DNS 提供商，支持如下webhook</p></li><li><p><a href="https://github.com/pragkent/alidns-webhook" target="_blank" rel="noopener"><code>AliDNS-Webhook</code></a></p></li><li><p><a href="https://github.com/okteto/cert-manager-webhook-civo" target="_blank" rel="noopener"><code>cert-manager-webhook-civo</code></a></p></li><li><p><a href="https://github.com/qqshfox/cert-manager-webhook-dnspod" target="_blank" rel="noopener"><code>cert-manager-webhook-dnspod</code></a></p></li><li><p><a href="https://github.com/neoskop/cert-manager-webhook-dnsimple" target="_blank" rel="noopener"><code>cert-manager-webhook-dnsimple</code></a></p></li><li><p><a href="https://github.com/bwolf/cert-manager-webhook-gandi" target="_blank" rel="noopener"><code>cert-manager-webhook-gandi</code></a></p></li><li><p><a href="https://github.com/Infomaniak/cert-manager-webhook-infomaniak" target="_blank" rel="noopener"><code>cert-manager-webhook-infomaniak</code></a></p></li><li><p><a href="https://gitlab.com/smueller18/cert-manager-webhook-inwx" target="_blank" rel="noopener"><code>cert-manager-webhook-inwx</code></a></p></li><li><p><a href="https://gitlab.com/dn13/cert-manager-webhook-oci" target="_blank" rel="noopener"><code>cert-manager-webhook-oci</code></a> （Oracle 云基础设施）</p></li><li><p><a href="https://github.com/scaleway/cert-manager-webhook-scaleway" target="_blank" rel="noopener"><code>cert-manager-webhook-scaleway</code></a></p></li><li><p><a href="https://github.com/selectel/cert-manager-webhook-selectel" target="_blank" rel="noopener"><code>cert-manager-webhook-selectel</code></a></p></li><li><p><a href="https://github.com/cgroschupp/cert-manager-webhook-softlayer" target="_blank" rel="noopener"><code>cert-manager-webhook-softlayer</code></a></p></li><li><p><a href="https://github.com/jb-dk/cert-manager-webhook-ibmcis" target="_blank" rel="noopener"><code>cert-manager-webhook-ibmcis</code></a></p></li><li><p><a href="https://github.com/Identitry/cert-manager-webhook-loopia" target="_blank" rel="noopener"><code>cert-manager-webhook-loopia</code></a></p></li><li><p><a href="https://github.com/kiandigital/cert-manager-webhook-arvan" target="_blank" rel="noopener"><code>cert-manager-webhook-arvan</code></a></p></li><li><p><a href="https://github.com/bizflycloud/bizflycloud-certmanager-dns-webhook" target="_blank" rel="noopener"><code>bizflycloud-certmanager-dns-webhook</code></a></p></li></ul><h3 id="HTTP01配置示例"><a href="#HTTP01配置示例" class="headerlink" title="HTTP01配置示例"></a>HTTP01配置示例</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tls</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  acme:</span></span><br><span class="line">    <span class="comment"># You must replace this email address with your own.</span></span><br><span class="line">    <span class="comment"># Let's Encrypt will use this to contact you about expiring</span></span><br><span class="line">    <span class="comment"># certificates, and issues related to your account.</span></span><br><span class="line"><span class="attr">    email:</span> <span class="string">xxxxxxx@qq.com</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr">https://acme-v02.api.letsencrypt.org/directory</span></span><br><span class="line"><span class="attr">    privateKeySecretRef:</span></span><br><span class="line">      <span class="comment"># Secret resource that will be used to store the account's private key.</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">issuer-account-key</span></span><br><span class="line">    <span class="comment"># Add a single challenge solver, HTTP01 using nginx</span></span><br><span class="line"><span class="attr">    solvers:</span></span><br><span class="line"><span class="attr">    - http01:</span></span><br><span class="line"><span class="attr">        ingress:</span></span><br><span class="line"><span class="attr">          class:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p>说明：</p><ul><li>metadata.name: 是我们创建的签发机构的名称，后面我们创建证书的时候会引用它</li><li>spec.acme.email: 是你自己的邮箱，证书快过期的时候会有邮件提醒，不过 cert-manager 会利用 acme 协议自动给我们重新颁发证书来续期</li><li>spec.acme.server: 是 acme 协议的服务端，我们这里用 Let’s Encrypt，这个地址就写死成这样就行</li><li>spec.acme.privateKeySecretRef: 指示此签发机构的私钥将要存储到哪个 Secret 对象中，名称不重要</li><li>spec.acme.solvers: 这里指示签发机构校验方式，有http01和dns01两种，该字段下配置的class和name只能同时存在一个，class指定使用的ingress class 名称，name比较少用，通常用于云上自带的ingress</li></ul><p>我们部署上述示例，并部署一个ingress 代理集群内的grafana服务验证签发证书</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@i-tsfhx8p6:~/qke-k8s/cert-manager#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">clusterissuer.yaml</span> </span><br><span class="line"><span class="string">clusterissuer.cert-manager.io/tls</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="string">root@i-tsfhx8p6:~/qke-k8s/cert-manager#</span> <span class="string">cat</span> <span class="string">ingress/ingree-nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">cert-manager.io/cluster-issuer:</span> <span class="string">tls</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">ingress-nginx.lishuai.fun</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          service:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">            port:</span></span><br><span class="line"><span class="attr">              number:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        pathType:</span> <span class="string">Prefix</span></span><br><span class="line"><span class="attr">  tls:</span> <span class="comment"># &lt; placing a host in the TLS config will indicate a certificate should be created</span></span><br><span class="line"><span class="attr">  - hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ingress-nginx.lishuai.fun</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">ingress-nginx--tls</span></span><br><span class="line">    </span><br><span class="line"><span class="string">root@i-tsfhx8p6:~/qke-k8s/cert-manager#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">ingress/ingree-nginx.yaml</span> </span><br><span class="line"><span class="string">ingress.networking.k8s.io/test</span> <span class="string">created</span></span><br></pre></td></tr></table></figure><p>我们可以查看生成的certificate和签发的证书(安全原因删除了部分证书中的字符)</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">root@i-tsfhx8p6:~<span class="meta-keyword">/qke-k8s/</span>cert-manager<span class="meta"># kubectl -n monitoring  get certificate</span></span><br><span class="line">NAME                 READY   SECRET               AGE</span><br><span class="line">ingress-nginx--tls   True    ingress-nginx--tls   <span class="number">2</span>m26s</span><br><span class="line"></span><br><span class="line">root@i-tsfhx8p6:~<span class="meta-keyword">/qke-k8s/</span>cert-manager<span class="meta"># kubectl -n monitoring  get secret ingress-nginx--tls -o yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line">  tls.crt: LS0tLS1CRUdJT********kMrT0IrYTl2VXZhRUFkZ0QyWEpRdjBYY3dJaFJVR0FndwpsRmFPNDAwVEdUTy8zd3d2SUF2TVR2Rms0d0FBQVhyN3Fzcy9BQUFFQXdCSE1FVUNJQ2svS2VodE1YOUlLZEFyCjhZTVMyZU9ZR05mbXlBSnZQR0tYS3Bxc3NyNkJBaUVBZ1FZM1ZmWFUvZEd0TDQ3VytsOCt3WTRxd0VONkowN3MKUFVTNUhPZm1HNmN3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUxqT1JBQUJPbVMzdUwrTktNWCtPTVBZWXltYwpjSnFkdDRhUFUxUUhvMk5mY2NnbG9PeVl0ci9MclQvSytQOGUxQkN1Q0Jqd2d2MVpBbzhUUWxiVU1POE9BbGhYClB6dWk4YnV3VnF2N0Jvb3BvRVUyNVZuU0FOb3B3ZVVWM1RrNW1DSEs5YW9ORVpBZUF4NEE4T3o0MWdNeVN0SnEKOFpqZnBxZCtJUmNUdzNGL0E4MVhRTmJzYnVTaG5DWUZMZkxQUkpMZDNGeGszOGRpSEsrZ0UxT0JZV1REZSsvdQpJWTFGT1R1TkhFSmoybzBJbEFZTE5ueTM4ZHcxQkEyQ3VDZVFHNE1TWHYxdnhFVFhwWjUrNzNBclFFUDlydXZpClNBSTh2VEtYM2gycGFDS0lhdEZIMEZDTE9uQUZDMU9ia0ZCanRLTUJTWDRMZE5UZDQ3S0pIcHg3bUJVPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlGRmpDQ0F2NmdBd0lCQWdJUkFKRXJDRXJQREJpblUvYldMaVduWDFvd0RRWUpLb1pJaHZjTkFRRUxCUUF3ClR6RUxNQWtHQTFVRUJoTUNWVk14S1RBbkJnTlZCQW9USUVsdWRHVnlibVYwSUZObFkzVnlhWFI1SUZKbGMyVmgKY21Ob0lFZHliM1Z3TVJVd0V3WURWUVFERXd4SlUxSkhJRkp2YjNRZ1dERXdIaGNOTWpBd09UQTBNREF3TURBdwpXaGNOTWpVd09URTFNVFl3TURBd1dqQXlNUXN3Q1FZRFZRUUdFd0pWVXpFV01CUUdBMVVFQ2hNTlRHVjBKM01nClJXNWpjbmx3ZERFTE1Ba0dBMVVFQXhNQ1VqTXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUsKQW9JQkFRQzdBaFVvelBhZ2xOTVBFdXlOVlpMRCtJTHhtYVo2UW9pblhTYXF0U3U1eFV5eHI0NXIrWFhJbzljUApSNVFVVlRWWGpKNm9vamtaOVlJOFFxbE9idlU3d3k3YmpjQ3dYUE5aT09mdHoybndXZ3NidnNDVUpDV0gramR4CnN4UG5IS3pobSsvYjVEdEZVa1dXcWNGVHpqVElVdTYxcnUyUDNtQnc0cVZVcTdadERwZWxRRFJySzlPOFp1dG0KTkh6NmE0dVBWeW1aK0RBWFhicHliL3VCeGEzU2hsZzlGOGZuQ2J2eEsvZUczTUhhY1YzVVJ1UE1yU1hCaUx4ZwpaM1Ztcy9FWTk2SmM1bFAvT29pMlI2WC9FeGpxbUFsM1A1MVQrYzhCNWZXbWNCY1VyMk9rLzVtems1M2NVNmNHCi9raUZIYUZwcmlWMXV4UE1VZ1AxN1ZHaGk5c1ZBZ01CQUFHamdnRUlNSUlCQkRBT0JnTlZIUThCQWY4RUJBTUMKQVlZd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3SUdDQ3NHQVFVRkJ3TUJNQklHQTFVZEV3RUIvd1FJTUFZQgpBZjhDQVFBd0hRWURWUjBPQkJZRUZCUXVzeGUzV0ZiTHJsQUpRT1lmcjUyTEZNTEdNQjhHQTFVZEl3UVlNQmFBCkZIbTBXZVo3dHVYa0FYT0FDSWpJR2xqMjZadHVNRElHQ0NzR0FRVUZCd0VCQkNZd0pEQWlCZ2dyQmdFRkJRY3cKQW9ZV2FIUjBjRG92TDNneExta3ViR1Z1WTNJdWIzSm5MekFuQmdOVkhSOEVJREFlTUJ5Z0dxQVloaFpvZEhSdwpPaTh2ZURFdVl5NXNaVzVqY2k1dmNtY3ZNQ0lHQTFVZElBUWJNQmt3Q0FZR1o0RU1BUUlCTUEwR0N5c0dBUVFCCmd0OFRBUUVCTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElDQVFDRnlrNUhQcVAzaFVTRnZOVm5lTEtZWTYxMVRSNlcKUFRObGNsUXRnYURxdyszNElMOWZ6TGR3QUxkdU8vWmVsTjdrSUorbTc0dXlBK2VpdFJZOGtjNjA3VGtDNTN3bAppa2ZtWlc0L1J2VFo4TTZVSys1VXpoSzhqQ2RMdU1HWUw2S3Z6WEdSU2dpM3lMZ2pld1F0Q1BrSVZ6NkQyUVF6CkNrY2hlQW1DSjhNcXlKdTV6bHp5Wk1qQXZubkFUNDV0UkF4ZWtyc3U5NHNRNGVnZFJDbmJXU0R0WTdraCtCSW0KbEpOWG9CMWxCTUVLSXE0UURVT1hvUmdmZnVEZ2hqZTFXckc5TUwrSGJpc3EveUZPR3dYRDlSaVg4RjZzdzZXNAphdkF1dkRzenVlNUwzc3o4NUsrRUM0WS93RlZETnZabzRUWVhhbzZaMGYrbFFLYzB0OERRWXprMU9YVnU4cnAyCnlKTUM2YWxMYkJmT0RBTFp2WUg3bjdkbzFBWmxzNEk5ZDFQNGpua0RyUW94QjNVcVE5aFZsM0xFS1E3M3hGMU8KeUs1R2hERFg4b1ZmR0tGNXUrZGVjSXNINFlhVHc3bVAzR0Z4SlNxdjMrMGxVRkpvaTVMYzVkYTE0OXA5MElkcwpoQ0V4cm9MMSs3bXJ5SWtYUGVGTTVUZ085cjBydlphQkZPdlYyejBncDM1WjArTDRXUGxidUVqTi9seFBGaW4rCkhsVWpyOGdSc0kzcWZKT1FGeS85cktJSlIwWS84T213dC84b1RXZ3kxbWRlSG1tams3ajFuWXN2QzlKU1E2WnYKTWxkbFRUS0IzemhUaFYxK1hXWXA2cmpkNUpXMXpiVldFa0xOeEU3R0pUaEVVRzNzemdCVkdQN3BTV1RVVHNxWApuTFJid0hPb3E3aEh3Zz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZZRENDQkVpZ0F3SUJBZ0lRUUFGM0lUZlU2VUs0N25hcVBHUUt0ekFOQmdrcWhraUc5dzBCQVFzRkFEQS8KTVNRd0lnWURWUVFLRXh0RWFXZHBkR0ZzSUZOcFoyNWhkSFZ5WlNCVWNuVnpkQ0JEYnk0eEZ6QVZCZ05WQkFNVApEa1JUVkNCU2IyOTBJRU5CSUZnek1CNFhEVEl4TURFeU1ERTVNVFF3TTFvWERUSTBNRGt6TURFNE1UUXdNMW93ClR6RUxNQWtHQTFVRUJoTUNWVk14S1RBbkJnTlZCQW9USUVsdWRHVnlibVYwSUZObFkzVnlhWFI1SUZKbGMyVmgKY21Ob0lFZHliM1Z3TVJVd0V3WURWUVFERXd4SlUxSkhJRkp2YjNRZ1dERXdnZ0lpTUEwR0NTcUdTSWIzRFFFQgpBUVVBQTRJQ0R3QXdnZ0lLQW9JQ0FRQ3Q2Q1J6OUJRMzg1dWVLMWNvSEllKzNMZmZPSkNNYmp6bVY2QjQ5M1hDCm92NzFhbTcyQUU4bzI5NW9obXhFazdheFkvMFVFbXUvSDlMcU1ac2hmdEV6UExwSTlkMTUzN080L3hMeElacEwKd1lxR2NXbEtabVpzajM0OGNMK3RLU0lHOCtUQTVvQ3U0a3VQdDVsK2xBT2YwMGVYZkpsSUkxUG9PSzVQQ20rRApMdEZKVjR5QWRMYmFMOUE0alhzRGNDRWJkZkl3UFBxUHJ0M2FZNnZyRmsvQ2poRkxmczhMNlArMWR5NzBzbnRLCjRFd1NKUXh3alFNcG9PRlRKT3dUMmU0WnZ4Q3pTb3cvaWFOaFVkNnNod2VVOUdOeDdDN2liMXVZZ2VHSlhEUjUKYkhidk81QmllZWJicEpvdkpzWFFFT0VPM3RrUWpoYjd0L2VvOThmbEFnZVlqellJbGVmaU41WU5ObldlK3c1eQpzUjJidkFQNVNRWFlnZDBGdENyV1FlbXNBWGFWQ2cvWTM5VzlFaDgxTHlnWGJOS1l3YWdKWkhkdVJ6ZTZ6cXhaClhtaWRmM0xXaWNVR1FTaytXVDdkSnZVa3lSR25XcU5NUUI5R29abTFwenBSYm9ZN25uMXlweElGZUZudFBsRjQKRlFzRGo0M1FMd1d5UG50S0hFdHpCUkw4eHVyZ1VCTjhRNU4wczhwMDU0NGZBUWpRTU5SYmNUYTBCN3JCTURCYwpTTGVDTzVpbWZXQ0tvcU1wZ3N5NnZZTUVHNktEQTBHaDFnWHhHOEsyOEtoOGhqdEdxRWdxaU54Mm1uYS9IMnFsClBSbVA2emp6Wk43SUt3MEtLUC8zMitJVlF0UWkwQ2RkNFhuK0dPZHdpSzFPNXRtTE9zYmRKMUZ1Lzd4azlUTkQKVHdJREFRQUJvNElCUmpDQ0FVSXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU9CZ05WSFE4QkFmOEVCQU1DQVFZdwpTd1lJS3dZQkJRVUhBUUVFUHpBOU1Ec0dDQ3NHQVFVRkJ6QUNoaTlvZEhSd09pOHZZWEJ3Y3k1cFpHVnVkSEoxCmMzUXVZMjl0TDNKdmIzUnpMMlJ6ZEhKdmIzUmpZWGd6TG5BM1l6QWZCZ05WSFNNRUdEQVdnQlRFcDdHa2V5eHgKK3R2aFM1QjEvOFFWWUlXSkVEQlVCZ05WSFNBRVRUQkxNQWdHQm1lQkRBRUNBVEEvQmdzckJnRUVBWUxmRXdFQgpBVEF3TUM0R0NDc0dBUVVGQndJQkZpSm9kSFJ3T2k4dlkzQnpMbkp2YjNRdGVERXViR1YwYzJWdVkzSjVjSFF1CmIzSm5NRHdHQTFVZEh3UTFNRE13TWFBdm9DMkdLMmgwZEhBNkx5OWpjbXd1YVdSbGJuUnlkWE4wTG1OdmJTOUUKVTFSU1QwOVVRMEZZTTBOU1RDNWpjbXd3SFFZRFZSME9CQllFRkhtMFdlWjd0dVhrQVhPQUNJaklHbGoyNlp0dQpNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUFLY3dCc2xtNy9EbExRcnQyTTUxb0dyUytvNDQrL3lRb0RGVkRDCjVXeEN1MitiOUxSUHdrU0lDSFhNNndlYkZHSnVlTjdzSjdvNVhQV2lvVzVXbEhBUVU3Rzc1Sy9Rb3NNckFkU1cKOU1VZ05UUDUyR0UyNEhHTnRMaTFxb0pGbGNEeXFTTW81OWFoeTJjSTJxQkRMS29ia3gvSjN2V3JhVjBUOVZ1RwpXQ0xLVFZYa2NHZHR3bGZGUmpsQno0cFlnMWh0bWY1WDZEWU84QTRqcXYySWw5RGpYQTZVU2JXMUZ6WFNMcjlPCmhlOFk0SVdTNndZN2JDa2pDV0RjUlFKTUVoZzc2ZnNPM3R4RStGaVlydXE5UlVXaGlGMW15djRRNlcrQ3lCRkMKRGZ2cDdPT0dBTjZkRU9NNCtxUjlzZGpvU1lLRUJwc3I2R3RQQVF3NGR5NzUzZWM1Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br><span class="line">  tls.key: LS0tLS1CRUdJTiBSx********************************************VFY2J3SStsNGFCM2NWMjNDMlIyM0wvbFNNY3MzSUIKZHZLQVQ5RUNnWUVBeHVhNlNWV0pyamJ5bmZwRVRQajNWa3ZTRm5rM0lxS1BZS2hUSW9VaGNmOGVSUkkvZzhkWApsVzVJZTNHbjhWaWlTTzB3TFJuZ3lHUVFSZDFDVGk5NEZNMmNabHA5czl3RHhWZFhlRm5FbmhhQVh5ZEVhQThmCkVteG04ek9TNWV0cnBiY2hueEI3eCtOaWo3MktZcFo4cnhobG1XcFRaRVJETzRveExWLzZYa1VDZ1lFQTRWTnMKUlkzME5LWmk2S0IxYWI1RFFYSTJTekJSeVdjbmd6ZjZRT3JEaVpldWsraS9CMGUrM2ZUNkRoSGl3bVNBcWtVUAo3b1Z0L1JNbkNDR1kwb1B1d0NkaSt5b1A0ejNOVTJpNWJDRk45eU12WUNkVWxVRG9KRVQ3YUdBV3QybTJtZDRiClgzaXpId1JaZVkyNk1FRFdUdUltSVFBdlRVdkRRS0RxeTNlSzRBc0NnWUVBZzRzdW9yZDJrZ2gzRnJIZ29BTjgKR00rV1J4U3R1VE5IbmNaVkRSeDlEUmFMbjJTOUt0c1llcFJ3VFd2U2hWUjRKOER1UHJYQnF1WTZ1T25uSXl4VAp2M1pvUEcwV2UzQkQ4aXljaGRUZ3F5ajRoM1hCMFF4SElYa2Q4VFFuci9XdHdQQkh4Um95c3ZVWVJ6WTBvcFVpCkt1NzRxcWplTkE3TlpFQTEyK3VBK3YwQ2dZRUFrVzRobEtieGRrWHAwdEUxMXdFcE1ZV0F5M2l0WVB1R1FpZ1EKQ25RN3JvUEs5c1lpL1pUdCtSNFRncDlDcDByc3pIajB0bk5DTVRSNlhjSXBlNzRSaTg0Z0VaSHRYVExYWWoxVwphQmI2MWtiTVhoZ2tmSXkvQ0NISnptMHVYRVVMeVRYVW53TXRRUml5azBUSlpqbUMyTGtYK1BiQWtQZ1VWcE5GCjEvc1pGRThDZ1lCekhVZE9LWVBjMUtlKzlwcGVvVlR1UjZ4bTlrTGJ0WHpPcXpuRVhQZUNMVmQyOWFBaTRGYUsKMXVocXdwcFVpL2x6N2VIb2pySDFmSXNaMDliTTd0aVBDY0FJK2NRemlGVWJvc2ZCdmxVakFzRVRNREFYbU5GLwpQYUhHWVR3MHVkVVlWL3YzdysxcXNsZG03a1kyN000anI4RGFITENKdlZERlpYMzRCMW9mVVE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br><span class="line"><span class="symbol">kind:</span> Secret</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  annotations:</span></span><br><span class="line">    cert-manager.io/alt-names: ingress-nginx.lishuai.fun</span><br><span class="line">    cert-manager.io/certificate-name: ingress-nginx--tls</span><br><span class="line">    cert-manager.io/common-name: ingress-nginx.lishuai.fun</span><br><span class="line">    cert-manager.io/ip-sans: <span class="string">""</span></span><br><span class="line">    cert-manager.io/issuer-group: cert-manager.io</span><br><span class="line">    cert-manager.io/issuer-kind: ClusterIssuer</span><br><span class="line">    cert-manager.io/issuer-name: tls</span><br><span class="line">    cert-manager.io/uri-sans: <span class="string">""</span></span><br><span class="line"><span class="symbol">  creationTimestamp:</span> <span class="string">"2021-07-31T08:25:14Z"</span></span><br><span class="line"><span class="symbol">  managedFields:</span></span><br><span class="line">  - apiVersion: v1</span><br><span class="line"><span class="symbol">    fieldsType:</span> FieldsV1</span><br><span class="line"><span class="symbol">    fieldsV1:</span></span><br><span class="line"><span class="symbol">      f:</span>data:</span><br><span class="line">        .: &#123;&#125;</span><br><span class="line"><span class="symbol">        f:</span>tls.crt: &#123;&#125;</span><br><span class="line"><span class="symbol">        f:</span>tls.key: &#123;&#125;</span><br><span class="line"><span class="symbol">      f:</span>metadata:</span><br><span class="line"><span class="symbol">        f:</span>annotations:</span><br><span class="line">          .: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/alt-names: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/certificate-name: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/common-name: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/ip-sans: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/issuer-group: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/issuer-kind: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/issuer-name: &#123;&#125;</span><br><span class="line"><span class="symbol">          f:</span>cert-manager.io/uri-sans: &#123;&#125;</span><br><span class="line"><span class="symbol">      f:</span>type: &#123;&#125;</span><br><span class="line"><span class="symbol">    manager:</span> controller</span><br><span class="line"><span class="symbol">    operation:</span> Update</span><br><span class="line"><span class="symbol">    time:</span> <span class="string">"2021-07-31T08:25:14Z"</span></span><br><span class="line"><span class="symbol">  name:</span> ingress-nginx--tls</span><br><span class="line"><span class="symbol">  namespace:</span> monitoring</span><br><span class="line"><span class="symbol">  resourceVersion:</span> <span class="string">"274536"</span></span><br><span class="line"><span class="symbol">  selfLink:</span> <span class="meta-keyword">/api/</span>v1<span class="meta-keyword">/namespaces/</span>monitoring<span class="meta-keyword">/secrets/</span>ingress-nginx--tls</span><br><span class="line"><span class="symbol">  uid:</span> <span class="number">929f</span>9252<span class="number">-1905</span><span class="number">-4</span>afc-b622<span class="number">-892151</span>f1bbf3</span><br><span class="line"><span class="symbol">type:</span> kubernetes.io/tls</span><br></pre></td></tr></table></figure><p>此时我们访问我们ingress文件里定义的域名可以看到此时证书已经签发</p><img src="/2024/067bd705c5/image-20250122155625590.png"><h3 id="DNS01配置示例"><a href="#DNS01配置示例" class="headerlink" title="DNS01配置示例"></a>DNS01配置示例</h3><p>这里使用的dns服务商为阿里云，需要使用<a href="https://github.com/pragkent/alidns-webhook" target="_blank" rel="noopener"><code>AliDNS-Webhook</code></a></p><h4 id="安装alidns-webhook"><a href="#安装alidns-webhook" class="headerlink" title="安装alidns-webhook"></a>安装alidns-webhook</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/pragkent/</span>alidns-webhook<span class="regexp">/master/</span>deploy<span class="regexp">/bundle.yaml</span></span><br></pre></td></tr></table></figure><p>建议修改文件中的acme.yourcompany.com</p><figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i s/<span class="symbol">'acme</span>.yourcompany.com'/<span class="symbol">'acme</span>.lishuai.fun'/g bundle.yaml</span><br></pre></td></tr></table></figure><p>安装alidns-webhook</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">apply</span> -f bundle.yaml</span><br></pre></td></tr></table></figure><p>创建一个包含阿里dns凭据的secert</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion : <span class="type">v1</span> </span><br><span class="line">kind : <span class="type">Secret</span> </span><br><span class="line">metadata :</span><br><span class="line">  name : <span class="type">alidns</span>-secret </span><br><span class="line">  namespace : <span class="type">cert</span>-manager </span><br><span class="line">data :</span><br><span class="line">  <span class="keyword">access</span>-key : <span class="type">YOUR_ACCESS_KEY</span>(base64) </span><br><span class="line">  secret-key : <span class="type">YOUR_SECRET_KEY</span>(base64)</span><br></pre></td></tr></table></figure><p>或者使用如下命令行方式创建</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n cert-manager create<span class="built_in"> secret </span>generic alidns-secret <span class="attribute">--from-literal</span>=access-key='YOUR_ACCESS_KEY' <span class="attribute">--from-literal</span>=secret-key='YOUR_SECRET_KEY'</span><br></pre></td></tr></table></figure><p>编写ClusterIssuer yaml文件</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: cert-manager.io/v1</span><br><span class="line"><span class="attribute">kind</span>: ClusterIssuer</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: letsencrypt-staging</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">acme</span>:</span><br><span class="line">    # Change to your letsencrypt email</span><br><span class="line">    <span class="attribute">email</span>: <span class="number">912988434</span><span class="variable">@qq</span>.com</span><br><span class="line">    <span class="attribute">server</span>: <span class="attribute">https</span>:<span class="comment">//acme-v02.api.letsencrypt.org/directory</span></span><br><span class="line">    <span class="attribute">privateKeySecretRef</span>:</span><br><span class="line">      <span class="attribute">name</span>: letsencrypt-staging-account-key</span><br><span class="line">    <span class="attribute">solvers</span>:</span><br><span class="line">    - <span class="attribute">dns01</span>:</span><br><span class="line">        <span class="attribute">webhook</span>:</span><br><span class="line">          <span class="attribute">groupName</span>: acme.lishuai.fun #须和bundle.yaml文件中定义的groupname 一致</span><br><span class="line">          <span class="attribute">solverName</span>: alidns</span><br><span class="line">          <span class="attribute">config</span>:</span><br><span class="line">            <span class="attribute">region</span>: <span class="string">""</span></span><br><span class="line">            <span class="attribute">accessKeySecretRef</span>:</span><br><span class="line">              <span class="attribute">name</span>: alidns-secret</span><br><span class="line">              <span class="attribute">key</span>: access-key</span><br><span class="line">            <span class="attribute">secretKeySecretRef</span>:</span><br><span class="line">              <span class="attribute">name</span>: alidns-secret</span><br><span class="line">              <span class="attribute">key</span>: secret-key</span><br></pre></td></tr></table></figure><p>创建ClusterIssuer</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">apply</span> -f ClusterIssuer.yaml</span><br></pre></td></tr></table></figure><p>我们创建一个 手动去申请证书</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@i-<span class="symbol">tsfhx8p6:</span>~<span class="regexp">/qke-k8s/cert</span>-manager/alidns-webhook<span class="comment"># cat certificate.yaml </span></span><br><span class="line"><span class="symbol">apiVersion:</span> cert-manager.io/v1</span><br><span class="line"><span class="symbol">kind:</span> Certificate</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line">  <span class="symbol">name:</span> lishuai-<span class="function"><span class="keyword">fun</span><span class="title">-</span></span>tls</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line">  <span class="symbol">secretName:</span> lishuai-<span class="function"><span class="keyword">fun</span><span class="title">-</span></span>tls</span><br><span class="line">  <span class="symbol">dnsNames:</span></span><br><span class="line">  - lishuai.<span class="keyword">fun</span></span><br><span class="line">  - <span class="string">"*.lishuai.fun"</span></span><br><span class="line">  <span class="symbol">issuerRef:</span></span><br><span class="line">    <span class="symbol">name:</span> letsencrypt-staging</span><br><span class="line">    <span class="symbol">kind:</span> ClusterIssuer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@i-<span class="symbol">tsfhx8p6:</span>~<span class="regexp">/qke-k8s/cert</span>-manager/alidns-webhook<span class="comment"># kubectl apply -f  certificate.yaml </span></span><br><span class="line">certificate.cert-manager.io/lishuai-<span class="function"><span class="keyword">fun</span><span class="title">-</span></span>tls created</span><br><span class="line">root@i-<span class="symbol">tsfhx8p6:</span>~<span class="regexp">/qke-k8s/cert</span>-manager/alidns-webhook<span class="comment"># kubectl get secrets </span></span><br><span class="line">NAME                    TYPE                                  DATA   AGE</span><br><span class="line">default-token-v24ww     kubernetes.io/service-account-token   <span class="number">3</span>      <span class="number">25</span>h</span><br><span class="line">lishuai-<span class="function"><span class="keyword">fun</span><span class="title">-</span></span>tls-<span class="number">4</span>wcmc   Opaque                                <span class="number">1</span>      <span class="number">1</span>s</span><br><span class="line">qingcloud               kubernetes.io/dockerconfigjson        <span class="number">1</span>      <span class="number">25</span>h</span><br><span class="line">root@i-<span class="symbol">tsfhx8p6:</span>~<span class="regexp">/qke-k8s/cert</span>-manager/alidns-webhook<span class="comment"># kubectl get certificate</span></span><br><span class="line">NAME              READY   SECRET            AGE</span><br><span class="line">lishuai-<span class="function"><span class="keyword">fun</span><span class="title">-</span></span>tls   False   lishuai-<span class="function"><span class="keyword">fun</span><span class="title">-</span></span>tls   <span class="number">10</span>s</span><br></pre></td></tr></table></figure><p>刚创建后我们查看certificate会发现ready状态为false,此时稍等会自动在我们的dns解析里创建txt 记录，然后去签发证书，该字段就会变为true</p><img src="/2024/067bd705c5/image-20250122160225810.png"><p>此时查看发现secert和certificate都发生变化</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@i-tsfhx8p6:~/qke-k8s/cert-manager/alidns-webhook# kubectl <span class="builtin-name">get</span> certificate</span><br><span class="line">NAME              READY  <span class="built_in"> SECRET </span>           AGE</span><br><span class="line">lishuai-fun-tls   <span class="literal">True</span>    lishuai-fun-tls   5m27s</span><br><span class="line">root@i-tsfhx8p6:~/qke-k8s/cert-manager/alidns-webhook# kubectl <span class="builtin-name">get</span> secrets </span><br><span class="line">NAME                 <span class="built_in"> TYPE </span>                                 DATA   AGE</span><br><span class="line">default-token-v24ww   kubernetes.io/service-account-token   3      25h</span><br><span class="line">lishuai-fun-tls       kubernetes.io/tls                     2      2m14s  #此时DATA 变为2，说明里面存着真正的证书文件</span><br><span class="line">qingcloud             kubernetes.io/dockerconfigjson        1      25h</span><br></pre></td></tr></table></figure><p>查看证书详情</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">root@i-tsfhx8p6:~/qke-k8s/cert-manager/ingress# kubectl get secrets lishuai-fun-tls -o json |jq --raw-output '.data["tls.crt"]'|base64 -d  #从secert中解析证书</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIFKzCCBBOgAwIBAgISBO2cqIdYIq3fZjib8wahs0QfMA0GCSqGSIb3DQEBCwUA</span><br><span class="line">MDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQD</span><br><span class="line">EwJSMzAeFw0yMTA3MzExNjM0MzBaFw0yMTEwMjkxNjM0MjhaMBYxFDASBgNVBAMT</span><br><span class="line">C2xpc2h1YWkuZnVuMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2KTU</span><br><span class="line">fVYd7JIVfqcouQWNU1ly6hYrSxYLk9swEK5G2klaEX/<span class="number">5</span>RaqybqVHvttZiAahvuZs</span><br><span class="line">whTyzHcCIzDCzrKucs1ZFE9RT9OKAvmY1e6IxeEUbz2Hi2ZBpP81sLO9G<span class="number">9t3x0U9</span></span><br><span class="line">RY75hf/iTgOGI2ZCm9quxROApMpiWNHHNO6GHk7sDZSKGjbgRttnbowh6HhQ2l22</span><br><span class="line">q3W0L71cAxMEYM/WkKVSUhKKuMewChylieHckCouIpALF5R162x+<span class="number">0</span>fYYFo22e2Ou</span><br><span class="line">lmpfRfgGTRsmAZfSKMgj93H4yZfUwfT+tAM5Tvk4emk2NWVwmlGfzcfa+<span class="number">20</span>nmhcs</span><br><span class="line">wUtChOBG1jGFtw8QeQIDAQABo4ICVTCCAlEwDgYDVR0PAQH/BAQDAgWgMB0GA1Ud</span><br><span class="line">JQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQW</span><br><span class="line">BBRJ7mAMSacV9+dtpnyLJowYhXAlWDAfBgNVHSMEGDAWgBQULrMXt1hWy65QCUDm</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">root@i-tsfhx8p6:~/qke-k8s/cert-manager/alidns-webhook# kubectl get secrets lishuai-fun-tls -o json |jq --raw-output '.data["tls.crt"]'|base64 -d &gt;tls.crt </span><br><span class="line"></span><br><span class="line">root@i-tsfhx8p6:~/qke-k8s/cert-manager/alidns-webhook# openssl x509 -in tls.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: <span class="number">3</span> (<span class="number">0</span>x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            <span class="number">04:ed:9c:a8:87:58:22:ad</span>:<span class="number">df:66:38:9b:f3:06:a1:b3</span>:<span class="number">44</span>:<span class="number">1</span>f</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C = US, O = Let's Encrypt, CN = R3</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Jul <span class="number">31 16:34:30</span> <span class="number">2021</span> GMT</span><br><span class="line">            Not After : Oct <span class="number">29 16:34:28</span> <span class="number">2021</span> GMT</span><br><span class="line">        Subject: CN = lishuai.fun</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (<span class="number">2048</span> bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    <span class="number">00:d8:a4:d4:7d:56:1d:ec</span>:<span class="number">92</span>:<span class="number">15</span>:<span class="number">7</span>e:a7:<span class="number">28</span>:b9:<span class="number">05</span>:</span><br><span class="line">                    <span class="number">8d:53:59:72:ea:16:2b:4b</span>:<span class="number">16</span>:<span class="number">0</span>b:<span class="number">93</span>:db:<span class="number">30</span>:<span class="number">10</span>:ae:</span><br><span class="line">                    <span class="number">46:da:49:5a:11:7f:f9:45</span>:aa:b2:<span class="number">6</span>e:a5:<span class="number">47</span>:be:db:</span><br><span class="line">                    <span class="number">59:88:06:a1:be:e6:6c:c2</span>:<span class="number">14</span>:f2:cc:<span class="number">77:02:23:30</span>:</span><br><span class="line">                    <span class="number">c2:ce:b2:ae:72:cd:59:14</span>:<span class="number">4</span>f:<span class="number">51</span>:<span class="number">4</span>f:d3:<span class="number">8</span>a:<span class="number">02</span>:f9:</span><br><span class="line">                    <span class="number">98:d5:ee:88:c5:e1:14:6f</span>:<span class="number">3d</span>:<span class="number">87</span>:<span class="number">8</span>b:<span class="number">66</span>:<span class="number">41</span>:a4:ff:</span><br><span class="line">                    <span class="number">35:b0:b3:bd:1b:db:77:c7</span>:<span class="number">45</span>:<span class="number">3d</span>:<span class="number">45</span>:<span class="number">8</span>e:f9:<span class="number">85</span>:ff:</span><br><span class="line">                    <span class="number">e2:4e:03:86:23:66:42:9b</span>:da:ae:c5:<span class="number">13</span>:<span class="number">80</span>:a4:ca:</span><br><span class="line">                    <span class="number">62:58:d1:c7:34:ee:86:1e</span>:<span class="number">4</span>e:ec:<span class="number">0d</span>:<span class="number">94</span>:<span class="number">8</span>a:<span class="number">1</span>a:<span class="number">36</span>:</span><br><span class="line">                    <span class="number">e0:46:db:67:6e:8c:21:e8</span>:<span class="number">78</span>:<span class="number">50</span>:da:<span class="number">5d</span>:b6:ab:<span class="number">75</span>:</span><br><span class="line">                    <span class="number">b4:2f:bd:5c:03:13:04:60</span>:cf:d6:<span class="number">90</span>:a<span class="number">5:52:52:12</span>:</span><br><span class="line">                    <span class="number">8a:b8:c7:b0:0a:1c:a5:89</span>:e1:dc:<span class="number">90</span>:<span class="number">2</span>a:<span class="number">2</span>e:<span class="number">22</span>:<span class="number">90</span>:</span><br><span class="line">                    <span class="number">0b:17:94:75:eb:6c:7e:d1</span>:f6:<span class="number">18</span>:<span class="number">16</span>:<span class="number">8d</span>:b6:<span class="number">7</span>b:<span class="number">63</span>:</span><br><span class="line">                    <span class="number">ae:96:6a:5f:45:f8:06:4d</span>:<span class="number">1</span>b:<span class="number">26</span>:<span class="number">01</span>:<span class="number">97</span>:d2:<span class="number">28</span>:c8:</span><br><span class="line">                    <span class="number">23:f7:71:f8:c9:97:d4:c1</span>:f4:fe:b4:<span class="number">03</span>:<span class="number">39</span>:<span class="number">4</span>e:f9:</span><br><span class="line">                    <span class="number">38:7a:69:36:35:65:70:9a</span>:<span class="number">51</span>:<span class="number">9</span>f:cd:c7:da:fb:<span class="number">6d</span>:</span><br><span class="line">                    <span class="number">27:9a:17:2c:c1:4b:42:84</span>:e0:<span class="number">46</span>:d6:<span class="number">31</span>:<span class="number">85</span>:b7:<span class="number">0</span>f:</span><br><span class="line">                    <span class="number">10</span>:<span class="number">79</span></span><br><span class="line">                Exponent: <span class="number">65537</span> (<span class="number">0x10001</span>)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage: </span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                <span class="number">49:EE:60:0C:49:A7:15:F7</span>:<span class="number">E7:6D:A6:7C:8B:26:8C:18</span>:<span class="number">85:70:25:58</span></span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyi<span class="number">d:14:2E:B3:17:B7:58:56</span>:<span class="number">CB:AE:50:09:40:E6:1F:AF</span>:<span class="number">9</span>D:<span class="number">8</span>B:<span class="number">14</span>:C2:C6</span><br><span class="line"></span><br><span class="line">            Authority Information Access: </span><br><span class="line">                OCSP - URI:http://r3.o.lencr.org</span><br><span class="line">                CA Issuers - URI:http://r3.i.lencr.org/</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name: </span><br><span class="line">                DNS:*.lishuai.fun, DNS:lishuai.fun</span><br><span class="line">            X509v3 Certificate Policies: </span><br><span class="line">                Policy: <span class="number">2.23.140.1</span>.<span class="number">2</span>.<span class="number">1</span></span><br><span class="line">                Policy: <span class="number">1.3.6.1</span>.<span class="number">4.1.44947</span>.<span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span></span><br><span class="line">                  CPS: http://cps.letsencrypt.org</span><br><span class="line"></span><br><span class="line">            CT Precertificate SCTs: </span><br><span class="line">                Signed Certificate Timestamp:</span><br><span class="line">                    Version   : v1 (<span class="number">0</span>x0)</span><br><span class="line">                    Log ID    : <span class="number">F6:5C:94:2F:D1:77:30:22</span>:<span class="number">14:54:18:08:30:94:56:8E</span>:</span><br><span class="line">                                <span class="number">E3:4D:13:19:33:BF:DF:0C</span>:<span class="number">2F:20:0B:CC:4E:F1:64:E3</span></span><br><span class="line">                    Timestamp : Jul <span class="number">31 17:34:30</span>.<span class="number">686 2021</span> GMT</span><br><span class="line">                    Extensions: none</span><br><span class="line">                    Signature : ecdsa-with-SHA256</span><br><span class="line">                                <span class="number">30:45:02:21:00:B3:44:02</span>:<span class="number">18:42:96:53:DA:94:34:99</span>:</span><br><span class="line">                                <span class="number">1B:DE:3A:37:85:72:E4:2B</span>:<span class="number">43:D6:66:99:D9:4D:DF:02</span>:</span><br><span class="line">                                <span class="number">A7:5A:A4:54:80:02:20:34</span>:<span class="number">C4:45:7D:B4:F8:19:8D:A4</span>:</span><br><span class="line">                                <span class="number">09:41:3A:7E:23:B3:4D:4B</span>:<span class="number">04:76:9E:E1:F2:94:EC:50</span>:</span><br><span class="line">                                <span class="number">2</span>C:BF:A7:<span class="number">3</span>B:<span class="number">71</span>:<span class="number">75</span>:E4</span><br><span class="line">                Signed Certificate Timestamp:</span><br><span class="line">                    Version   : v1 (<span class="number">0</span>x0)</span><br><span class="line">                    Log ID    : <span class="number">6F:53:76:AC:31:F0:31:19</span>:<span class="number">D8:99:00:A4:51:15:FF:77</span>:</span><br><span class="line">                                <span class="number">15:1C:11:D9:02:C1:00:29</span>:<span class="number">06:8D:B2:08:9A:37:D9:13</span></span><br><span class="line">                    Timestamp : Jul <span class="number">31 17:34:30</span>.<span class="number">744 2021</span> GMT</span><br><span class="line">                    Extensions: none</span><br><span class="line">                    Signature : ecdsa-with-SHA256</span><br><span class="line">                                <span class="number">30:45:02:20:26:99:A1:07</span>:<span class="number">A5:B1:48:10:B4:8D:30:20</span>:</span><br><span class="line">                                <span class="number">E4:AC:A2:44:1A:8B:FD:17</span>:<span class="number">52:FF:CC:9E:FC:A2:02:66</span>:</span><br><span class="line">                                <span class="number">C2:B7:A9:9C:02:21:00:BB</span>:<span class="number">F2:DD:2E:1A:1C:20:56:BE</span>:</span><br><span class="line">                                <span class="number">96:7C:94:56:EC:40:9F:9C</span>:<span class="number">0F:70:F2:DC:CF:65:DC:7B</span>:</span><br><span class="line">                                <span class="number">37</span>:<span class="number">26</span>:<span class="number">1</span>E:<span class="number">02</span>:<span class="number">5</span>E:E9:<span class="number">9</span>E</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         <span class="number">23:b9:f4:b1:c7:95:3e:ef</span>:<span class="number">5d:41:42:1d:17:a9:1b:d2</span>:f1:b6:</span><br><span class="line">         <span class="number">42:61:ca:d4:63:9e:c4:f1</span>:<span class="number">11:0d:8a:03:29:66:9b:98</span>:<span class="number">58</span>:<span class="number">98</span>:</span><br><span class="line">         <span class="number">42:2d:eb:ee:d8:16:f5:7e</span>:<span class="number">4f:e6:28:c1:82:bd:5e:b0</span>:<span class="number">28</span>:<span class="number">82</span>:</span><br><span class="line">         <span class="number">56:a0:0a:34:13:d6:15:98</span>:<span class="number">8c:97:c6:c2:7f:64:50:d7</span>:<span class="number">19</span>:<span class="number">4</span>c:</span><br><span class="line">         <span class="number">25:45:4e:c0:ff:ee:90:63</span>:<span class="number">29:bb:ba:01:1f:62:b5:d4</span>:<span class="number">5d</span>:<span class="number">50</span>:</span><br><span class="line">         <span class="number">49:0d:af:a0:f6:94:af:68</span>:<span class="number">29:1a:46:34:13:c0:e4:26</span>:<span class="number">68</span>:<span class="number">22</span>:</span><br><span class="line">         <span class="number">ba:fe:58:c7:6e:79:a4:3b</span>:<span class="number">9f:80:dc:cd:ef:44:21:57</span>:e1:<span class="number">36</span>:</span><br><span class="line">         <span class="number">2e:36:b2:98:a4:ea:38:f9</span>:<span class="number">ed:f9:3e:31:df:47:03:32</span>:<span class="number">63</span>:<span class="number">8</span>f:</span><br><span class="line">         <span class="number">8a:9a:a2:2a:7d:4a:2b:23</span>:<span class="number">c0:e6:9f:35:b4:b6:3a:ac</span>:c1:e6:</span><br><span class="line">         <span class="number">40:91:5c:f0:5c:17:48:9b</span>:<span class="number">ac:49:5f:f6:91:e8:03:0a</span>:<span class="number">9</span>c:<span class="number">37</span>:</span><br><span class="line">         <span class="number">48:46:40:29:b1:85:72:40</span>:<span class="number">3c:05:a8:3d:13:67:20:4a</span>:<span class="number">36</span>:<span class="number">6</span>f:</span><br><span class="line">         <span class="number">4c:c0:a9:b8:40:dc:96:3b</span>:<span class="number">99:da:82:3a:71:6f:41:93</span>:aa:e2:</span><br><span class="line">         <span class="number">22:c4:19:14:7b:8c:64:0b</span>:<span class="number">b5:9b:b1:d0:56:b1:17:93</span>:<span class="number">72</span>:d7:</span><br><span class="line">         <span class="number">94:7e:a9:08:f6:f4:0c:1d</span>:<span class="number">4e:36:be:1d:14:ff:a2:9a</span>:<span class="number">02</span>:af:</span><br><span class="line">         <span class="number">82</span>:<span class="number">9d</span>:bb:<span class="number">8</span>f</span><br></pre></td></tr></table></figure><p>我们也可以使用一些网站提供的在线证书查看</p><img src="/2024/067bd705c5/image-20250122160310979.png"><p>我们可以看到这个证书是个泛域名证书，此时我们ingress 可以直接使用该secert，不需要再去添加注解执行使用的issuer/cluseteissuer了，例如</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@i-tsfhx8p6:~/qke-k8s/cert-manager/ingress#</span> <span class="string">cat</span> <span class="string">alertmanager-ingress.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">alertmanager-qke.lishuai.fun</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - backend:</span></span><br><span class="line"><span class="attr">          service:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">alertmanager-main</span></span><br><span class="line"><span class="attr">            port:</span></span><br><span class="line"><span class="attr">              number:</span> <span class="number">9093</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        pathType:</span> <span class="string">Prefix</span></span><br><span class="line"><span class="attr">  tls:</span> <span class="comment"># &lt; placing a host in the TLS config will indicate a certificate should be created</span></span><br><span class="line"><span class="attr">  - hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">alertmanager-qke.lishuai.fun</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">lishuai-fun-tls</span></span><br></pre></td></tr></table></figure><img src="/2024/067bd705c5/image-20250122160335156.png"><h2 id="创建Certificate"><a href="#创建Certificate" class="headerlink" title="创建Certificate"></a>创建Certificate</h2><p>这里拿我们上面创建的那个Certificate来讲解</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: cert-manager.io/v1</span><br><span class="line">kind: Certificate</span><br><span class="line">metadata:</span><br><span class="line">  name: lishuai-<span class="function"><span class="keyword">fun</span>-tls</span></span><br><span class="line">spec:</span><br><span class="line">  secretName: lishuai-<span class="function"><span class="keyword">fun</span>-tls</span></span><br><span class="line">  dnsNames:</span><br><span class="line">  - lishuai.<span class="keyword">fun</span></span><br><span class="line">  - <span class="string">"*.lishuai.fun"</span></span><br><span class="line">  issuerRef:</span><br><span class="line">    name: letsencrypt-staging</span><br><span class="line">    kind: ClusterIssuer</span><br></pre></td></tr></table></figure><ul><li>spec.secretName 指示证书最终存到哪个 Secret 中</li><li>spec.issuerRef.kind 值为 ClusterIssuer 说明签发机构不在本 namespace 下，而是在全局</li><li>spec.issuerRef.name 我们创建的签发机构的名称 (ClusterIssuer.metadata.name)</li><li>spec.dnsNames 指示该证书的可以用于哪些域名</li></ul><p>下面是一个官方的包含完整字段的Certificate</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Certificate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example-com</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">sandbox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Secret names are always required.</span></span><br><span class="line"><span class="attr">  secretName:</span> <span class="string">example-com-tls</span></span><br><span class="line"><span class="attr">  duration:</span> <span class="number">2160</span><span class="string">h</span> <span class="comment"># 90d</span></span><br><span class="line"><span class="attr">  renewBefore:</span> <span class="number">360</span><span class="string">h</span> <span class="comment"># 15d</span></span><br><span class="line"><span class="attr">  subject:</span></span><br><span class="line"><span class="attr">    organizations:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">jetstack</span></span><br><span class="line">  <span class="comment"># The use of the common name field has been deprecated since 2000 and is</span></span><br><span class="line">  <span class="comment"># discouraged from being used.</span></span><br><span class="line"><span class="attr">  commonName:</span> <span class="string">example.com</span></span><br><span class="line"><span class="attr">  isCA:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  privateKey:</span></span><br><span class="line"><span class="attr">    algorithm:</span> <span class="string">RSA</span></span><br><span class="line"><span class="attr">    encoding:</span> <span class="string">PKCS1</span></span><br><span class="line"><span class="attr">    size:</span> <span class="number">2048</span></span><br><span class="line"><span class="attr">  usages:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">server</span> <span class="string">auth</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">client</span> <span class="string">auth</span></span><br><span class="line">  <span class="comment"># At least one of a DNS Name, URI, or IP address is required.</span></span><br><span class="line"><span class="attr">  dnsNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">example.com</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">www.example.com</span></span><br><span class="line"><span class="attr">  uris:</span></span><br><span class="line"><span class="attr">    - spiffe:</span><span class="string">//cluster.local/ns/sandbox/sa/example</span></span><br><span class="line"><span class="attr">  ipAddresses:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.5</span></span><br><span class="line">  <span class="comment"># Issuer references are always required.</span></span><br><span class="line"><span class="attr">  issuerRef:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">ca-issuer</span></span><br><span class="line">    <span class="comment"># We can reference ClusterIssuers by changing the kind here.</span></span><br><span class="line">    <span class="comment"># The default value is Issuer (i.e. a locally namespaced Issuer)</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Issuer</span></span><br><span class="line">    <span class="comment"># This is optional since cert-manager will default to this value however</span></span><br><span class="line">    <span class="comment"># if you are using an external issuer, change this to that issuer group.</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">cert-manager.io</span></span><br></pre></td></tr></table></figure><p>转载自：<a href="https://www.lishuai.fun/2021/08/01/k8s-create-cert-manager/#/简介" target="_blank" rel="noopener">k8s安装cert-manager及签发泛域名证书 · kubernetes</a></p></div><div><div id="reward-container"><div>Thank you for your accept. mua！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/reward/wechatpay.png" alt="丨逸贤丨 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/reward/alipay.png" alt="丨逸贤丨 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>丨逸贤丨</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://yixian12580.github.io/2024/067bd705c5.html" title="k8s安装cert-manager及签发泛域名证书">https://yixian12580.github.io/2024/067bd705c5.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:16px">-------------本文结束<i class="fa fa-heart"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/免费证书/" rel="tag"><i class="fa fa-tag"></i> 免费证书</a></div><div class="post-widgets"><div class="social_share"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2024/062698ba09.html" rel="next" title="k8s使用NFS建立持久卷"><i class="fa fa-chevron-left"></i> k8s使用NFS建立持久卷</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2024/06540ef920.html" rel="prev" title="certbot申请泛域名证书及自动续期">certbot申请泛域名证书及自动续期 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div><div style="text-align:center"><a href="https://github.com/yixian12580/blog-source/edit/main/source/_posts/k8s安装cert-manager及签发泛域名证书.md" target="_blank">编辑文章✏</a></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC81NzIwNy8zMzY3MQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="丨逸贤丨"><p class="site-author-name" itemprop="name">丨逸贤丨</p><div class="site-description motion-element" itemprop="description">三十年众生牛马，搏十年丰功伟绩。</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">144</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">131</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/yixian12580" title="GitHub &rarr; https://github.com/yixian12580" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1083662409@qq.com" title="E-Mail &rarr; mailto:1083662409@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://weibo.com/u/5107819265" title="Weibo &rarr; https://weibo.com/u/5107819265" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="tencent://message/?uin=1083662409&Site=&menu=yes" title="QQ &rarr; tencent://message/?uin=1083662409&Site=&menu=yes" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-book"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://www.ttlsa.com/" title="http://www.ttlsa.com/" rel="noopener" target="_blank">运维生存时间</a></li><li class="links-of-blogroll-item"><a href="https://www.iyunw.cn" title="https://www.iyunw.cn" rel="noopener" target="_blank">爱运维</a></li><li class="links-of-blogroll-item"><a href="https://nginxconfig.io/" title="https://nginxconfig.io/" rel="noopener" target="_blank">Nginxconfig</a></li><li class="links-of-blogroll-item"><a href="http://linux.51yip.com/" title="http://linux.51yip.com/" rel="noopener" target="_blank">Linux命令手册</a></li><li class="links-of-blogroll-item"><a href="https://echarts.apache.org/index.html" title="https://echarts.apache.org/index.html" rel="noopener" target="_blank">echarts可视化库</a></li><li class="links-of-blogroll-item"><a href="https://yixian12580.netlify.app/admin/" title="https://yixian12580.netlify.app/admin/" rel="noopener" target="_blank">博客管理</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#架构"><span class="nav-number">1.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置Issuer-ClusterIssuer"><span class="nav-number">3.</span> <span class="nav-text">配置Issuer/ClusterIssuer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-01-校验原理"><span class="nav-number">3.1.</span> <span class="nav-text">HTTP-01 校验原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS-01-校验原理"><span class="nav-number">3.2.</span> <span class="nav-text">DNS-01 校验原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#校验方式对比"><span class="nav-number">3.3.</span> <span class="nav-text">校验方式对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP01配置示例"><span class="nav-number">3.4.</span> <span class="nav-text">HTTP01配置示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS01配置示例"><span class="nav-number">3.5.</span> <span class="nav-text">DNS01配置示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装alidns-webhook"><span class="nav-number">3.5.1.</span> <span class="nav-text">安装alidns-webhook</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建Certificate"><span class="nav-number">4.</span> <span class="nav-text">创建Certificate</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><style>.aplayer .aplayer-lrc{height:35px}.aplayer .aplayer-lrc p{font-size:16px;font-weight:700;line-height:19.2px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{color:#ff1493}.aplayer.aplayer-narrow .aplayer-body{left:-66px!important}</style><div class="aplayer" data-id="7622186670" data-server="netease" data-type="playlist" data-fixed="true" data-order="random" data-autoplay="false"></div><script src="/dist/Meting.min.js"></script></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright" style="text-align:center">&copy; 2022 – <span itemprop="copyrightYear">2025</span> <span class="with-love" id="animate"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">逸贤</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart">站点字数合计:</i> </span><span title="站点总字数">1m</span></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="run_time" style="text-align:center"><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("09/08/2022 10:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script></div><div class="busuanzi-count" style="text-align:center"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/js/utils.js?v=7.1.1"></script><script src="/js/motion.js?v=7.1.1"></script><script src="/js/schemes/muse.js?v=7.1.1"></script><script src="/js/scrollspy.js?v=7.1.1"></script><script src="/js/post-details.js?v=7.1.1"></script><script src="/js/next-boot.js?v=7.1.1"></script><script>window.livereOptions={refer:"2024/067bd705c5.html"},function(e,t){var n,r=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,r.parentNode.insertBefore(n,r))}(document,"script")</script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions)</script><script src="/lib/bookmark/bookmark.min.js?v=1.0"></script><script>bookmark.scrollToMark("auto","#更多")</script><script>$(".highlight").not(".gist .highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=e,document.body.appendChild(n),n.select(),n.setSelectionRange(0,e.length),n.readOnly=!1,document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script></body></html><script type="text/javascript" src="/js/src/clicklove.js"></script><script type="text/javascript" src="/js/click_show_text.js"></script><script type="text/javascript" src="/js/FunnyTitle.js"></script><script src="/live2d-widget/autoload.js"></script>