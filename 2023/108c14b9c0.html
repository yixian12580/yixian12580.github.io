<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1"><link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.1",sidebar:{position:"left",display:"post",offset:12,onmobile:!0,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!0,fastclick:!0,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"shrinkIn",post_header:"slideLeftIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideDownIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,c,a,i,n){e.DaoVoiceObject=a,e[a]=e[a]||function(){(e[a].q=e[a].q||[]).push(arguments)},e[a].l=+new Date,i=t.createElement(o),n=t.getElementsByTagName(o)[0],i.async=1,i.src=c,i.charset="utf-8",n.parentNode.insertBefore(i,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"aac7f9b5"}),daovoice("update")</script><meta name="description" content="LVS是Linux Virtual Server的简写，在1998年5月由章文嵩博士成立，工作在OSI模型的四层，基于IP进行负载均衡， 在linux2.2内核时，IPVS就已经以内核补丁的形式出现， 从2.4版本以后，IPVS已经成为linux官方标准内核的一部分。"><meta name="keywords" content="LVS,负责均衡"><meta property="og:type" content="article"><meta property="og:title" content="LVS的安装部署"><meta property="og:url" content="https://yixian12580.github.io/2023/108c14b9c0.html"><meta property="og:site_name" content="逸贤 | Blog"><meta property="og:description" content="LVS是Linux Virtual Server的简写，在1998年5月由章文嵩博士成立，工作在OSI模型的四层，基于IP进行负载均衡， 在linux2.2内核时，IPVS就已经以内核补丁的形式出现， 从2.4版本以后，IPVS已经成为linux官方标准内核的一部分。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://yixian12580.github.io/2023/108c14b9c0/image-20231020131336355.png"><meta property="og:image" content="https://yixian12580.github.io/2023/108c14b9c0/image-20231020132224301.png"><meta property="og:image" content="https://yixian12580.github.io/2023/108c14b9c0/image-20231020132955005.png"><meta property="og:updated_time" content="2025-02-13T03:15:21.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="LVS的安装部署"><meta name="twitter:description" content="LVS是Linux Virtual Server的简写，在1998年5月由章文嵩博士成立，工作在OSI模型的四层，基于IP进行负载均衡， 在linux2.2内核时，IPVS就已经以内核补丁的形式出现， 从2.4版本以后，IPVS已经成为linux官方标准内核的一部分。"><meta name="twitter:image" content="https://yixian12580.github.io/2023/108c14b9c0/image-20231020131336355.png"><link rel="alternate" href="/atom.xml" title="逸贤 | Blog" type="application/atom+xml"><link rel="canonical" href="https://yixian12580.github.io/2023/108c14b9c0"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>LVS的安装部署 | 逸贤 | Blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">逸贤 | Blog</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-bookmark"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-互动"><a href="/guestbook/" rel="section"><i class="menu-item-icon fa fa-fw fa-comments"></i><br>互动</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://yixian12580.github.io/2023/108c14b9c0.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="丨逸贤丨"><meta itemprop="description" content="三十年众生牛马，搏十年丰功伟绩。"><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="逸贤 | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">LVS的安装部署</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-10-20 12:58:35" itemprop="dateCreated datePublished" datetime="2023-10-20T12:58:35+08:00">2023-10-20</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-02-13 11:15:21" itemprop="dateModified" datetime="2025-02-13T11:15:21+08:00">2025-02-13</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/" itemprop="url" rel="index"><span itemprop="name">技术</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/LVS/" itemprop="url" rel="index"><span itemprop="name">LVS</span></a></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数： <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">26k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">24 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>LVS是Linux Virtual Server的简写，在1998年5月由章文嵩博士成立，工作在OSI模型的四层，基于IP进行负载均衡， 在linux2.2内核时，IPVS就已经以内核补丁的形式出现， 从2.4版本以后，IPVS已经成为linux官方标准内核的一部分。</p><a id="more"></a><p>系统必须有ip_vs模块</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看ip_vs模块</span></span><br><span class="line">[root@node1 ~]<span class="comment"># lsmod |grep -i ip_vs</span></span><br><span class="line">ip_vs_rr              <span class="number"> 12600 </span><span class="number"> 1 </span></span><br><span class="line">ip_vs                <span class="number"> 141432 </span><span class="number"> 3 </span>ip_vs_rr</span><br><span class="line">nf_conntrack         <span class="number"> 133053 </span><span class="number"> 7 </span>ip_vs,nf_nat,nf_nat_ipv4,nf_nat_ipv6,xt_conntrack,nf_conntrack_ipv4,nf_conntrack_ipv6</span><br><span class="line">libcrc32c             <span class="number"> 12644 </span><span class="number"> 4 </span>xfs,ip_vs,nf_nat,nf_conntrack</span><br><span class="line"><span class="comment">#没有，加载ip_vs</span></span><br><span class="line">[root@node1 ~]<span class="comment"># modprobe ip_vs</span></span><br></pre></td></tr></table></figure><h2 id="LVS的安装"><a href="#LVS的安装" class="headerlink" title="LVS的安装"></a>LVS的安装</h2><h3 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1、安装清华的epel源</span></span><br><span class="line"><span class="meta">#2、安装ipvadm</span></span><br><span class="line">yum install -y ipvsadm</span><br></pre></td></tr></table></figure><h3 id="源码包安装"><a href="#源码包安装" class="headerlink" title="源码包安装"></a>源码包安装</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://mirrors.edge.kernel.org/pub/linux/utils/kernel/ipvsadm/选择与内核相同版本的软件</span></span><br><span class="line">mkdir -p <span class="regexp">/server/</span>tools</span><br><span class="line">cd <span class="regexp">/server/</span>tools</span><br><span class="line">wget -c https:<span class="regexp">//mi</span>rrors.edge.kernel.org<span class="regexp">/pub/</span>linux<span class="regexp">/utils/</span>kernel<span class="regexp">/ipvsadm/i</span>pvsadm-<span class="number">1.30</span>.tar.xz</span><br><span class="line">ln -s <span class="regexp">/usr/</span>src<span class="regexp">/kernels/</span><span class="number">3.10</span>.<span class="number">0</span>-<span class="number">1062.18</span>.<span class="number">1</span>.el7.x86_64<span class="regexp">/ /u</span>sr<span class="regexp">/src/</span>linux</span><br><span class="line">tar xzvf ipvsadm-<span class="number">1.30</span>.tar.gz </span><br><span class="line">cd ipvsadm-<span class="number">1.30</span></span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line"><span class="comment">#如果编译报错，请安装依赖包</span></span><br><span class="line"><span class="comment">#yum install -y popt-static kernel-devel make gcc openssl-devel lftplibnl* popt* openssl-devel lftplibnl* popt* libnl* libpopt* gcc*</span></span><br></pre></td></tr></table></figure><h2 id="ipvsadm命令详解"><a href="#ipvsadm命令详解" class="headerlink" title="ipvsadm命令详解"></a>ipvsadm命令详解</h2><p>ipvsadm是ipvs的管理器，需要yum安装。</p><h3 id="LVS-相关软件"><a href="#LVS-相关软件" class="headerlink" title="LVS 相关软件"></a>LVS 相关软件</h3><p>程序包：ipvsadm Unit File: ipvsadm.service</p><p>主程序：/usr/sbin/ipvsadm</p><p>规则保存工具：/usr/sbin/ipvsadm-save</p><p>规则重载工具：/usr/sbin/ipvsadm-restore</p><p>配置文件：/etc/sysconfig/ipvsadm-config</p><p>ipvs调度规则文件：/etc/sysconfig/ipvsadm</p><h3 id="ipvsadm-命令"><a href="#ipvsadm-命令" class="headerlink" title="ipvsadm 命令"></a>ipvsadm 命令</h3><p>ipvsadm核心功能：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、集群服务管理：增、删、改</span><br><span class="line"><span class="number">2</span>、集群服务的RS管理：增、删、改</span><br><span class="line"><span class="number">3</span>、查看</span><br></pre></td></tr></table></figure><h3 id="ipvsadm-工具用法："><a href="#ipvsadm-工具用法：" class="headerlink" title="ipvsadm 工具用法："></a>ipvsadm 工具用法：</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#管理集群服务</span><br><span class="line">ipvsadm -A|<span class="type">E</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]] [-M netmask]</span><br><span class="line">[--pe persistence_engine] [-b sched-flags]</span><br><span class="line">ipvsadm -D -t|<span class="type">u</span>|<span class="type">f</span> service-address #删除</span><br><span class="line">ipvsadm –C #清空</span><br><span class="line">ipvsadm –R #重载,相当于ipvsadm-restore</span><br><span class="line">ipvsadm -S [-n] #保存,相当于ipvsadm-save</span><br><span class="line"></span><br><span class="line">#管理集群中的RS</span><br><span class="line">ipvsadm -a|<span class="type">e</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address [-g|<span class="type">i</span>|<span class="type">m</span>] [-w weight]</span><br><span class="line">ipvsadm -d -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address</span><br><span class="line">ipvsadm -L|<span class="type">l</span> [options]</span><br><span class="line">ipvsadm -Z [-t|<span class="type">u</span>|<span class="type">f</span> service-address]</span><br></pre></td></tr></table></figure><h3 id="防火墙标记"><a href="#防火墙标记" class="headerlink" title="防火墙标记"></a>防火墙标记</h3><p>FWM：FireWall Mark MARK target 可用于给特定的报文打标记 –set-mark value 其中：value 可为0xffff格式，表示十六进制数字 借助于防火墙标记来分类报文，而后基于标记定义集群服务；可将多个不同的应用使用同一个集群服务 进行调度 实现方法： 在Director主机打标记：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t<span class="built_in"> mangle </span>-A PREROUTING -d <span class="variable">$vip</span> -p <span class="variable">$proto</span> -m multiport --dports <span class="variable">$port1</span>,<span class="variable">$port2</span>,… -j MARK --set-mark NUMBER</span><br></pre></td></tr></table></figure><p>范例:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs ~]#iptables -t<span class="built_in"> mangle </span>-A PREROUTING -d 172.16.0.100 -p tcp -m</span><br><span class="line">multiport --dports 80,443 -j MARK --set-mark 10</span><br><span class="line">[root@lvs ~]#ipvsadm -C</span><br><span class="line">[root@lvs ~]#ipvsadm -A -f 10 -s rr</span><br><span class="line">[root@lvs ~]#ipvsadm -a -f 10 -r 10.0.0.7 -g</span><br><span class="line">[root@lvs ~]#ipvsadm -a -f 10 -r 10.0.0.17 -g</span><br><span class="line">[root@lvs ~]#ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">FWM 10 rr</span><br><span class="line">-&gt; 10.0.0.7:0<span class="built_in"> Route </span>1 0 0</span><br><span class="line">-&gt; 10.0.0.17:0<span class="built_in"> Route </span>1 0 0</span><br><span class="line">[root@lvs ~]#cat /proc/net/ip_vs</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">FWM 0000000A rr</span><br><span class="line">-&gt; 0A000011:0000<span class="built_in"> Route </span>1 0 9</span><br><span class="line">-&gt; 0A000007:0000<span class="built_in"> Route </span>1 0 9</span><br></pre></td></tr></table></figure><p>在Director主机基于标记定义集群服务：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -f NUMBER <span class="string">[options]</span></span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs ~]#ipvsadm -A -f 10</span><br><span class="line">[root@lvs ~]#ipvsadm -a -f 10 -r 10.0.0.7 -g</span><br><span class="line">[root@lvs ~]#ipvsadm -a -f 10 -r 10.0.0.17 -g</span><br><span class="line">[root@lvs ~]#ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">FWM 10 wlc</span><br><span class="line">-&gt; 10.0.0.7:0<span class="built_in"> Route </span>1 0 0</span><br><span class="line">-&gt; 10.0.0.17:0<span class="built_in"> Route </span>1 0 0</span><br><span class="line"></span><br><span class="line">[root@LVS ~]#cat /proc/net/ip_vs</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">TCP AC14C8C8:0050 rr</span><br><span class="line">-&gt; 0A000011:0050 Masq 1 0 0</span><br><span class="line">-&gt; 0A000007:0050 Masq 1 0 0</span><br><span class="line">123456789101112131415161718</span><br></pre></td></tr></table></figure><h3 id="LVS-持久连接"><a href="#LVS-持久连接" class="headerlink" title="LVS 持久连接"></a>LVS 持久连接</h3><p>session 绑定：对共享同一组RS的多个集群服务，需要统一进行绑定，lvs sh算法无法实现 持久连接（ lvs persistence ）</p><p>模板：实现无论使用任何调度算法，在一段时间内（默认360s ），能够实现将来自同一个地址的请求始终发往同一个RS</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|<span class="type">E</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]]</span><br></pre></td></tr></table></figure><p>持久连接实现方式：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、每端口持久（PPC）：每个端口定义为一个集群服务，每集群服务单独调度</span><br><span class="line"><span class="number">2</span>、每防火墙标记持久（PFWMC）：基于防火墙标记定义集群服务；可实现将多个端口上的应用统一调度，即所谓的port Affinity</span><br><span class="line"><span class="number">3</span>、每客户端持久（PCC）：基于<span class="number">0</span>端口（表示所有服务）定义集群服务，即将客户端对所有应用的请求都调度至后端主机，必须定义为持久模式</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs ~]#ipvsadm -E -f 10 -p</span><br><span class="line">[root@lvs ~]#ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">FWM 10 wlc persistent 360</span><br><span class="line">-&gt; 10.0.0.7:0<span class="built_in"> Route </span>1 0 15</span><br><span class="line">-&gt; 10.0.0.17:0<span class="built_in"> Route </span>1 0 7</span><br><span class="line">[root@lvs ~]#ipvsadm -E -f 10 -p 3600</span><br><span class="line">[root@lvs ~]#ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">-&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">FWM 10 wlc persistent 3600</span><br><span class="line">-&gt; 10.0.0.7:0<span class="built_in"> Route </span>1 0 79</span><br><span class="line">-&gt; 10.0.0.17:0<span class="built_in"> Route </span>1 0 7</span><br><span class="line"></span><br><span class="line">[root@lvs ~]#cat /proc/net/ip_vs_conn</span><br><span class="line">Pro FromIP FPrt ToIP TPrt DestIP DPrt State Expires PEName PEData</span><br><span class="line">TCP C0A80006 C816 AC100064 01BB 0A000011 01BB FIN_WAIT 67</span><br><span class="line">TCP C0A80006 C812 AC100064 01BB 0A000011 01BB FIN_WAIT 67</span><br><span class="line">TCP C0A80006 9A36 AC100064 0050 0A000011 0050 FIN_WAIT 65</span><br><span class="line">TCP C0A80006 C806 AC100064 01BB 0A000011 01BB FIN_WAIT 65</span><br><span class="line">TCP C0A80006 9A3E AC100064 0050 0A000011 0050 FIN_WAIT 66</span><br><span class="line">TCP C0A80006 C81A AC100064 01BB 0A000011 01BB FIN_WAIT 67</span><br><span class="line">TCP C0A80006 C80A AC100064 01BB 0A000011 01BB FIN_WAIT 66</span><br><span class="line">TCP C0A80006 9A3A AC100064 0050 0A000011 0050 FIN_WAIT 66</span><br><span class="line">TCP C0A80006 9A4E AC100064 0050 0A000011 0050 FIN_WAIT 68</span><br><span class="line">TCP C0A80006 9A42 AC100064 0050 0A000011 0050 FIN_WAIT 67</span><br><span class="line">TCP C0A80006 9A46 AC100064 0050 0A000011 0050 FIN_WAIT 67</span><br><span class="line">TCP C0A80006 C81E AC100064 01BB 0A000011 01BB FIN_WAIT 68</span><br><span class="line">IP C0A80006 0000 0000000A 0000 0A000011 0000 NONE 948</span><br><span class="line">TCP C0A80006 C80E AC100064 01BB 0A000011 01BB FIN_WAIT 66</span><br><span class="line">TCP C0A80006 9A4A AC100064 0050 0A000011 0050 FIN_WAIT 67</span><br><span class="line"></span><br><span class="line">[root@lvs ~]#ipvsadm -Lnc</span><br><span class="line">IPVS<span class="built_in"> connection </span>entries</span><br><span class="line">pro expire state source virtual destination</span><br><span class="line">TCP 00:46 FIN_WAIT 192.168.0.6:51222 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">TCP 00:46 FIN_WAIT 192.168.0.6:51218 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">TCP 00:45 FIN_WAIT 192.168.0.6:39478 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">TCP 00:45 FIN_WAIT 192.168.0.6:51206 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">TCP 00:46 FIN_WAIT 192.168.0.6:39486 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">TCP 00:47 FIN_WAIT 192.168.0.6:51226 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">TCP 00:45 FIN_WAIT 192.168.0.6:51210 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">TCP 00:45 FIN_WAIT 192.168.0.6:39482 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">TCP 00:47 FIN_WAIT 192.168.0.6:39502 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">TCP 00:46 FIN_WAIT 192.168.0.6:39490 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">TCP 00:46 FIN_WAIT 192.168.0.6:39494 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">TCP 00:47 FIN_WAIT 192.168.0.6:51230 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">IP 15:27 NONE 192.168.0.6:0 0.0.0.10:0 10.0.0.17:0</span><br><span class="line">TCP 00:46 FIN_WAIT 192.168.0.6:51214 172.16.0.100:443 10.0.0.17:443</span><br><span class="line">TCP 00:47 FIN_WAIT 192.168.0.6:39498 172.16.0.100:80 10.0.0.17:80</span><br><span class="line">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253</span><br></pre></td></tr></table></figure><h2 id="部署LVS-NAT"><a href="#部署LVS-NAT" class="headerlink" title="部署LVS NAT"></a>部署LVS NAT</h2><h3 id="LVS-NAT模式注意事项"><a href="#LVS-NAT模式注意事项" class="headerlink" title="LVS NAT模式注意事项"></a>LVS NAT模式注意事项</h3><p>LVS NAT模式工作原理用户请求LVS VIP到达director（LVS服务器：LB）（公网VIP：211.1.1.1），director 将请求的报文的目标IP地址改成后端的real server IP地址，同时将报文的目标端口也改成后端选定的real server相应端口，最后将报文发送到real server，real server将数据返给director，director再把数据发送给用户。（两次请求都经过director， 所以访问大的话，director会成为瓶颈），</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）、LVS服务器至少<span class="number">2</span>块物理网卡，一块连接公网（VIP），一块连接内网；</span><br><span class="line"><span class="number">2</span>）、后端Realserver机器的默认网关设置为LVS的内网IP地址；</span><br><span class="line"><span class="number">3</span>）、保证LVS内网网卡通常跟Realserver在同一网段；</span><br><span class="line"><span class="number">4</span>）、LVS NAT模式后端Realserver机器数量不超过<span class="number">30</span>台；</span><br><span class="line"><span class="number">5</span>）、用户的请求进入和返回均会经过LVS，LVS会成为瓶颈。</span><br></pre></td></tr></table></figure><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><img src="/2023/108c14b9c0/image-20231020131336355.png"><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">DR</span>: <span class="attribute">inode1</span>:外网<span class="attribute">ip</span>:<span class="number">10.0</span>.<span class="number">0.101</span>   内网<span class="attribute">ip</span>:<span class="number">172.16</span>.<span class="number">1.101</span></span><br><span class="line"><span class="attribute">RS1</span>: <span class="attribute">inode2</span>:<span class="number">172.16</span>.<span class="number">1.102</span>-----&gt;web页面 www.ywx1.com</span><br><span class="line"><span class="attribute">RS2</span>: <span class="attribute">inode3</span>:<span class="number">172.16</span>.<span class="number">1.103</span>-----&gt;web页面 www.ywx2.com</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@inode1</span> ~]# uname -r</span><br><span class="line"><span class="number">3.10</span>.<span class="number">0</span>-<span class="number">862</span>.el7.x86_64</span><br><span class="line">[root<span class="variable">@inode1</span> ~]# cat /etc/redhat-release </span><br><span class="line">CentOS Linux release <span class="number">7.5</span>.<span class="number">1804</span> (Core)</span><br></pre></td></tr></table></figure><h3 id="部署RS1和RS2的nginx"><a href="#部署RS1和RS2的nginx" class="headerlink" title="部署RS1和RS2的nginx"></a>部署RS1和RS2的nginx</h3><p>这里已经部署好了：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode2 ~]</span># <span class="selector-tag">curl</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.102</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@inode3 ~]</span># <span class="selector-tag">curl</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.103</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><h3 id="将RS1和RS2的网关配置为DR的内网ip地址：172-16-1-101"><a href="#将RS1和RS2的网关配置为DR的内网ip地址：172-16-1-101" class="headerlink" title="将RS1和RS2的网关配置为DR的内网ip地址：172.16.1.101"></a>将RS1和RS2的网关配置为DR的内网ip地址：172.16.1.101</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@inode2 ~]</span><span class="comment">#  sed -i '$aGATEWAY=172.16.1.101' /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line"><span class="section">[root@inode2 ~]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">NAME</span>=eth1</span><br><span class="line"><span class="attr">DEVICE</span>=eth1</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">172.16</span>.<span class="number">1.102</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="number">24</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="number">172.16</span>.<span class="number">1.101</span></span><br><span class="line"><span class="section">[root@inode2 ~]</span><span class="comment">#systemctl restart network</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[root@inode3 ~]</span><span class="comment">#  sed -i '$aGATEWAY=172.16.1.101' /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line"><span class="section">[root@inode3 ~]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">NAME</span>=eth1</span><br><span class="line"><span class="attr">DEVICE</span>=eth1</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">172.16</span>.<span class="number">1.103</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="number">24</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="number">172.16</span>.<span class="number">1.101</span></span><br><span class="line"><span class="section">[root@inode3 ~]</span><span class="comment">#systemctl restart network</span></span><br></pre></td></tr></table></figure><h3 id="部署NAT的LVS"><a href="#部署NAT的LVS" class="headerlink" title="部署NAT的LVS"></a>部署NAT的LVS</h3><p>第一步：安装LVS</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y ipvsadm</span><br></pre></td></tr></table></figure><p>第二步：把DR的外网ip：10.0.0.101作为VIP，加入lvs集群</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-A</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-s</span> <span class="selector-tag">rr</span></span><br><span class="line"><span class="selector-id">#-A</span> 添加虚拟服务器的<span class="selector-tag">VIP</span>  </span><br><span class="line"><span class="selector-id">#-t</span> <span class="selector-tag">TCP</span>协议，<span class="selector-tag">ip</span><span class="selector-pseudo">:port</span>   </span><br><span class="line"><span class="selector-id">#-s</span> 指定算法为<span class="selector-tag">RR</span>轮询模式</span><br></pre></td></tr></table></figure><p>第三步：在虚拟集群10.10.10.101中，加入后端Realserver服务器</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.102</span> <span class="selector-tag">-m</span> <span class="selector-tag">-w</span> 50</span><br><span class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 172<span class="selector-class">.16</span><span class="selector-class">.1</span><span class="selector-class">.103</span> <span class="selector-tag">-m</span> <span class="selector-tag">-w</span> 50</span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">-a</span>，往虚拟服务器集群中添加真实服务器；</span><br><span class="line"># <span class="selector-tag">-t</span>，<span class="selector-tag">TCP</span>协议；</span><br><span class="line"># <span class="selector-tag">-r</span>，指定后端<span class="selector-tag">realserver</span>服务器的<span class="selector-tag">IP</span>和端口；</span><br><span class="line"># <span class="selector-tag">-m</span>，指定<span class="selector-tag">NAT</span>转发模式；</span><br><span class="line"># <span class="selector-tag">-w</span>，<span class="selector-tag">weight</span>权重设置；</span><br></pre></td></tr></table></figure><p>查看LVS信息</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# ipvsadm -L -n </span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.101:80 rr</span><br><span class="line">  -&gt; 172.16.1.102:80              Masq    50     0          0         </span><br><span class="line">  -&gt; 172.16.1.103:80              Masq    50     0          0</span><br></pre></td></tr></table></figure><p>第四步：LVS NAT模式能够实现数据转发，还要依靠Linux内核开启转发功能</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#临时生效</span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">#关闭icmp的重定向</span><br><span class="line">echo <span class="number">0</span> &gt; /proc/sys/net/ipv4/conf/all/send_redirects</span><br><span class="line">echo <span class="number">0</span> &gt; /proc/sys/net/ipv4/conf/default/send_redirects</span><br><span class="line">echo <span class="number">0</span> &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</span><br><span class="line">echo <span class="number">0</span> &gt; /proc/sys/net/ipv4/conf/eth1/send_redirects</span><br><span class="line"></span><br><span class="line">#永久生效</span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.eth0</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.eth1</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><p>第五步：测试</p><p>在inode4上访问10.0.0.101</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><p>在DR inode1上观察InAction发现是负载均衡</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.101:80 rr</span><br><span class="line">  -&gt; 172.16.1.102:80              Masq    50     0          3         </span><br><span class="line">  -&gt; 172.16.1.103:80              Masq    50     0          2</span><br></pre></td></tr></table></figure><p>注意：</p><p>在实验模式NAT时，要关闭RS服务器上的外网网卡，否则会因为RS上有外网路由的问题，造成VIP地址无法访问后端页面</p><h3 id="删除和添加RS"><a href="#删除和添加RS" class="headerlink" title="删除和添加RS"></a>删除和添加RS</h3><p>删除RS1（inode2）</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# ipvsadm -d -t 10.0.0.101:80 -r 172.16.1.102</span><br><span class="line"></span><br><span class="line">[root@inode1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.101:80 rr</span><br><span class="line">  -&gt; 172.16.1.103:80              Masq    50     0          7</span><br></pre></td></tr></table></figure><p>继续在inode4上访问VIP</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><p>RS1被删除后，客户端访问没有影响。</p><p>重新添加会RS1：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# ipvsadm -a -t 10.0.0.101:80 -r 172.16.1.102 -m -w 50</span><br><span class="line">[root@inode1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.101:80 rr</span><br><span class="line">  -&gt; 172.16.1.102:80              Masq    50     0          0         </span><br><span class="line">  -&gt; 172.16.1.103:80              Masq    50     0          0</span><br></pre></td></tr></table></figure><p>inode4上访问VIP：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@inode4 ~]# curl <span class="number">10.0</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">www.ywx1.com</span><br><span class="line">[root@inode4 ~]# curl <span class="number">10.0</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">www.ywx2.com</span><br><span class="line">[root@inode4 ~]# curl <span class="number">10.0</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">www.ywx1.com</span><br><span class="line">[root@inode4 ~]# curl <span class="number">10.0</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">www.ywx2.com</span><br><span class="line"></span><br><span class="line">在lvs <span class="number">10.0</span><span class="number">.0</span><span class="number">.101</span>上查看lvs连接</span><br><span class="line">[root@node1 ~]# cat /proc/net/ip_vs_conn</span><br><span class="line">Pro FromIP   FPrt ToIP     TPrt DestIP   DPrt State       Expires PEName PEData</span><br><span class="line">TCP <span class="number">0</span>A000068 B522 <span class="number">0</span>A000065 <span class="number">0050</span> ACA80167 <span class="number">0050</span> TIME_WAIT       <span class="number">116</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B51C <span class="number">0</span>A000065 <span class="number">0050</span> ACA80166 <span class="number">0050</span> TIME_WAIT       <span class="number">113</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B516 <span class="number">0</span>A000065 <span class="number">0050</span> ACA80167 <span class="number">0050</span> TIME_WAIT       <span class="number">110</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B51E <span class="number">0</span>A000065 <span class="number">0050</span> ACA80167 <span class="number">0050</span> TIME_WAIT       <span class="number">114</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B520 <span class="number">0</span>A000065 <span class="number">0050</span> ACA80166 <span class="number">0050</span> TIME_WAIT       <span class="number">115</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B51A <span class="number">0</span>A000065 <span class="number">0050</span> ACA80167 <span class="number">0050</span> TIME_WAIT       <span class="number">112</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B514 <span class="number">0</span>A000065 <span class="number">0050</span> ACA80166 <span class="number">0050</span> TIME_WAIT       <span class="number">109</span></span><br><span class="line">TCP <span class="number">0</span>A000068 B518 <span class="number">0</span>A000065 <span class="number">0050</span> ACA80166 <span class="number">0050</span> TIME_WAIT       <span class="number">111</span></span><br></pre></td></tr></table></figure><p>lvs自动均衡到2台服务器上。</p><p>我们关闭RS1(inode2)上的nginx服务：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@inode2</span> ~]<span class="meta"># nginx -s stop</span></span><br></pre></td></tr></table></figure><p>继续使用inode4上访问：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">curl</span>: (7) <span class="selector-tag">Failed</span> <span class="selector-tag">connect</span> <span class="selector-tag">to</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span>; <span class="selector-tag">Connection</span> <span class="selector-tag">refused</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">curl</span>: (7) <span class="selector-tag">Failed</span> <span class="selector-tag">connect</span> <span class="selector-tag">to</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span>; <span class="selector-tag">Connection</span> <span class="selector-tag">refused</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">curl</span>: (7) <span class="selector-tag">Failed</span> <span class="selector-tag">connect</span> <span class="selector-tag">to</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span>; <span class="selector-tag">Connection</span> <span class="selector-tag">refused</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">curl</span>: (7) <span class="selector-tag">Failed</span> <span class="selector-tag">connect</span> <span class="selector-tag">to</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span><span class="selector-pseudo">:80</span>; <span class="selector-tag">Connection</span> <span class="selector-tag">refused</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.101</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><p>一个访问正常，一个访问报错，因为LVS只是前端调度的功能，没有健康检查（下一篇文章会加入Keepalive来解决这个问题）。</p><h3 id="保存lvs规则"><a href="#保存lvs规则" class="headerlink" title="保存lvs规则"></a>保存lvs规则</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# ipvsadm -Sn &gt; /tmp/ipvsadm</span><br><span class="line">[root@node1 ~]# cat /tmp/ipvsadm</span><br><span class="line">-A -t <span class="number">10.0</span><span class="meta">.0</span><span class="meta">.101</span>:<span class="number">80</span> -s rr</span><br><span class="line">-a -t <span class="number">10.0</span><span class="meta">.0</span><span class="meta">.101</span>:<span class="number">80</span> -r <span class="number">172.168</span><span class="meta">.1</span><span class="meta">.102</span>:<span class="number">80</span> -m -w <span class="number">50</span></span><br><span class="line">-a -t <span class="number">10.0</span><span class="meta">.0</span><span class="meta">.101</span>:<span class="number">80</span> -r <span class="number">172.168</span><span class="meta">.1</span><span class="meta">.103</span>:<span class="number">80</span> -m -w <span class="number">50</span></span><br></pre></td></tr></table></figure><h3 id="清空lvs规则并重新导入"><a href="#清空lvs规则并重新导入" class="headerlink" title="清空lvs规则并重新导入"></a>清空lvs规则并重新导入</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#清空ipvsadm规程</span></span><br><span class="line">[root@node1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.101:80 rr</span><br><span class="line">  -&gt; 172.168.1.102:80             Masq    50     0          0         </span><br><span class="line">  -&gt; 172.168.1.103:80             Masq    50     0          0         </span><br><span class="line">[root@node1 ~]# ipvsadm -C</span><br><span class="line">[root@node1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新导入ipvsadm规则</span></span><br><span class="line">[root@node1 ~]# ipvsadm -R &lt; /tmp/ipvsadm </span><br><span class="line">[root@node1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.101:80 rr</span><br><span class="line">  -&gt; 172.168.1.102:80             Masq    50     0          0         </span><br><span class="line">  -&gt; 172.168.1.103:80             Masq    50     0          0</span><br></pre></td></tr></table></figure><h2 id="部署单网段LVS-DR"><a href="#部署单网段LVS-DR" class="headerlink" title="部署单网段LVS DR"></a>部署单网段LVS DR</h2><h3 id="LVS-DR模式注意事项"><a href="#LVS-DR模式注意事项" class="headerlink" title="LVS DR模式注意事项"></a>LVS DR模式注意事项</h3><p>LVS DR模式工作原理 用户请求LVS VIP到达director（LB均衡器），director将请求的报文的目标MAC地址改成后端的real server MAC地址，目标IP为VIP（不变），源IP为用户IP地址（保持不变），然后Director将报文发送到real server，real server检测到目标IP为自己本地VIP，如果在同一个网段，然后将请求直接返给用户。如果用户跟 real server不在一个网段，则通过网关返回用户。</p><p>DR模式注意事项</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>)LVS DR模式要求LVS和RS服务器同一个物理网段（二层网络）；</span><br><span class="line"><span class="number">2</span>）LVS修改数据报文的目标MAC地址，目标VIP保持不变；</span><br><span class="line"><span class="number">3</span>）LVS和RS服务器的网卡块数没有要求，单个网卡即可；</span><br><span class="line"><span class="number">4</span>）RS服务器配置VIP地址，只能配置在LO回环网卡上并且抑制VIP的ARP广播（防止跟其它主机配置的VIP冲突）；</span><br><span class="line"><span class="number">5</span>）LVS服务器需要配置VIP地址，配置在真实网卡设备上，保证真实网卡不能抑制VIP的ARP广播；</span><br><span class="line"><span class="number">6</span>）arp_ignore参数（<span class="number">1</span>）含义：只响应目标IP是本地真实网卡上配置的IP（对RS而言），只响应真实网卡（eth0、ens33等），不响应lo网卡上的VIP地址；</span><br><span class="line"><span class="number">7</span>）arp_announce参数（<span class="number">2</span>）含义：忽略报文的源IP地址，使用主机上能够跟用户通信的真实网卡发送数据（对RS而言），源地址为lo上的VIP地址则忽略，数据直接从真实网卡上发送。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DR模型中各主机上均需要配置VIP，解决地址冲突的方式有三种：</span><br><span class="line">(<span class="number">1</span>) 在前端网关做静态绑定</span><br><span class="line">(<span class="number">2</span>) 在各RS使用arptables</span><br><span class="line">(<span class="number">3</span>) 在各RS修改内核参数，来限制arp响应和通告的级别</span><br><span class="line"></span><br><span class="line">限制响应级别：arp_ignore</span><br><span class="line"><span class="number">0</span>：默认值，表示可使用本地任意接口上配置的任意地址进行响应</span><br><span class="line"><span class="number">1</span>：仅在请求的目标IP配置在本地主机的接收到请求报文的接口上时，才给予响应</span><br><span class="line"></span><br><span class="line">限制通告级别：arp_announce</span><br><span class="line"><span class="number">0</span>：默认值，把本机所有接口的所有信息向每个接口的网络进行通告</span><br><span class="line"><span class="number">1</span>：尽量避免将接口信息向非直接连接网络进行通告</span><br><span class="line"><span class="number">2</span>：必须避免将接口信息向非本网络进行通告</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置要点</span><br><span class="line"><span class="number">1.</span> Director 服务器采用双IP桥接网络，一个是VIP，一个DIP</span><br><span class="line"><span class="number">2.</span> Web服务器采用和DIP相同的网段和Director连接</span><br><span class="line"><span class="number">3.</span> 每个Web服务器配置VIP</span><br><span class="line"><span class="number">4.</span> 每个web服务器可以出外网</span><br></pre></td></tr></table></figure><h3 id="实验环境-1"><a href="#实验环境-1" class="headerlink" title="实验环境"></a>实验环境</h3><img src="/2023/108c14b9c0/image-20231020132224301.png"><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# uname -r</span><br><span class="line"><span class="number">3.10</span><span class="meta">.0</span>-<span class="number">862.</span>el7.x86_64</span><br><span class="line">[root@inode1 ~]# cat /etc/redhat-release </span><br><span class="line">CentOS Linux release <span class="number">7.5</span><span class="meta">.1804</span> (Core) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LVS inode1:<span class="number">10.0</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line">RS1 inode2:<span class="number">10.0</span><span class="meta">.0</span><span class="meta">.102</span> -----&gt; 页面 www.ywx1.com</span><br><span class="line">RS2 inode3:<span class="number">10.0</span><span class="meta">.0</span><span class="meta">.103</span> -----&gt; 页面 www.ywx2.com</span><br><span class="line">VIP <span class="number">10.0</span><span class="meta">.0</span><span class="meta">.111</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">client:</span><span class="number">172.168</span><span class="meta">.1</span><span class="meta">.104</span>  GW:<span class="number">172.168</span><span class="meta">.1</span><span class="meta">.105</span></span><br><span class="line"><span class="symbol">rouer:</span> <span class="number">172.168</span><span class="meta">.1</span><span class="meta">.105</span>   <span class="number">10.0</span><span class="meta">.0</span><span class="meta">.105</span></span><br></pre></td></tr></table></figure><h3 id="router和client部署及LVS-RS1-RS2的ip"><a href="#router和client部署及LVS-RS1-RS2的ip" class="headerlink" title="router和client部署及LVS RS1 RS2的ip"></a>router和client部署及LVS RS1 RS2的ip</h3><p>Router部署</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">echo 'net.ipv4.ip_forward=1' &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line">cd /etc/sysconfig/network-scripts/</span><br><span class="line">[root@node5 network-scripts]<span class="comment"># cat ifcfg-eth0</span></span><br><span class="line">TYPE=<span class="string">"Ethernet"</span></span><br><span class="line">PROXY_METHOD=<span class="string">"none"</span></span><br><span class="line">BROWSER_ONLY=<span class="string">"no"</span></span><br><span class="line">BOOTPROTO=<span class="string">"none"</span></span><br><span class="line">DEFROUTE=<span class="string">"yes"</span></span><br><span class="line">IPV4_FAILURE_FATAL=<span class="string">"no"</span></span><br><span class="line">NAME=<span class="string">"eth0"</span></span><br><span class="line">DEVICE=<span class="string">"eth0"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=<span class="string">"10.0.0.105"</span></span><br><span class="line">PREFIX=<span class="string">"24"</span></span><br><span class="line">GATEWAY=<span class="string">"10.0.0.254"</span></span><br><span class="line">DNS1=<span class="string">"223.5.5.5"</span></span><br><span class="line"></span><br><span class="line">[root@node5 network-scripts]<span class="comment"># cat ifcfg-eth1</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">NAME=eth1</span><br><span class="line">DEVICE=eth1</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=172.168.1.105</span><br><span class="line">PREFIX=24</span><br></pre></td></tr></table></figure><p>Client部署</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node4 ~]</span><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">PROXY_METHOD</span>=none</span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=none</span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">NAME</span>=eth1</span><br><span class="line"><span class="attr">DEVICE</span>=eth1</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">172.168</span>.<span class="number">1.104</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="number">24</span></span><br><span class="line"><span class="attr">GAREWAY</span>=<span class="number">172.168</span>.<span class="number">1.105</span></span><br></pre></td></tr></table></figure><p>LVS （node1） ip</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line">TYPE=<span class="string">"Ethernet"</span></span><br><span class="line">PROXY_METHOD=<span class="string">"none"</span></span><br><span class="line">BROWSER_ONLY=<span class="string">"no"</span></span><br><span class="line">BOOTPROTO<span class="string">"none"</span></span><br><span class="line">DEFROUTE=<span class="string">"yes"</span></span><br><span class="line">IPV4_FAILURE_FATAL=<span class="string">"no"</span></span><br><span class="line">NAME=<span class="string">"eth0"</span></span><br><span class="line">DEVICE=<span class="string">"eth0"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=<span class="string">"10.0.0.101"</span></span><br><span class="line">PREFIX=<span class="string">"24"</span></span><br><span class="line">GATEWAY=<span class="string">"10.0.0.105"</span></span><br><span class="line">DNS1=<span class="string">"223.5.5.5"</span></span><br></pre></td></tr></table></figure><p>RS1 （node2） ip</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node2 network-scripts]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="attr">TYPE</span>=<span class="string">"Ethernet"</span></span><br><span class="line"><span class="attr">PROXY_METHOD</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">NAME</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">DEVICE</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="string">"10.0.0.102"</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="string">"24"</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="string">"10.0.0.105"</span></span><br><span class="line"><span class="attr">DNS1</span>=<span class="string">"223.5.5.5"</span></span><br></pre></td></tr></table></figure><p>RS2 （node3 ）ip</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node3 network-scripts]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="attr">TYPE</span>=<span class="string">"Ethernet"</span></span><br><span class="line"><span class="attr">PROXY_METHOD</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">NAME</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">DEVICE</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="string">"10.0.0.103"</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="string">"24"</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="string">"10.0.0.105"</span></span><br><span class="line"><span class="attr">DNS1</span>=<span class="string">"223.5.5.5"</span></span><br></pre></td></tr></table></figure><h3 id="部署RS1和RS2的nginx-1"><a href="#部署RS1和RS2的nginx-1" class="headerlink" title="部署RS1和RS2的nginx"></a>部署RS1和RS2的nginx</h3><p>这里已经部署好了：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode2 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.102</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@inode3 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.103</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><h3 id="部署LVS"><a href="#部署LVS" class="headerlink" title="部署LVS"></a>部署LVS</h3><p>第一步：安装LVS</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y ipvsadm</span><br></pre></td></tr></table></figure><p>第二步：把10.0.0.111作为VIP，加入lvs集群</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-A</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span> <span class="selector-tag">-s</span> <span class="selector-tag">rr</span></span><br></pre></td></tr></table></figure><p>第三步：把RS1 inode2和RS2 inode3加入lvs集群</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.102</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-g</span> <span class="selector-tag">-w</span> 50</span><br><span class="line"><span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.103</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-g</span> <span class="selector-tag">-w</span> 50</span><br></pre></td></tr></table></figure><p>查看ipvsadm</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.111:80 rr</span><br><span class="line">  -&gt; 10.0.0.102:80               <span class="built_in"> Route </span>  50     0          0         </span><br><span class="line">  -&gt; 10.0.0.103:80               <span class="built_in"> Route </span>  50     0          0</span><br></pre></td></tr></table></figure><p>第四步：DR （inode1） 上绑定VIP地址</p><p>方法一：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# ifconfig eth0:0 10.0.0.111 netmask 255.255.255.255 broadcast 10.0.0.111</span><br><span class="line">[root@node1 ~]# /sbin<span class="built_in">/route </span> <span class="builtin-name">add</span>  -host  10.0.0.111  dev  eth0:0</span><br></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node1 ~]</span><span class="comment"># cd /etc/sysconfig/network-scripts/</span></span><br><span class="line"><span class="section">[root@node1 ~]</span><span class="comment"># cp ifcfg-eth0 ifcfg-eth0:0</span></span><br><span class="line"><span class="section">[root@node1 ~]</span><span class="comment"># vim ifcfg-eth0:0</span></span><br><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">BOOTPROTO</span>=static</span><br><span class="line"><span class="attr">DEVICE</span>=eth0:<span class="number">0</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">10.0</span>.<span class="number">0.111</span></span><br><span class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">255.255</span></span><br></pre></td></tr></table></figure><p>第五步：RS1 （inode2）和RS2 （inode3）绑定VIP地址</p><p>方法一：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# ifconfig lo:0 10.0.0.111 netmask 255.255.255.255 broadcast 10.0.0.111</span><br><span class="line"> [root@node2 ~]# /sbin<span class="built_in">/route </span> <span class="builtin-name">add</span>  -host  10.0.0.111 dev  lo:0</span><br></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node2 ~]</span><span class="comment"># cd /etc/sysconfig/network-scripts/</span></span><br><span class="line"><span class="section">[root@node2 ~]</span><span class="comment"># cp ifcfg-lo ifcfg-lo:0</span></span><br><span class="line"><span class="section">[root@node2 ~]</span><span class="comment"># vim ifcfg-lo:0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DEVICE</span>=lo:<span class="number">0</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">10.0</span>.<span class="number">0.111</span></span><br><span class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">255.255</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">NAME</span>=loopback</span><br></pre></td></tr></table></figure><p>第六步：在RS1 （inode2）和RS2 （inode3）上配置arp抑制</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]#echo <span class="string">"1"</span> &gt;/proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/lo/arp_ignore</span><br><span class="line">[root@node2 ~]#echo <span class="string">"2"</span> &gt;/proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/lo/arp_announce</span><br><span class="line">[root@node2 ~]#echo <span class="string">"1"</span> &gt;/proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/all/arp_ignore</span><br><span class="line">[root@node2 ~]#echo <span class="string">"2"</span> &gt;/proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/all/arp_announce</span><br><span class="line">[root@node2 ~]#sysctl -p </span><br><span class="line">[root@node2 ~]#<span class="keyword">cat</span> /proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/lo/arp_ignore</span><br><span class="line">[root@node2 ~]#<span class="keyword">cat</span> /proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/lo/arp_announce</span><br><span class="line">[root@node2 ~]#<span class="keyword">cat</span> /proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/all/arp_ignore</span><br><span class="line">[root@node2 ~]#<span class="keyword">cat</span> /proc/sys/<span class="keyword">net</span>/ipv4/<span class="keyword">conf</span>/all/arp_announce</span><br></pre></td></tr></table></figure><p>第七步：测试</p><p>在inode4上访问VIP</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@inode4 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.111</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><h2 id="部署多网段LVS-DR"><a href="#部署多网段LVS-DR" class="headerlink" title="部署多网段LVS DR"></a>部署多网段LVS DR</h2><img src="/2023/108c14b9c0/image-20231020132955005.png"><p>多网段LVS DR是vip与RIP不在同一个网段</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# uname -r</span><br><span class="line"><span class="number">3.10</span><span class="meta">.0</span>-<span class="number">862.</span>el7.x86_64</span><br><span class="line">[root@inode1 ~]# cat /etc/redhat-release </span><br><span class="line">CentOS Linux release <span class="number">7.5</span><span class="meta">.1804</span> (Core) </span><br><span class="line"></span><br><span class="line">LVS inode1:<span class="number">10.0</span><span class="meta">.0</span><span class="meta">.101</span></span><br><span class="line">RS1 inode2:<span class="number">10.0</span><span class="meta">.0</span><span class="meta">.102</span> -----&gt; 页面 www.ywx1.com</span><br><span class="line">RS2 inode3:<span class="number">10.0</span><span class="meta">.0</span><span class="meta">.103</span> -----&gt; 页面 www.ywx2.com</span><br><span class="line">VIP <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.100</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">client:</span><span class="number">172.168</span><span class="meta">.1</span><span class="meta">.104</span>  GW:<span class="number">172.168</span><span class="meta">.1</span><span class="meta">.105</span></span><br><span class="line"><span class="symbol">rouer:</span> <span class="number">172.168</span><span class="meta">.1</span><span class="meta">.105</span>   <span class="number">10.0</span><span class="meta">.0</span><span class="meta">.105</span>  <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.200</span>(与vip通信使用)</span><br></pre></td></tr></table></figure><h3 id="router和client部署及LVS-RS1-RS2的ip-1"><a href="#router和client部署及LVS-RS1-RS2的ip-1" class="headerlink" title="router和client部署及LVS RS1 RS2的ip"></a>router和client部署及LVS RS1 RS2的ip</h3><p>Router部署</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@node5 network-scripts]<span class="comment">#echo 'net.ipv4.ip_forward=1' &gt;&gt; /etc/sysctl.conf</span></span><br><span class="line">[root@node5 network-scripts]<span class="comment">#sysctl -p</span></span><br><span class="line">[root@node5 network-scripts]<span class="comment">#cd /etc/sysconfig/network-scripts/</span></span><br><span class="line">[root@node5 network-scripts]<span class="comment"># cat ifcfg-eth0</span></span><br><span class="line">TYPE=<span class="string">"Ethernet"</span></span><br><span class="line">PROXY_METHOD=<span class="string">"none"</span></span><br><span class="line">BROWSER_ONLY=<span class="string">"no"</span></span><br><span class="line">BOOTPROTO=<span class="string">"none"</span></span><br><span class="line">DEFROUTE=<span class="string">"yes"</span></span><br><span class="line">IPV4_FAILURE_FATAL=<span class="string">"no"</span></span><br><span class="line">NAME=<span class="string">"eth0"</span></span><br><span class="line">DEVICE=<span class="string">"eth0"</span></span><br><span class="line">ONBOOT=<span class="string">"yes"</span></span><br><span class="line">IPADDR=<span class="string">"10.0.0.105"</span></span><br><span class="line">PREFIX=<span class="string">"24"</span></span><br><span class="line">GATEWAY=<span class="string">"10.0.0.254"</span></span><br><span class="line">DNS1=<span class="string">"223.5.5.5"</span></span><br><span class="line"></span><br><span class="line">[root@node5 network-scripts]<span class="comment"># cat ifcfg-eth1</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">NAME=eth1</span><br><span class="line">DEVICE=eth1</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=172.168.1.105</span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line"><span class="comment">#在eth0:0上配置192.168.1.200</span></span><br><span class="line">[root@node5 network-scripts]<span class="comment">#ifconfig eth0:0 192.168.1.200 netmask 255.255.255.0 broadcast 192.168.1.200</span></span><br><span class="line">[root@node5 network-scripts]<span class="comment">#/sbin/route  add  -host  192.168.1.200 dev  eth0:0</span></span><br><span class="line"> </span><br><span class="line"> [root@node5 ~]<span class="comment"># ip a</span></span><br><span class="line"><span class="section">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span></span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="section">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></span><br><span class="line">    link/ether 00:0c:29:f5:01:8d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.105/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.200/32 brd 192.168.1.200 scope global eth0:0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fef5:18d/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="section">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span></span><br><span class="line">    link/ether 00:0c:29:f5:01:97 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.168.1.105/24 brd 172.168.1.255 scope global noprefixroute eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fef5:197/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>Client部署</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node4 ~]</span><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line"><span class="attr">TYPE</span>=Ethernet</span><br><span class="line"><span class="attr">PROXY_METHOD</span>=none</span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=none</span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">NAME</span>=eth1</span><br><span class="line"><span class="attr">DEVICE</span>=eth1</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">172.168</span>.<span class="number">1.104</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="number">24</span></span><br><span class="line"><span class="attr">GAREWAY</span>=<span class="number">172.168</span>.<span class="number">1.105</span></span><br></pre></td></tr></table></figure><p>LVS （node1） ip</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node1 ~]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="attr">TYPE</span>=<span class="string">"Ethernet"</span></span><br><span class="line"><span class="attr">PROXY_METHOD</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">NAME</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">DEVICE</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="string">"10.0.0.101"</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="string">"24"</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="string">"10.0.0.105"</span></span><br><span class="line"><span class="attr">DNS1</span>=<span class="string">"223.5.5.5"</span></span><br></pre></td></tr></table></figure><p>RS1 （node2） ip</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node2 network-scripts]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="attr">TYPE</span>=<span class="string">"Ethernet"</span></span><br><span class="line"><span class="attr">PROXY_METHOD</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">NAME</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">DEVICE</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="string">"10.0.0.102"</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="string">"24"</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="string">"10.0.0.105"</span></span><br><span class="line"><span class="attr">DNS1</span>=<span class="string">"223.5.5.5"</span></span><br></pre></td></tr></table></figure><p>RS2（ node3） ip</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@node3 network-scripts]</span><span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line"><span class="attr">TYPE</span>=<span class="string">"Ethernet"</span></span><br><span class="line"><span class="attr">PROXY_METHOD</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">BROWSER_ONLY</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">BOOTPROTO</span>=<span class="string">"none"</span></span><br><span class="line"><span class="attr">DEFROUTE</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPV4_FAILURE_FATAL</span>=<span class="string">"no"</span></span><br><span class="line"><span class="attr">NAME</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">DEVICE</span>=<span class="string">"eth0"</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="string">"yes"</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="string">"10.0.0.103"</span></span><br><span class="line"><span class="attr">PREFIX</span>=<span class="string">"24"</span></span><br><span class="line"><span class="attr">GATEWAY</span>=<span class="string">"10.0.0.105"</span></span><br><span class="line"><span class="attr">DNS1</span>=<span class="string">"223.5.5.5"</span></span><br></pre></td></tr></table></figure><h3 id="RS1和RS2部署nginx"><a href="#RS1和RS2部署nginx" class="headerlink" title="RS1和RS2部署nginx"></a>RS1和RS2部署nginx</h3><p>这里已经部署好了：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode2 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.102</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@inode3 ~]</span># <span class="selector-tag">curl</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.103</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><h3 id="DR-（inode1-）上绑定VIP地址"><a href="#DR-（inode1-）上绑定VIP地址" class="headerlink" title="DR （inode1 ）上绑定VIP地址"></a>DR （inode1 ）上绑定VIP地址</h3><p>方法一：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@inode1 ~]# ifconfig lo:1 192.168.1.100 netmask 255.255.255.255 broadcast 192.168.1.100</span><br><span class="line">[root@inode1 ~]# /sbin<span class="built_in">/route </span> <span class="builtin-name">add</span>  -host  192.168.1.100  dev  lo:1</span><br></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@inode1 ~]</span><span class="comment"># cd /etc/sysconfig/network-scripts/</span></span><br><span class="line"><span class="section">[root@inode1 ~]</span><span class="comment"># cp ifcfg-lo ifcfg-lo:1</span></span><br><span class="line"><span class="section">[root@inode1 ~]</span><span class="comment"># vim ifcfg-lo:1</span></span><br><span class="line"><span class="attr">DEVICE</span>=lo:<span class="number">1</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">192.168</span>.<span class="number">1.100</span></span><br><span class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">255.255</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">NAME</span>=loopback</span><br></pre></td></tr></table></figure><h3 id="RS1-（inode2）和RS2-（inode3）上绑定VIP地址"><a href="#RS1-（inode2）和RS2-（inode3）上绑定VIP地址" class="headerlink" title="RS1 （inode2）和RS2 （inode3）上绑定VIP地址"></a>RS1 （inode2）和RS2 （inode3）上绑定VIP地址</h3><p>方法一：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@inode2 ~]# ifconfig lo:1 192.168.1.100 netmask 255.255.255.255 broadcast 192.168.1.100</span><br><span class="line">[root@inode2 ~]# /sbin<span class="built_in">/route </span> <span class="builtin-name">add</span>  -host  192.168.1.100 dev  lo:1</span><br></pre></td></tr></table></figure><p>方法二：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@inode2 ~]</span><span class="comment"># cd /etc/sysconfig/network-scripts/</span></span><br><span class="line"><span class="section">[root@inode2 ~]</span><span class="comment"># cp ifcfg-lo ifcfg-lo:1</span></span><br><span class="line"><span class="section">[root@inode2 ~]</span><span class="comment"># vim ifcfg-lo:1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DEVICE</span>=lo:<span class="number">1</span></span><br><span class="line"><span class="attr">IPADDR</span>=<span class="number">192.168</span>.<span class="number">1.100</span></span><br><span class="line"><span class="attr">NETMASK</span>=<span class="number">255.255</span>.<span class="number">255.255</span></span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">NAME</span>=loopback2</span><br></pre></td></tr></table></figure><h3 id="RS1-（inode2）和RS2-（inode3）上配置arp抑制"><a href="#RS1-（inode2）和RS2-（inode3）上配置arp抑制" class="headerlink" title="RS1 （inode2）和RS2 （inode3）上配置arp抑制"></a>RS1 （inode2）和RS2 （inode3）上配置arp抑制</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@inode2 ~]# <span class="keyword">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">lo</span>/arp_ignore</span><br><span class="line">[root@inode2 ~]# <span class="keyword">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">lo</span>/arp_announce</span><br><span class="line">[root@inode2 ~]# <span class="keyword">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">all</span>/arp_ignore</span><br><span class="line">[root@inode2 ~]# <span class="keyword">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">all</span>/arp_announce</span><br><span class="line">[root@inode2 ~]# sysctl -<span class="keyword">p</span> </span><br><span class="line">[root@inode2 ~]# <span class="keyword">cat</span> /proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">lo</span>/arp_ignore</span><br><span class="line">[root@inode2 ~]# <span class="keyword">cat</span> /proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">lo</span>/arp_announce</span><br><span class="line">[root@inode2 ~]# <span class="keyword">cat</span> /proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">all</span>/arp_ignore</span><br><span class="line">[root@inode2 ~]# <span class="keyword">cat</span> /proc/sys/net/ipv4/<span class="keyword">conf</span>/<span class="keyword">all</span>/arp_announce</span><br></pre></td></tr></table></figure><h3 id="在DR（inode1）上部署LVS"><a href="#在DR（inode1）上部署LVS" class="headerlink" title="在DR（inode1）上部署LVS"></a>在DR（inode1）上部署LVS</h3><p>第一步：安装LVS</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@inode1</span> ~]<span class="meta"># yum install -y ipvsadm</span></span><br></pre></td></tr></table></figure><p>第二步：把192.168.1.100作为VIP，加入lvs集群</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode1 ~]</span># <span class="selector-tag">ipvsadm</span> <span class="selector-tag">-A</span> <span class="selector-tag">-t</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span> <span class="selector-tag">-s</span> <span class="selector-tag">rr</span></span><br></pre></td></tr></table></figure><p>第三步：把RS1 inode2和RS2 inode3加入lvs集群</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@inode1 ~]</span># <span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.102</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-g</span> <span class="selector-tag">-w</span> 50</span><br><span class="line"><span class="selector-attr">[root@inode1 ~]</span># <span class="selector-tag">ipvsadm</span> <span class="selector-tag">-a</span> <span class="selector-tag">-t</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-r</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.103</span><span class="selector-pseudo">:80</span> <span class="selector-tag">-g</span> <span class="selector-tag">-w</span> 50</span><br></pre></td></tr></table></figure><p>查看ipvsadm</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.1.100:80 rr</span><br><span class="line">  -&gt; 10.0.0.102:80               <span class="built_in"> Route </span>  50     0          0         </span><br><span class="line">  -&gt; 10.0.0.103:80               <span class="built_in"> Route </span>  50     0          0     </span><br><span class="line">1234567</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@node4 ~]</span># <span class="selector-tag">curl</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@node4 ~]</span># <span class="selector-tag">curl</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@node4 ~]</span># <span class="selector-tag">curl</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx2</span><span class="selector-class">.com</span></span><br><span class="line"><span class="selector-attr">[root@node4 ~]</span># <span class="selector-tag">curl</span> 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.100</span></span><br><span class="line"><span class="selector-tag">www</span><span class="selector-class">.ywx1</span><span class="selector-class">.com</span></span><br></pre></td></tr></table></figure><h3 id="lvs-dr脚本"><a href="#lvs-dr脚本" class="headerlink" title="lvs_dr脚本"></a>lvs_dr脚本</h3><p><strong>lvs_dr_vs.sh：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=<span class="string">'192.168.1.100'</span></span><br><span class="line">iface=<span class="string">'lo:1'</span></span><br><span class="line">mask=<span class="string">'255.255.255.255'</span></span><br><span class="line">port=<span class="string">'80'</span></span><br><span class="line">rs1=<span class="string">'10.0.0.102'</span></span><br><span class="line">rs2=<span class="string">'10.0.0.103'</span></span><br><span class="line">scheduler=<span class="string">'wrr'</span></span><br><span class="line"><span class="built_in">type</span>=<span class="string">'-g'</span></span><br><span class="line">rpm -q ipvsadm &amp;&gt; /dev/null || yum -y install ipvsadm &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">ifconfig <span class="variable">$iface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">iptables -F</span><br><span class="line">ipvsadm -A -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -s <span class="variable">$scheduler</span></span><br><span class="line">ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs1&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs2&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"The VS Server is Ready!"</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">ipvsadm -C</span><br><span class="line">ifconfig <span class="variable">$iface</span> down</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"The VS Server is Canceled!"</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$(basename $0)</span> start|stop"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p><strong>lvs_dr_rs：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=192.168.1.100</span><br><span class="line">mask=<span class="string">'255.255.255.255'</span></span><br><span class="line">dev=lo:1</span><br><span class="line"><span class="comment">#rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span></span><br><span class="line"><span class="comment">#service httpd start &amp;&gt; /dev/null &amp;&amp; echo "The httpd Server is Ready!"</span></span><br><span class="line"><span class="comment">#echo "`hostname -I`" &gt; /var/www/html/index.html</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"The RS Server is Ready!"</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">ifconfig <span class="variable">$dev</span> down</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"The RS Server is Canceled!"</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$(basename $0)</span> start|stop"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure></div><div><div id="reward-container"><div>Thank you for your accept. mua！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/reward/wechatpay.png" alt="丨逸贤丨 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/reward/alipay.png" alt="丨逸贤丨 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>丨逸贤丨</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://yixian12580.github.io/2023/108c14b9c0.html" title="LVS的安装部署">https://yixian12580.github.io/2023/108c14b9c0.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:16px">-------------本文结束<i class="fa fa-heart"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/LVS/" rel="tag"><i class="fa fa-tag"></i> LVS</a> <a href="/tags/负责均衡/" rel="tag"><i class="fa fa-tag"></i> 负责均衡</a></div><div class="post-widgets"><div class="social_share"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2023/1036d363c3.html" rel="next" title="LVS详解"><i class="fa fa-chevron-left"></i> LVS详解</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2023/10d48c1061.html" rel="prev" title="LVS+KeepAlived高可用部署实战应用">LVS+KeepAlived高可用部署实战应用 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div><div style="text-align:center"><a href="https://github.com/yixian12580/blog-source/edit/main/source/_posts/LVS的安装部署.md" target="_blank">编辑文章✏</a></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC81NzIwNy8zMzY3MQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="丨逸贤丨"><p class="site-author-name" itemprop="name">丨逸贤丨</p><div class="site-description motion-element" itemprop="description">三十年众生牛马，搏十年丰功伟绩。</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">144</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">131</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/yixian12580" title="GitHub &rarr; https://github.com/yixian12580" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1083662409@qq.com" title="E-Mail &rarr; mailto:1083662409@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://weibo.com/u/5107819265" title="Weibo &rarr; https://weibo.com/u/5107819265" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="tencent://message/?uin=1083662409&Site=&menu=yes" title="QQ &rarr; tencent://message/?uin=1083662409&Site=&menu=yes" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-book"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://www.ttlsa.com/" title="http://www.ttlsa.com/" rel="noopener" target="_blank">运维生存时间</a></li><li class="links-of-blogroll-item"><a href="https://www.iyunw.cn" title="https://www.iyunw.cn" rel="noopener" target="_blank">爱运维</a></li><li class="links-of-blogroll-item"><a href="https://nginxconfig.io/" title="https://nginxconfig.io/" rel="noopener" target="_blank">Nginxconfig</a></li><li class="links-of-blogroll-item"><a href="http://linux.51yip.com/" title="http://linux.51yip.com/" rel="noopener" target="_blank">Linux命令手册</a></li><li class="links-of-blogroll-item"><a href="https://echarts.apache.org/index.html" title="https://echarts.apache.org/index.html" rel="noopener" target="_blank">echarts可视化库</a></li><li class="links-of-blogroll-item"><a href="https://yixian12580.netlify.app/admin/" title="https://yixian12580.netlify.app/admin/" rel="noopener" target="_blank">博客管理</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#LVS的安装"><span class="nav-number">1.</span> <span class="nav-text">LVS的安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#yum安装"><span class="nav-number">1.1.</span> <span class="nav-text">yum安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码包安装"><span class="nav-number">1.2.</span> <span class="nav-text">源码包安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ipvsadm命令详解"><span class="nav-number">2.</span> <span class="nav-text">ipvsadm命令详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-相关软件"><span class="nav-number">2.1.</span> <span class="nav-text">LVS 相关软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ipvsadm-命令"><span class="nav-number">2.2.</span> <span class="nav-text">ipvsadm 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ipvsadm-工具用法："><span class="nav-number">2.3.</span> <span class="nav-text">ipvsadm 工具用法：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防火墙标记"><span class="nav-number">2.4.</span> <span class="nav-text">防火墙标记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-持久连接"><span class="nav-number">2.5.</span> <span class="nav-text">LVS 持久连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署LVS-NAT"><span class="nav-number">3.</span> <span class="nav-text">部署LVS NAT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-NAT模式注意事项"><span class="nav-number">3.1.</span> <span class="nav-text">LVS NAT模式注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验环境"><span class="nav-number">3.2.</span> <span class="nav-text">实验环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署RS1和RS2的nginx"><span class="nav-number">3.3.</span> <span class="nav-text">部署RS1和RS2的nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将RS1和RS2的网关配置为DR的内网ip地址：172-16-1-101"><span class="nav-number">3.4.</span> <span class="nav-text">将RS1和RS2的网关配置为DR的内网ip地址：172.16.1.101</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署NAT的LVS"><span class="nav-number">3.5.</span> <span class="nav-text">部署NAT的LVS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除和添加RS"><span class="nav-number">3.6.</span> <span class="nav-text">删除和添加RS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#保存lvs规则"><span class="nav-number">3.7.</span> <span class="nav-text">保存lvs规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#清空lvs规则并重新导入"><span class="nav-number">3.8.</span> <span class="nav-text">清空lvs规则并重新导入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署单网段LVS-DR"><span class="nav-number">4.</span> <span class="nav-text">部署单网段LVS DR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-DR模式注意事项"><span class="nav-number">4.1.</span> <span class="nav-text">LVS DR模式注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验环境-1"><span class="nav-number">4.2.</span> <span class="nav-text">实验环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#router和client部署及LVS-RS1-RS2的ip"><span class="nav-number">4.3.</span> <span class="nav-text">router和client部署及LVS RS1 RS2的ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署RS1和RS2的nginx-1"><span class="nav-number">4.4.</span> <span class="nav-text">部署RS1和RS2的nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署LVS"><span class="nav-number">4.5.</span> <span class="nav-text">部署LVS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署多网段LVS-DR"><span class="nav-number">5.</span> <span class="nav-text">部署多网段LVS DR</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#router和client部署及LVS-RS1-RS2的ip-1"><span class="nav-number">5.1.</span> <span class="nav-text">router和client部署及LVS RS1 RS2的ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RS1和RS2部署nginx"><span class="nav-number">5.2.</span> <span class="nav-text">RS1和RS2部署nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DR-（inode1-）上绑定VIP地址"><span class="nav-number">5.3.</span> <span class="nav-text">DR （inode1 ）上绑定VIP地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RS1-（inode2）和RS2-（inode3）上绑定VIP地址"><span class="nav-number">5.4.</span> <span class="nav-text">RS1 （inode2）和RS2 （inode3）上绑定VIP地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RS1-（inode2）和RS2-（inode3）上配置arp抑制"><span class="nav-number">5.5.</span> <span class="nav-text">RS1 （inode2）和RS2 （inode3）上配置arp抑制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在DR（inode1）上部署LVS"><span class="nav-number">5.6.</span> <span class="nav-text">在DR（inode1）上部署LVS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">5.7.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lvs-dr脚本"><span class="nav-number">5.8.</span> <span class="nav-text">lvs_dr脚本</span></a></li></ol></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><style>.aplayer .aplayer-lrc{height:35px}.aplayer .aplayer-lrc p{font-size:16px;font-weight:700;line-height:19.2px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{color:#ff1493}.aplayer.aplayer-narrow .aplayer-body{left:-66px!important}</style><div class="aplayer" data-id="7622186670" data-server="netease" data-type="playlist" data-fixed="true" data-order="random" data-autoplay="false"></div><script src="/dist/Meting.min.js"></script></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright" style="text-align:center">&copy; 2022 – <span itemprop="copyrightYear">2025</span> <span class="with-love" id="animate"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">逸贤</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart">站点字数合计:</i> </span><span title="站点总字数">1m</span></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="run_time" style="text-align:center"><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("09/08/2022 10:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script></div><div class="busuanzi-count" style="text-align:center"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/js/utils.js?v=7.1.1"></script><script src="/js/motion.js?v=7.1.1"></script><script src="/js/schemes/muse.js?v=7.1.1"></script><script src="/js/scrollspy.js?v=7.1.1"></script><script src="/js/post-details.js?v=7.1.1"></script><script src="/js/next-boot.js?v=7.1.1"></script><script>window.livereOptions={refer:"2023/108c14b9c0.html"},function(e,t){var n,r=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,r.parentNode.insertBefore(n,r))}(document,"script")</script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions)</script><script src="/lib/bookmark/bookmark.min.js?v=1.0"></script><script>bookmark.scrollToMark("auto","#更多")</script><script>$(".highlight").not(".gist .highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=e,document.body.appendChild(n),n.select(),n.setSelectionRange(0,e.length),n.readOnly=!1,document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script></body></html><script type="text/javascript" src="/js/src/clicklove.js"></script><script type="text/javascript" src="/js/click_show_text.js"></script><script type="text/javascript" src="/js/FunnyTitle.js"></script><script src="/live2d-widget/autoload.js"></script>