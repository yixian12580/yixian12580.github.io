<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script></script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1"><link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"7.1.1",sidebar:{position:"left",display:"post",offset:12,onmobile:!0,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!0,fastclick:!0,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"shrinkIn",post_header:"slideLeftIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideDownIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,c,a,i,n){e.DaoVoiceObject=a,e[a]=e[a]||function(){(e[a].q=e[a].q||[]).push(arguments)},e[a].l=+new Date,i=t.createElement(o),n=t.getElementsByTagName(o)[0],i.async=1,i.src=c,i.charset="utf-8",n.parentNode.insertBefore(i,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"aac7f9b5"}),daovoice("update")</script><meta name="description" content="在k8s中配置启用了istio之后，在创建pod之后会自动注入一个Envoy这样的容器，可理解为代理容器，也就是说，创建pod是除了定义的一个主容器，还会在启动istio之后自动注入一个容器，一个pod有两个容器，该代理容器主要是用来做流量的控制和管理，能做到流量的拦截，能控制熔断、超时、重试，按流量的百分比代理等作用。"><meta name="keywords" content="服务网格,Istio,灰度发布,熔断,超时,故障注入,重试"><meta property="og:type" content="article"><meta property="og:title" content="服务网格Istio安装及使用"><meta property="og:url" content="https://yixian12580.github.io/2025/098b941b9d.html"><meta property="og:site_name" content="逸贤 | Blog"><meta property="og:description" content="在k8s中配置启用了istio之后，在创建pod之后会自动注入一个Envoy这样的容器，可理解为代理容器，也就是说，创建pod是除了定义的一个主容器，还会在启动istio之后自动注入一个容器，一个pod有两个容器，该代理容器主要是用来做流量的控制和管理，能做到流量的拦截，能控制熔断、超时、重试，按流量的百分比代理等作用。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20251217165631321.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20251217170457434.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20251217184028480.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912171713638.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912171849139.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912174418993.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912175105040.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912180412249.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912180748969.png"><meta property="og:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20250912181138747.png"><meta property="og:updated_time" content="2025-12-17T10:40:59.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="服务网格Istio安装及使用"><meta name="twitter:description" content="在k8s中配置启用了istio之后，在创建pod之后会自动注入一个Envoy这样的容器，可理解为代理容器，也就是说，创建pod是除了定义的一个主容器，还会在启动istio之后自动注入一个容器，一个pod有两个容器，该代理容器主要是用来做流量的控制和管理，能做到流量的拦截，能控制熔断、超时、重试，按流量的百分比代理等作用。"><meta name="twitter:image" content="https://yixian12580.github.io/2025/098b941b9d/image-20251217165631321.png"><link rel="alternate" href="/atom.xml" title="逸贤 | Blog" type="application/atom+xml"><link rel="canonical" href="https://yixian12580.github.io/2025/098b941b9d"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>服务网格Istio安装及使用 | 逸贤 | Blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">逸贤 | Blog</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-bookmark"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-互动"><a href="/guestbook/" rel="section"><i class="menu-item-icon fa fa-fw fa-comments"></i><br>互动</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://yixian12580.github.io/2025/098b941b9d.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="丨逸贤丨"><meta itemprop="description" content="三十年众生牛马，搏十年丰功伟绩。"><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="逸贤 | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">服务网格Istio安装及使用</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-09-12 20:40:09" itemprop="dateCreated datePublished" datetime="2025-09-12T20:40:09+08:00">2025-09-12</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-12-17 18:40:59" itemprop="dateModified" datetime="2025-12-17T18:40:59+08:00">2025-12-17</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/" itemprop="url" rel="index"><span itemprop="name">技术</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数： <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">40k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">37 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>在k8s中配置启用了istio之后，在创建pod之后会自动注入一个Envoy这样的容器，可理解为代理容器，也就是说，创建pod是除了定义的一个主容器，还会在启动istio之后自动注入一个容器，一个pod有两个容器，该代理容器主要是用来做流量的控制和管理，能做到流量的拦截，能控制熔断、超时、重试，按流量的百分比代理等作用。</p><a id="more"></a><h2 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h2><h3 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h3><p>当在 K8s集群中使用 Istio 时，可以通过 Istio 提供的熔断功能来增加微服务架构的稳定性和可靠性。</p><p>熔断是一种故障保护机制，用于在服务之间的通信中防止故障扩散，并提供更好的容错能力。</p><p>在微服务架构中，一个应用通常由许多小型的、相互协作的服务组成。当某个服务发生故障或变得不可用时，如果不采取措施，可能会导致连锁反应，影响到整个系统的可用性。</p><p>熔断机制旨在解决这个问题，其核心思想是在服务之间设置阈值和超时时间，并对请求进行监控。当服务的错误率或响应时间超过预设的阈值时，熔断器会打开，拒绝向该服务发送更多请求，并快速失败返回错误，而不是等待超时。</p><p>应用场景如下：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">1.快速失败返回:</span></span><br><span class="line">当目标服务不可用时，不再尝试等待请求超时，而是快速返回错误，从而避免资源浪费和潜在的长时间等待。</span><br><span class="line"></span><br><span class="line"><span class="section">2.故障隔离:</span></span><br><span class="line">熔断机制阻止故障扩散，使问题局限在出现故障的服务，而不会影响到整个应用程序。</span><br><span class="line"></span><br><span class="line"><span class="section">3.恢复机制:</span></span><br><span class="line">熔断器会定期尝试发起一些请求到目标服务，以检查其是否已经恢复。如果服务恢复正常，则熔断器会逐渐关闭，允许流量再次流向目标服务。</span><br><span class="line"></span><br><span class="line"><span class="section">4.自动重试:</span></span><br><span class="line">一旦目标服务恢复，熔断器会逐渐允许一部分流量通过，如果没有再次出现问题，会逐渐恢复到正常状态，否则继续保持熔断状态。</span><br></pre></td></tr></table></figure><h3 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h3><p>在 K8s集群中结合 Istio，可以使用 Istio 的流量管理功能来控制服务之间的请求超时。</p><p>超时是指在一定时间内，如果某个请求没有得到及时响应，就会被认为是超时。</p><p>通过设置请求超时时间，可以对服务之间的通信进行控制，确保请求在合理的时间内得到响应，避免请求无限期地等待导致资源浪费或影响整体系统的响应性能。</p><p>Istio 的超时控制允许你为每个服务之间的请求设置最大的等待时间。</p><p>当某个请求在指定的超时时间内没有得到响应时，Istio 会终止该请求并返回一个错误响应给客户端。</p><p>这样可以防止请求在后端服务长时间等待，从而避免请求积压，同时提高系统的稳定性和可用性。</p><p>超时控制的意义如下：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">1.防止长时间等待:</span></span><br><span class="line">通过设置合理的请求超时时间，避免了客户端请求在后端服务长时间等待导致的响应延迟，从而提高了用户体验。</span><br><span class="line"></span><br><span class="line"><span class="section">2.快速失败机制:</span></span><br><span class="line">当后端服务无法及时响应请求时，超时控制会快速返回错误响应，而不是让请求无限期地等待，从而避免资源浪费。</span><br><span class="line"></span><br><span class="line"><span class="section">3.故障隔离:</span></span><br><span class="line">如果某个服务出现故障或变得不可用，超时控制可以快速终止对该服务的请求，避免故障扩散到其他服务。</span><br><span class="line"></span><br><span class="line">在 Istio 中，超时控制是通过配置请求超时策略来实现的。你可以为每个服务定义超时时间，也可以为整个服务部署或命名空间设置默认的超时时间。这样，Istio 会根据配置中的超时时间来对请求进行限制，保证请求在规定时间内得到响应。</span><br></pre></td></tr></table></figure><h2 id="Istio组件"><a href="#Istio组件" class="headerlink" title="Istio组件"></a>Istio组件</h2><h3 id="pilot"><a href="#pilot" class="headerlink" title="pilot"></a>pilot</h3><p>Pilot 是 Istio 控制平面的组件，在istio系统中，Pilot 完成以下任务：</p><p>它从服务注册中心（如Kubernetes的etcd或Consul）获取服务和实例的信息，并为Envoy生成配置，Envoy 根据 Pilot 发过来的配置里的内容，完成具体流量的转发。</p><p>Pilot可以被认为是团队的领袖。它负责监督和指导队伍中的每个Envoy。</p><p>Pilot指导整个团队中每个服务的位置，以及它们应该如何相互协作。</p><p>当有新队员加入或者队员的位置变化时，Pilot会负责通知每个队员，确保大家都知道最新的情况，不会出现迷路或者错过重要信息，会把要做的事形成文件下发到每个envoy队员里。</p><h3 id="envoy"><a href="#envoy" class="headerlink" title="envoy"></a>envoy</h3><p>Envoy是Istio中的代理，我们如果开启了istio功能，会在pod里自动注入Envoy代理容器，它负责处理服务之间的所有网络通信，拦截并转发所有的HTTP、TCP和gRPC流量。</p><p>Envoy提供强大的流量控制和管理功能，如路由、重试、超时和故障注入等。</p><p>Envoy和主容器同属于一个Pod，共享网络和命名空间，Envoy代理进出Pod 的流量，并将流量按照外部请求的规则作用于主容器中。</p><p>Envoy可以看作是服务之间的守护者。它像一个中间人一样，坐在每个服务旁边（就像每个队员身边都有一个保镖一样）。它负责处理服务之间的所有信息传递，确保信息传送得又快又准确。如果有请求从一个服务发出，Envoy会帮它找到正确的目标服务并将请求送达过去。它还能处理各种不同类型的请求，就像精通各种语言的翻译一样。</p><h3 id="galley"><a href="#galley" class="headerlink" title="galley"></a>galley</h3><p>Galley是Istio的配置管理组件，负责验证、转换和分发配置给其他Istio组件。</p><p>它监听Kubernetes的配置更改，例如Service、Deployment等，然后根据规则和策略生成Istio所需的配置，并将其提供给Pilot和其他组件。</p><p>Galley可以被看作是团队中的文件管理员。它负责管理团队中所有的文件和信息，确保每个队员都能得到正确的信息和文件。当有新的文件产生或者文件发生变化时，Galley会及时通知团队中的每个成员，确保大家都使用的是最新的文件，不会出现信息不同步的问题。</p><h3 id="Ingressgateway"><a href="#Ingressgateway" class="headerlink" title="Ingressgateway"></a>Ingressgateway</h3><p>istio-ingressgateway是Istio服务网格中的一个特殊网关，它作为整个网格的入口，接收外部请求，并将它们引导到内部的服务。</p><p>可以将它比作一个大门保安，负责接收外部人员的访问请求，然后根据配置的规则将请求分发给网格内部的服务。</p><p>简单来说，当有外部的请求访问Istio服务网格时，它们会先被送到istio-ingressgateway。</p><p>这个网关会检查请求，并根据一些规则判断该请求应该交给哪个服务来处理。</p><p>然后，它将请求转发给网格内部的相应服务，从而实现外部请求与内部服务的连接。</p><h3 id="egressgateway"><a href="#egressgateway" class="headerlink" title="egressgateway"></a>egressgateway</h3><p>istio-egressgateway是Istio服务网格中的另一个特殊网关，它负责处理网格内部服务对外部服务的访问请求。</p><p>可以将它看作是一个网格内部的出口，负责将内部服务需要访问的外部服务请求发送到外部。</p><p>以将istio-egressgateway比作一个秘书，它会代表网格内部的服务，帮助它们联系外部的服务。</p><p>当网格内部的服务需要访问外部服务时，它们会将请求交给istio-egressgateway，然后由这个网关将请求发送给外部服务。</p><h2 id="安装-卸载istio"><a href="#安装-卸载istio" class="headerlink" title="安装/卸载istio"></a>安装/卸载istio</h2><p>当安装完成istio之后，就会自动生成三个pod，分别为：istiod、Ingressgateway、egressgateway，然后就可以使用它的熔断、超时、重试等功能。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line">由于<span class="selector-tag">k8s</span>集群在1<span class="selector-class">.24</span>版本之后使用的容器运行时不同，那么所安装<span class="selector-tag">istio</span>的方法也不同，下面是<span class="selector-tag">k8s</span>集群版本1<span class="selector-class">.24</span>前后的安装<span class="selector-tag">istio</span>方式</span><br><span class="line">在大于等于<span class="selector-tag">k8s</span>集群1<span class="selector-class">.24</span>版本的情况下需要安装的<span class="selector-tag">istio</span>版本要大于等于1<span class="selector-class">.18</span>版本。</span><br></pre></td></tr></table></figure><h3 id="k8s集群小于等于1-23版本安装istio"><a href="#k8s集群小于等于1-23版本安装istio" class="headerlink" title="k8s集群小于等于1.23版本安装istio"></a>k8s集群小于等于1.23版本安装istio</h3><p>k8s集群版本：1.23.1</p><p>下载istio的安装包：</p><p>官网下载地址：<a href="https://gcsweb.istio.io/gcs/istio-release/releases/" target="_blank" rel="noopener">GCS browser: istio-release</a></p><p>这里使用的版本是istio:1.13.1 (可使用wget 下载)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget  https:<span class="regexp">//g</span>csweb.istio.io<span class="regexp">/gcs/i</span>stio-release<span class="regexp">/releases/</span><span class="number">1.13</span>.<span class="number">1</span><span class="regexp">/istio-1.13.1-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载到k8s集群的master节点并解压</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# tar</span> zxf istio-<span class="number">1.13</span>.<span class="number">1</span>.tar.gz</span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# cd</span> istio-<span class="number">1.13</span>.<span class="number">1</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">13.1</span>]<span class="comment"># cp bin/istioctl /usr/bin/                  //拷贝执行文件到/usr/bin下</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">13.1</span>]<span class="comment"># istioctl install --set profile=demo -y     //初始化安装，如下所示表示安装成功。</span></span><br><span class="line">✔ Istio core installed                     </span><br><span class="line">✔ Istiod installed                            </span><br><span class="line">✔ Egress gateways installed                       </span><br><span class="line">✔ Ingress gateways installed                   </span><br><span class="line">✔ Installation complete</span><br><span class="line">Making this installation the default for injection <span class="keyword">and</span> validation.</span><br><span class="line"></span><br><span class="line">Thank you for installing Istio <span class="number">1.13</span>.  Please take a few minutes to tell us about your install/upgrade experience!  https://forms.gle/pzWZpAvMVBecaQ9h9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装成功之后，查看istio的pod是否运行成功，如下</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">13.1</span>]<span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">istio-egressgateway-<span class="number">76</span>c96658fd-<span class="number">78</span>ll2   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">114s</span></span><br><span class="line">istio-ingressgateway-<span class="number">569</span>d7bfb4-pg5vz   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">114s</span></span><br><span class="line">istiod-<span class="number">74</span>c64d89cb-xdxn4                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2m</span>41s</span><br></pre></td></tr></table></figure><h3 id="k8s集群大于等于1-24版本安装istio"><a href="#k8s集群大于等于1-24版本安装istio" class="headerlink" title="k8s集群大于等于1.24版本安装istio"></a>k8s集群大于等于1.24版本安装istio</h3><p>k8s集群版本：1.28.1</p><p>下载istio的安装包：</p><p>官网下载地址： <a href="https://gcsweb.istio.io/gcs/istio-release/releases/" target="_blank" rel="noopener">GCS browser: istio-release</a></p><p>这里使用的版本是istio:1.182 (可使用wget 下载)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget  https:<span class="regexp">//g</span>csweb.istio.io<span class="regexp">/gcs/i</span>stio-release<span class="regexp">/releases/</span><span class="number">1.18</span>.<span class="number">2</span><span class="regexp">/istio-1.18.2-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# tar</span> -zxvf istio-<span class="number">1.18</span>.<span class="number">2</span>-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# cd</span> istio-<span class="number">1.18</span>.<span class="number">2</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">18.2</span>]<span class="comment"># cp bin/istioctl /bin/</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">18.2</span>]<span class="comment"># istioctl install --set profile=demo -y   //如下表示安装成功</span></span><br><span class="line">✔ Istio core installed                         </span><br><span class="line">✔ Istiod installed                          </span><br><span class="line">✔ Ingress gateways installed                       </span><br><span class="line">✔ Egress gateways installed                   </span><br><span class="line">✔ Installation complete                     </span><br><span class="line">Making this installation the default for injection <span class="keyword">and</span> validation.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证pod运行情况</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">18.2</span>]<span class="comment"># kubectl get pods -n istio-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">istio-egressgateway-<span class="number">5499894</span>f8d-nvtrv    <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">22s</span></span><br><span class="line">istio-ingressgateway-<span class="number">77</span>fbf9d476-thtnp   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">22s</span></span><br><span class="line">istiod-<span class="number">77</span>c989fb-<span class="number">4</span>xf8g                   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">27s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不同于k8s集群1.23以下版本的安装方法就是使用的容器运行时不同，</span></span><br><span class="line"><span class="comment">#如使用containerd初始化安装istio时下载镜像失败，那么就是containerd没有配置好或者镜像源不可用等问题</span></span><br><span class="line"><span class="comment">#可以使用docker下载相关依赖镜像在打包传到containerd</span></span><br><span class="line"><span class="comment">#使用docker下载如下两个镜像并打包传到k8s工作节点上的containerd中，再进行初始化安装istio步骤即可。</span></span><br><span class="line"><span class="comment">#/istio/pilot:1.18.2</span></span><br><span class="line"><span class="comment">#/istio/proxyv2:1.18.2</span></span><br></pre></td></tr></table></figure><p>安装命令选项</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="builtin-name">set</span> <span class="attribute">profile</span>=demo -y</span><br><span class="line"></span><br><span class="line"><span class="attribute">profile</span>=<span class="string">""</span></span><br><span class="line">1.demo：适用于生产环境，会创建三个pod，包含istiod、ingressgateway、egressgateway</span><br><span class="line">2.default：这是一个最小配置，仅包含最基本的组件，如istiod和ingressgateway</span><br><span class="line">3.minimal：这个配置相对更加精简，只包含了必需的组件，适用于资源受限或轻量级的环境。只会安装istiod。</span><br></pre></td></tr></table></figure><p>通过如下命令可以看到选择安装的模式下都有哪些配置文件</p><p>如查看demo模式：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl<span class="built_in"> profile </span>dump demo</span><br></pre></td></tr></table></figure><h3 id="配置外部ip"><a href="#配置外部ip" class="headerlink" title="配置外部ip"></a>配置外部ip</h3><p>安装完之后由于我们没有负载均衡的环境，所以EXTERNAL-IP一直是pending的状态</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">kubectl</span> <span class="meta">get</span> <span class="keyword">svc </span>istio-ingressgateway -n istio-system</span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20251217165631321.png"><p>我们可以直接用节点ip+nodeport的方式访问，但是如果我们想要直接用域名访问，不在后面加nodeport的话，需要配置EXTERNAL-IP。</p><p>可以安装MetallLB，或者直接在svc里指定EXTERNAL-IP，这里我简单演示，就直接指定EXTERNAL-IP。</p><p>EXTERNAL-IP要和节点ip在同一个网段，我的局域网IP段是10.168.2.0/24</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: istio-ingressgateway</span><br><span class="line">  <span class="attribute">namespace</span>: istio-system</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: istio-ingressgateway</span><br><span class="line">    install.operator.istio.io/<span class="attribute">owning-resource</span>: unknown</span><br><span class="line">    install.operator.istio.io/<span class="attribute">owning-resource-namespace</span>: istio-system</span><br><span class="line">    <span class="attribute">istio</span>: ingressgateway</span><br><span class="line">    istio.io/<span class="attribute">rev</span>: default</span><br><span class="line">    operator.istio.io/<span class="attribute">component</span>: IngressGateways</span><br><span class="line">    operator.istio.io/<span class="attribute">managed</span>: Reconcile</span><br><span class="line">    operator.istio.io/<span class="attribute">version</span>: <span class="number">1.13</span>.<span class="number">1</span></span><br><span class="line">    <span class="attribute">release</span>: istio</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">    - <span class="attribute">name</span>: status-port</span><br><span class="line">      <span class="attribute">protocol</span>: TCP</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">15021</span></span><br><span class="line">      <span class="attribute">targetPort</span>: <span class="number">15021</span></span><br><span class="line">      <span class="attribute">nodePort</span>: <span class="number">31500</span></span><br><span class="line">    - <span class="attribute">name</span>: http2</span><br><span class="line">      <span class="attribute">protocol</span>: TCP</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">80</span></span><br><span class="line">      <span class="attribute">targetPort</span>: <span class="number">8080</span></span><br><span class="line">      <span class="attribute">nodePort</span>: <span class="number">30543</span></span><br><span class="line">    - <span class="attribute">name</span>: https</span><br><span class="line">      <span class="attribute">protocol</span>: TCP</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">443</span></span><br><span class="line">      <span class="attribute">targetPort</span>: <span class="number">8443</span></span><br><span class="line">      <span class="attribute">nodePort</span>: <span class="number">31268</span></span><br><span class="line">    - <span class="attribute">name</span>: tcp</span><br><span class="line">      <span class="attribute">protocol</span>: TCP</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">31400</span></span><br><span class="line">      <span class="attribute">targetPort</span>: <span class="number">31400</span></span><br><span class="line">      <span class="attribute">nodePort</span>: <span class="number">32276</span></span><br><span class="line">    - <span class="attribute">name</span>: tls</span><br><span class="line">      <span class="attribute">protocol</span>: TCP</span><br><span class="line">      <span class="attribute">port</span>: <span class="number">15443</span></span><br><span class="line">      <span class="attribute">targetPort</span>: <span class="number">15443</span></span><br><span class="line">      <span class="attribute">nodePort</span>: <span class="number">31693</span></span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">app</span>: istio-ingressgateway</span><br><span class="line">    <span class="attribute">istio</span>: ingressgateway</span><br><span class="line">  <span class="attribute">clusterIP</span>: <span class="number">10.233</span>.<span class="number">13.10</span></span><br><span class="line">  <span class="attribute">clusterIPs</span>:</span><br><span class="line">    - <span class="number">10.233</span>.<span class="number">13.10</span></span><br><span class="line">  <span class="attribute">type</span>: LoadBalancer</span><br><span class="line">  <span class="attribute">externalIPs</span>:    ##添加这两行，指定externalIP</span><br><span class="line">    - <span class="number">10.168</span>.<span class="number">2.249</span></span><br><span class="line">  <span class="attribute">sessionAffinity</span>: None</span><br><span class="line">  <span class="attribute">externalTrafficPolicy</span>: Cluster</span><br><span class="line">  <span class="attribute">ipFamilies</span>:</span><br><span class="line">    - IPv4</span><br><span class="line">  <span class="attribute">ipFamilyPolicy</span>: SingleStack</span><br><span class="line">  <span class="attribute">allocateLoadBalancerNodePorts</span>: true</span><br><span class="line">  <span class="attribute">internalTrafficPolicy</span>: Cluster</span><br></pre></td></tr></table></figure><p>修改完之后再查看，EXTERNAL-IP已配置：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">kubectl</span> <span class="meta">get</span> <span class="keyword">svc </span>istio-ingressgateway -n istio-system</span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20251217170457434.png"><p>这个其实是通过kube-proxy去转发流量，也就是iptables规则（kube-ipvs）：</p><img src="/2025/098b941b9d/image-20251217184028480.png"><p>现在把域名解析到这个EXTERNAL-IP就可以通过域名访问，而不需要在后面加nodeport。</p><h3 id="卸载istio"><a href="#卸载istio" class="headerlink" title="卸载istio"></a>卸载istio</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#该卸载方式会保留名称空间等一些组件遗留</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">18.2</span>]<span class="comment"># istioctl manifest generate --set profile=demo | kubectl delete -f -</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行完上述卸载命令之后也可以再次执行如下命令完全卸载。</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">istio-1</span>.<span class="number">18.2</span>]<span class="comment"># istioctl x uninstall --purge    //提示中输入y即可完全卸载</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如需重新安装继续执行istioctl install --set profile=demo -y即可。</span></span><br></pre></td></tr></table></figure><h2 id="k8s集群部署在线书店，启用istio"><a href="#k8s集群部署在线书店，启用istio" class="headerlink" title="k8s集群部署在线书店，启用istio"></a>k8s集群部署在线书店，启用istio</h2><p>使用istio自带的工具进行部署，如下步骤中的yaml文件都在解压istio压缩包中自带的。</p><p>在线书店（Bookinfo）应用分为四个单独的微服务</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）productpage这个微服务会调用details和reviews两个微服务，用来生成前端页面；</span><br><span class="line"><span class="number">2</span>）details这个微服务中包含了书籍的信息；</span><br><span class="line"><span class="number">3</span>）reviews这个微服务中包含了书籍相关的评论，它还会调用ratings微服务；</span><br><span class="line"><span class="number">4</span>）ratings这个微服务中包含了由书籍评价组成的评级信息。</span><br></pre></td></tr></table></figure><p>reviews微服务有3个版本</p><p>1）v1版本不会调用ratings服务；</p><p>2）v2版本会调用ratings服务，并使用1到5个黑色星形图标来显示评分信息；</p><p>3）v3版本会调用ratings服务，并使用1到5个红色星形图标来显示评分信息。</p><h3 id="配置istio自动注入代理容器功能"><a href="#配置istio自动注入代理容器功能" class="headerlink" title="配置istio自动注入代理容器功能"></a>配置istio自动注入代理容器功能</h3><p>部署应用前还需要为默认名称空间打上一个标签，可理解为开启istio自动注入代理容器功能。</p><p>因为下面步骤创建的pod等资源都在默认名称空间下创建，所以为默认名称空间打赏标签，</p><p>istio默认自动注入 sidecar，需要为default命名空间打上标签 istio-injection=enabled，这样在默认空间下创建pod istio就可以自动注入一个代理容器。</p><p><code>注：在别的名称空间创建pod时，要想istio自动注入代理容器，也要打上相同的标签</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#打标签</span></span><br><span class="line">[root@k8s-master ~]# kubectl label namespace<span class="built_in"> default </span><span class="attribute">istio-injection</span>=enabled</span><br><span class="line">namespace<span class="built_in">/default </span>labeled</span><br><span class="line"> </span><br><span class="line"><span class="comment">#验证查看</span></span><br><span class="line">[root@k8s-master ~]# kubectl <span class="builtin-name">get</span> ns --show-labels | egrep -i <span class="string">"status|default"</span> </span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">default           Active   18d   <span class="attribute">istio-injection</span>=enabled,kubernetes.io/metadata.name=default</span><br></pre></td></tr></table></figure><h3 id="关闭-istio自动注入代理容器功能"><a href="#关闭-istio自动注入代理容器功能" class="headerlink" title="关闭 istio自动注入代理容器功能"></a>关闭 istio自动注入代理容器功能</h3><p>如上所示，要想关闭istio自动注入代理容器功能，则需要将istio-injection=enabled该标签从名称空间上取消。</p><p>为了不影响下方的实验，该步骤功能了解即可，不用操作。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除标签</span></span><br><span class="line">[root@k8s-master ~]# kubectl label ns<span class="built_in"> default </span>istio-injection-</span><br><span class="line">namespace<span class="built_in">/default </span>unlabeled</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证查看</span></span><br><span class="line">[root@k8s-master ~]# kubectl <span class="builtin-name">get</span> ns --show-labels | egrep -i <span class="string">"status|default"</span> </span><br><span class="line">NAME              STATUS   AGE   LABELS</span><br><span class="line">default           Active   18d   kubernetes.io/metadata.<span class="attribute">name</span>=default</span><br></pre></td></tr></table></figure><h3 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h3><p>如下步骤使用的集群版本为1.28.1，容器运行时使用的是containerd</p><p>准备如下镜像到k8s集群的工作节点中</p><p>（不准备也可以，直接使用istio自带的yaml文件时也会自动下载）</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/istio/</span>examples-bookinfo-details-<span class="string">v1:</span><span class="number">1.17</span><span class="number">.0</span></span><br><span class="line"><span class="regexp">/istio/</span>examples-bookinfo-productpage-<span class="string">v1:</span><span class="number">1.17</span><span class="number">.0</span></span><br><span class="line"><span class="regexp">/istio/</span>examples-bookinfo-ratings-<span class="string">v1:</span><span class="number">1.17</span><span class="number">.0</span></span><br><span class="line"><span class="regexp">/istio/</span>examples-bookinfo-reviews-<span class="string">v1:</span><span class="number">1.17</span><span class="number">.0</span></span><br><span class="line"><span class="regexp">/istio/</span>examples-bookinfo-reviews-<span class="string">v2:</span><span class="number">1.17</span><span class="number">.0</span></span><br><span class="line"><span class="regexp">/istio/</span>examples-bookinfo-reviews-<span class="string">v3:</span><span class="number">1.17</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#进入到istio压缩包解压后的路径中，使用istio自带的yaml文件创建资源</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># cd istio-1.18.2/samples/bookinfo/platform/kube/      <span class="comment">//进入到目标路径</span></span></span><br><span class="line">[root@k8s-master kube]<span class="meta"># kubectl apply -f bookinfo.yaml                    <span class="comment">//找到目标yaml文件并执行创建</span></span></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br><span class="line">deployment.apps/productpage-v1 created</span><br><span class="line"></span><br><span class="line"><span class="meta">#验证在默认名称空间中创建的pod，yaml文件中默认定义的是一个容器服务，这里的2/2说明自动注入的代理容器也成功了。</span></span><br><span class="line">[root@k8s-master kube]<span class="meta"># kubectl get pods -owide </span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">details-v1<span class="number">-65</span>fbc6fbcf-f69qp       <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">5</span>m22s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.75</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line">productpage-v1<span class="number">-78</span>d88f8f58-v57dx   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">5</span>m22s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.77</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line">ratings-v1<span class="number">-7</span>fcc55c79f-vqmhc       <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">5</span>m22s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.76</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line">reviews-v1<span class="number">-66</span>c7d54957-nw96c       <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">5</span>m22s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.72</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line">reviews-v2<span class="number">-844777</span>b87c-nch5l       <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">5</span>m22s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.73</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line">reviews-v3-b48665d5c<span class="number">-7</span>m96m        <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">5</span>m22s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.74</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#验证查看创建svc</span></span><br><span class="line">[root@k8s-master kube]<span class="meta"># kubectl get svc -owide | grep -v kubernetes</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE     SELECTOR</span><br><span class="line">details       ClusterIP   <span class="number">10.101</span><span class="number">.228</span><span class="number">.3</span>    <span class="params">&lt;none&gt;</span>        <span class="number">9080</span>/TCP   <span class="number">5</span>m55s   app=details</span><br><span class="line">productpage   ClusterIP   <span class="number">10.102</span><span class="number">.85</span><span class="number">.97</span>    <span class="params">&lt;none&gt;</span>        <span class="number">9080</span>/TCP   <span class="number">5</span>m55s   app=productpage</span><br><span class="line">ratings       ClusterIP   <span class="number">10.99</span><span class="number">.175</span><span class="number">.240</span>   <span class="params">&lt;none&gt;</span>        <span class="number">9080</span>/TCP   <span class="number">5</span>m55s   app=ratings</span><br><span class="line">reviews       ClusterIP   <span class="number">10.99</span><span class="number">.185</span><span class="number">.174</span>   <span class="params">&lt;none&gt;</span>        <span class="number">9080</span>/TCP   <span class="number">5</span>m55s   app=reviews</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#使用七层代理访问bookinfo的前端pod（productpage-v1-78d88f8f58-v57dx），需要创建网关及虚拟服务</span></span><br><span class="line">[root@k8s-master kube]<span class="meta"># cd </span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># cd istio-1.18.2/samples/bookinfo/networking/              <span class="comment">//进入目标路径</span></span></span><br><span class="line">[root@k8s-master networking]<span class="meta"># cat bookinfo-gateway.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">apiVersion:</span> /v1alpha3</span><br><span class="line"><span class="symbol">kind:</span> Gateway          <span class="meta">#在默认名称空间创建网关资源，安装完成istio之后才会有的一个资源</span></span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> bookinfo-gateway</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  selector:</span>            <span class="meta">#标签选择器指定了具有istio: ingressgateway这个标签的pod，详见下图一，</span></span><br><span class="line"><span class="symbol">    istio:</span> ingressgateway</span><br><span class="line"><span class="symbol">  servers:</span>             <span class="meta">#如下指定了监听端口80及http的协议</span></span><br><span class="line">  - port:</span><br><span class="line"><span class="symbol">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="symbol">      name:</span> http</span><br><span class="line"><span class="symbol">      protocol:</span> HTTP</span><br><span class="line"><span class="symbol">    hosts:</span>             <span class="meta">#“*”表示访问任何域名，只要是来自http协议及端口80的请求都交给具有上面标签的pod，也就是下图一那个pod</span></span><br><span class="line">    - <span class="string">"*"</span></span><br><span class="line">---</span><br><span class="line"><span class="symbol">apiVersion:</span> /v1alpha3</span><br><span class="line"><span class="symbol">kind:</span> VirtualService   <span class="meta">#创建虚拟服务，将上面创建的网关绑定到虚拟服务上。</span></span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> bookinfo</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  hosts:</span></span><br><span class="line">  - <span class="string">"*"</span></span><br><span class="line"><span class="symbol">  gateways:</span>            <span class="meta">#指定上面网关的名称进行绑定</span></span><br><span class="line">  - bookinfo-gateway</span><br><span class="line"><span class="symbol">  http:</span></span><br><span class="line">  - match:             <span class="meta">#定义路由规则，如果请求的是如下定义的接口，（如：/productpage），那么将会该请求代理给下面定义的productpage</span></span><br><span class="line">    - uri:</span><br><span class="line"><span class="symbol">        exact:</span> /productpage</span><br><span class="line">    - uri:</span><br><span class="line"><span class="symbol">        prefix:</span> /static</span><br><span class="line">    - uri:</span><br><span class="line"><span class="symbol">        exact:</span> /login</span><br><span class="line">    - uri:</span><br><span class="line"><span class="symbol">        exact:</span> /logout</span><br><span class="line">    - uri:</span><br><span class="line"><span class="symbol">        prefix:</span> <span class="meta-keyword">/api/</span>v1/products</span><br><span class="line"><span class="symbol">    route:</span>             <span class="meta">#如上描述，将会代理给这里定义的productpage这个svc，而productpage这个svc的端口是9080，如下图二所示</span></span><br><span class="line">    - destination:</span><br><span class="line"><span class="symbol">        host:</span> productpage</span><br><span class="line"><span class="symbol">        port:</span></span><br><span class="line"><span class="symbol">          number:</span> <span class="number">9080</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line"><span class="meta">#创建该yaml文件</span></span><br><span class="line">[root@k8s-master networking]<span class="meta"># kubectl apply -f bookinfo-gateway.yaml </span></span><br><span class="line">gateway./bookinfo-gateway created</span><br><span class="line">virtualservice./bookinfo created</span><br><span class="line"></span><br><span class="line"><span class="meta">#查看验证</span></span><br><span class="line">[root@k8s-master networking]<span class="meta"># kubectl get gateway</span></span><br><span class="line">NAME               AGE</span><br><span class="line">bookinfo-gateway   <span class="number">51</span>s</span><br><span class="line">[root@k8s-master networking]<span class="meta"># kubectl get virtualservice</span></span><br><span class="line">NAME       GATEWAYS               HOSTS   AGE</span><br><span class="line">bookinfo   [<span class="string">"bookinfo-gateway"</span>]   [<span class="string">"*"</span>]   <span class="number">63</span>s</span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20250912171713638.png"> <img src="/2025/098b941b9d/image-20250912171849139.png"><h3 id="访问验证"><a href="#访问验证" class="headerlink" title="访问验证"></a>访问验证</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#访问上面bookinfo-gateway.yaml文件中gateway资源中指定的具有istio=ingressgateway标签的pod的前端service</span></span><br><span class="line"><span class="comment">#查看具有该标签的pod</span></span><br><span class="line">[root@k8s-master networking]# kubectl <span class="builtin-name">get</span> pods -l <span class="attribute">istio</span>=ingressgateway -A -owide </span><br><span class="line">NAMESPACE      NAME                                    READY   STATUS    RESTARTS   AGE  <span class="built_in"> IP </span>             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">istio-system   istio-ingressgateway-77fbf9d476-tr2gd   1/1     Running   0          23h   10.244.194.71   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看该pod的前端service，通过名称确认是istio-ingressgateway</span></span><br><span class="line">[root@k8s-master networking]# kubectl <span class="builtin-name">get</span> svc -n istio-system</span><br><span class="line">NAME                  <span class="built_in"> TYPE </span>          CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-egressgateway    ClusterIP      10.110.37.178   &lt;none&gt;        80/TCP,443/TCP                                                               23h</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.96.68.15     &lt;pending&gt;     15021:32520/TCP,80:31718/TCP,443:32483/TCP,31400:31230/TCP,15443:32205/TCP   23h</span><br><span class="line">istiod                 ClusterIP      10.102.48.108   &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        23h</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看该svc的endpoints，通过ip再次确认</span></span><br><span class="line">[root@k8s-master networking]# kubectl describe svc istio-ingressgateway -n istio-system | grep -i endpoints</span><br><span class="line">Endpoints:                10.244.194.71:15021</span><br><span class="line">Endpoints:                10.244.194.71:8080</span><br><span class="line">Endpoints:                10.244.194.71:8443</span><br><span class="line">Endpoints:                10.244.194.71:31400</span><br><span class="line">Endpoints:                10.244.194.71:15443</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问流量走向过程：</span></span><br><span class="line"><span class="comment">#浏览器访问k8s控制/工作节点的ip加具有istio=ingressgateway这个标签pod的前端service对应80端口的端口，也就是31718</span></span><br><span class="line"><span class="comment">#控制节点IP:192.168.57.131:31718</span></span><br><span class="line"><span class="comment">#访问该地址，就会把请求通过这个31718端口代理给该service的后端pod，也就是具有istio=ingressgateway这个标签pod</span></span><br><span class="line"><span class="comment">#然后访问指定路由/productpage，（192.168.57.131:31718/productpage），</span></span><br><span class="line"><span class="comment">#这样就能根据上面bookinfo-gateway.yaml文件定义的路由规则访问到productpage这个service的9080端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如下：</span></span><br><span class="line">[root@k8s-master networking]# kubectl <span class="builtin-name">get</span> svc | egrep -i <span class="string">"name|productpage"</span></span><br><span class="line">NAME         <span class="built_in"> TYPE </span>       CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">productpage   ClusterIP   10.102.85.97    &lt;none&gt;        9080/TCP   79m</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过endpoints查看该service的后端pod</span></span><br><span class="line">[root@k8s-master networking]# kubectl describe svc productpage | grep -i endpoints</span><br><span class="line">Endpoints:         10.244.194.77:9080</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看具有该ip的pod是哪个</span></span><br><span class="line">[root@k8s-master networking]# kubectl <span class="builtin-name">get</span> pods -owide | egrep -i <span class="string">"name|10.244.194.77"</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE  <span class="built_in"> IP </span>             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">productpage-v1-78d88f8f58-v57dx   2/2     Running   0          83m   10.244.194.77   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#浏览器访问如下图所示：  192.168.57.131:31718/productpage</span></span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20250912174418993.png"><h2 id="通过Istio实现灰度发布"><a href="#通过Istio实现灰度发布" class="headerlink" title="通过Istio实现灰度发布"></a>通过Istio实现灰度发布</h2><p>灰度发布也叫金丝雀部署 ，是指通过控制流量的比例，实现新老版本的逐步更替。</p><p>比如对于服务A 有两个版本 ， 当前两个版本同时部署， 控制流量的访问版本1比例90% ，访问版本2比例10% ，然后根据运行的效果逐步调整流量访问占比，直至最终版本1下线。</p><p>工作节点准备两个镜像进行测试实验：</p><p>这里使用的是nginx镜像，该镜像服务状态均一致，只是版本不同，用于测试灰度发布</p><p><code>nginx-v1 返回版本1</code></p><p><code>nginx-v2 返回本本2</code></p><h3 id="创建pod"><a href="#创建pod" class="headerlink" title="创建pod"></a>创建pod</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#使用nginx-v1镜像创建版本为1的pod</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># vim istio-pod-v1.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> apps/v1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> v1</span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> v1</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      app:</span> nginx-v1</span><br><span class="line"><span class="symbol">      test:</span> abc</span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> nginx-v1</span><br><span class="line"><span class="symbol">        test:</span> abc</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - name: nginx</span><br><span class="line"><span class="symbol">        image:</span> nginx:v1</span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">        ports:</span></span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f istio-pod-v1.yaml </span></span><br><span class="line">deployment.apps/v1 created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get pods -owide    #READY显示2/2，表示istio的代理容器也运行成功 </span></span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">v1<span class="number">-6</span>b67b54dfc-qvjvl   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">13</span>s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.95</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#测试返回值版本为 v1</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># curl 10.244.194.95</span></span><br><span class="line">nginx-v1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#使用nginx-v2镜像创建版本为2的pod</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># cp istio-pod-v1.yaml istio-pod-v2.yaml </span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># vim istio-pod-v2.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> apps/v1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> v2</span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> v2</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      app:</span> nginx-v2</span><br><span class="line"><span class="symbol">      test:</span> abc</span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> nginx-v2</span><br><span class="line"><span class="symbol">        test:</span> abc</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - name: nginx</span><br><span class="line"><span class="symbol">        image:</span> nginx:v2</span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">        ports:</span></span><br><span class="line">        - containerPort: <span class="number">80</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f istio-pod-v2.yaml </span></span><br><span class="line">deployment.apps/v2 created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get pods -owide    #READY显示2/2，表示istio的代理容器也运行成功</span></span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">v1<span class="number">-6</span>b67b54dfc-qvjvl   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">2</span>m29s   <span class="number">10.244</span><span class="number">.194</span><span class="number">.95</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line">v2<span class="number">-68</span>c9d69c4f-jktr5   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">25</span>s     <span class="number">10.244</span><span class="number">.194</span><span class="number">.96</span>   k8s-worker1   <span class="params">&lt;none&gt;</span>           <span class="params">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#测试返回值版本为 v2</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># curl 10.244.194.96</span></span><br><span class="line">nginx-v2</span><br></pre></td></tr></table></figure><h3 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h3><p>创建service代理两个pod:</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#创建四层代理servic</span></span><br><span class="line"><span class="meta">#根据定义的标签确认后端的pod目标，找到具有test=abc的pod</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get pods -l test=abc</span></span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">v1<span class="number">-6</span>b67b54dfc-qvjvl   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">4</span>m56s</span><br><span class="line">v2<span class="number">-68</span>c9d69c4f-jktr5   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">2</span>m52s</span><br><span class="line"></span><br><span class="line"><span class="meta">#创建service</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># cat istio-pod-service.yaml </span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Service</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> istio-pod-nginx</span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    test:</span> abc</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    test:</span> abc</span><br><span class="line"><span class="symbol">  ports:</span></span><br><span class="line">    - protocol: TCP</span><br><span class="line"><span class="symbol">      port:</span> <span class="number">80</span></span><br><span class="line"><span class="symbol">      targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f istio-pod-service.yaml </span></span><br><span class="line">service/istio-pod-nginx created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get svc </span></span><br><span class="line">NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">istio-pod-nginx   ClusterIP   <span class="number">10.96</span><span class="number">.179</span><span class="number">.74</span>   <span class="params">&lt;none&gt;</span>        <span class="number">80</span>/TCP    <span class="number">3</span>s</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl describe svc istio-pod-nginx</span></span><br><span class="line"><span class="symbol">Name:</span>              istio-pod-nginx</span><br><span class="line"><span class="symbol">Namespace:</span>         default</span><br><span class="line"><span class="symbol">Labels:</span>            test=abc</span><br><span class="line"><span class="symbol">Annotations:</span>       <span class="params">&lt;none&gt;</span></span><br><span class="line"><span class="symbol">Selector:</span>          test=abc</span><br><span class="line"><span class="symbol">Type:</span>              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv4</span><br><span class="line"><span class="symbol">IP:</span>                <span class="number">10.96</span><span class="number">.179</span><span class="number">.74</span></span><br><span class="line"><span class="symbol">IPs:</span>               <span class="number">10.96</span><span class="number">.179</span><span class="number">.74</span></span><br><span class="line"><span class="symbol">Port:</span>              <span class="params">&lt;unset&gt;</span>  <span class="number">80</span>/TCP</span><br><span class="line"><span class="symbol">TargetPort:</span>        <span class="number">80</span>/TCP</span><br><span class="line"><span class="symbol">Endpoints:</span>         <span class="number">10.244</span><span class="number">.194</span><span class="number">.95</span>:<span class="number">80</span>,<span class="number">10.244</span><span class="number">.194</span><span class="number">.96</span>:<span class="number">80</span>        <span class="comment">//这里看到绑定的ip地址就是刚刚创建的nginx的pod的IP地址</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line"><span class="symbol">Events:</span>            <span class="params">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#测试请求service，如下所示请求是轮询</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># curl 10.96.179.74</span></span><br><span class="line">nginx-v2</span><br><span class="line">[root@k8s-master ~]<span class="meta"># curl 10.96.179.74</span></span><br><span class="line">nginx-v1</span><br><span class="line">[root@k8s-master ~]<span class="meta"># curl 10.96.179.74</span></span><br><span class="line">nginx-v2</span><br><span class="line">[root@k8s-master ~]<span class="meta"># curl 10.96.179.74</span></span><br><span class="line">nginx-v1</span><br></pre></td></tr></table></figure><h3 id="创建Gateway"><a href="#创建Gateway" class="headerlink" title="创建Gateway"></a>创建Gateway</h3><p>使用Gateway，通过istio的ingressgetway这个service，根据它映射的物理机端口31718，通过访问k8s集群节点的IP+31718，将请求交给到刚刚创建的pod前端的四层代理service，然后最终再通过这个四层代理service访问到它代理的后端pod。</p><p>istio的ingressgetway这个service的物理机映射端口如下图所示：</p><img src="/2025/098b941b9d/image-20250912175105040.png"><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="meta"># vim istio-pod-gzteway.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> /v1beta1</span><br><span class="line"><span class="symbol">kind:</span> Gateway</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> istio-pod-gateway</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    istio:</span> ingressgateway   <span class="meta">#查找具有该标签的pod</span></span><br><span class="line"><span class="symbol">  servers:</span></span><br><span class="line">  - port:</span><br><span class="line"><span class="symbol">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="symbol">      name:</span> http</span><br><span class="line"><span class="symbol">      protocol:</span> HTTP</span><br><span class="line"><span class="symbol">    hosts:</span>                 <span class="meta">#表示只要满足http协议的80端口的流量，那么任何域名都可以访问。</span></span><br><span class="line">    - <span class="string">"*"</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f istio-pod-gateway.yaml </span></span><br><span class="line">gateway./istio-pod-gateway created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get gateway</span></span><br><span class="line">NAME                AGE</span><br><span class="line">bookinfo-gateway    <span class="number">130</span>m</span><br><span class="line">istio-pod-gateway   <span class="number">7</span>s</span><br></pre></td></tr></table></figure><p>如果要配置https证书的话，修改如下（需要先申请证书，再引用）：</p><p>注：生成的证书需要和ingress-gateway在同一个namespace</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">istio-pod-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTPS</span></span><br><span class="line"><span class="attr">    hosts:</span>                 </span><br><span class="line"><span class="bullet">    -</span> <span class="string">public-gateway.example.com</span> <span class="comment"># 这里要与 Certificate 资源中的 dnsNames 匹配</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">SIMPLE</span></span><br><span class="line"><span class="attr">      credentialName:</span> <span class="string">public-gateway-example-com-tls</span> <span class="comment"># 这里要与生成的 secretName 匹配</span></span><br></pre></td></tr></table></figure><h3 id="创建虚拟服务VirtualService"><a href="#创建虚拟服务VirtualService" class="headerlink" title="创建虚拟服务VirtualService"></a>创建虚拟服务VirtualService</h3><p>定义访问流量的比例:</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="meta"># vim istio-pod-vlbetal.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> /v1beta1</span><br><span class="line"><span class="symbol">kind:</span> VirtualService</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> istio-pod-vlbetal</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  hosts:</span></span><br><span class="line">  - <span class="string">"*"</span></span><br><span class="line"><span class="symbol">  gateways:</span>                 <span class="meta">#绑定网关，指定gateway的名称</span></span><br><span class="line">  - istio-pod-gateway</span><br><span class="line"><span class="symbol">  http:</span></span><br><span class="line">  - route:                  <span class="meta">#路由</span></span><br><span class="line">    - destination:          <span class="meta">#目标地址</span></span><br><span class="line"><span class="symbol">        host:</span> istio-pod-nginx.default.svc.cluster.local   <span class="meta">#这里写目标地址1的名称，写的是四层代理service的名称+所在名称空间+完整域名的后缀</span></span><br><span class="line"><span class="symbol">        subset:</span> v1          <span class="meta">#定义子级权重。(子级也需要定义，定义自己指定的是哪个pod)</span></span><br><span class="line"><span class="symbol">      weight:</span> <span class="number">90</span>            <span class="meta">#定义v1的权重为90接收90%的流量</span></span><br><span class="line">    - destination:</span><br><span class="line"><span class="symbol">        host:</span> istio-pod-nginx.default.svc.cluster.local   <span class="meta">#这里写目标地址2的名称，同上前面是service名称及所在名称空间，后面的后缀为默认的。</span></span><br><span class="line"><span class="symbol">        subset:</span> v2</span><br><span class="line"><span class="symbol">      weight:</span> <span class="number">10</span>            <span class="meta">#同理，v2的权重为10，接收10%的流量</span></span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f istio-pod-vlbetal.yaml </span></span><br><span class="line">virtualservice./istio-pod-vlbetal created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get virtualService</span></span><br><span class="line">NAME                GATEWAYS                HOSTS   AGE</span><br><span class="line">bookinfo            [<span class="string">"bookinfo-gateway"</span>]    [<span class="string">"*"</span>]   <span class="number">163</span>m</span><br><span class="line">istio-pod-vlbetal   [<span class="string">"istio-pod-gateway"</span>]   [<span class="string">"*"</span>]   <span class="number">10</span>s</span><br></pre></td></tr></table></figure><h3 id="创建目标规则"><a href="#创建目标规则" class="headerlink" title="创建目标规则"></a>创建目标规则</h3><p>创建上方virtualService的yaml文件中定义的子级指向规则：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# vim</span> istio-pod-vlbetal-destination.yaml</span><br><span class="line">apiVersion: /v1beta1</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: istio-pod-vlbetal-destination </span><br><span class="line"><span class="keyword">spec</span>:</span><br><span class="line">  host: istio-pod-nginx.default.svc.cluster.local  <span class="comment">#这里同样定义service的完整域名</span></span><br><span class="line">  subsets:        <span class="comment">#定义子级</span></span><br><span class="line">  - name: v1      <span class="comment">#通过pod标签进行绑定指定</span></span><br><span class="line">    labels:       <span class="comment">#子级名称为v1的绑定具有如下标签的pod</span></span><br><span class="line">      app: nginx-v1</span><br><span class="line">  - name: v2      <span class="comment">#子级名称为v2的绑定具有如下标签的pod</span></span><br><span class="line">    labels:</span><br><span class="line">      app: nginx-v2</span><br><span class="line"></span><br><span class="line"><span class="comment">#确认具有如上定义标签的pod</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> get pods -l <span class="attr">app=</span>nginx-v1</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">v1-<span class="number">6</span>b67b54dfc-qvjvl   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">73m</span></span><br><span class="line"></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> get pods -l <span class="attr">app=</span>nginx-v2</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">v2-<span class="number">68</span>c9d69c4f-jktr5   <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">71m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> apply -f istio-pod-vlbetal-destination.yaml </span><br><span class="line">destinationrule./istio-pod-vlbetal-destination created</span><br><span class="line"></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> get destinationRule</span><br><span class="line">NAME                            HOST                                        AGE</span><br><span class="line">istio-pod-vlbetal-destination   istio-pod-nginx.default.svc.cluster.local   <span class="number">15s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证，定义了v1权重90，v2权重10，也就是说，访问100次只有10次可以访问到v2</span></span><br><span class="line"><span class="comment">#如下访问k8s集群任意的节点IP+istio的ingressgateway的service映射的物理机端口31718</span></span><br><span class="line"><span class="comment">#curl 192.168.57.131:31718</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用for循环请求一百次查看结果如下</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# for</span> i <span class="keyword">in</span> &#123;<span class="number">1</span>..<span class="number">100</span>&#125;;do curl <span class="number">192.168</span>.<span class="number">57.131</span>:<span class="number">31718</span>;done &gt; <span class="number">1</span>.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看请求结果如下：（与设置的权重百分比虽有偏差，但是非常接近）</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# cat</span> <span class="number">1</span>.txt | grep v1 | wc -l</span><br><span class="line"><span class="number">89</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# cat</span> <span class="number">1</span>.txt | grep v2 | wc -l</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure><h3 id="逐步增加-v2-版本的流量比例"><a href="#逐步增加-v2-版本的流量比例" class="headerlink" title="逐步增加 v2 版本的流量比例"></a>逐步增加 <code>v2</code> 版本的流量比例</h3><p>如果 <code>v2</code> 版本运行稳定，我们可以逐步增加其流量比例。修改 istio-pod-vlbetal.yaml 文件中的 <code>weight</code> 值，例如将 <code>v1</code> 的权重设置为 50，<code>v2</code> 的权重设置为 50，然后使用 <code>kubectl apply -fistio-pod-vlbetal.yaml</code>命令更新配置。</p><h3 id="高级灰度策略"><a href="#高级灰度策略" class="headerlink" title="高级灰度策略"></a>高级灰度策略</h3><p>除了简单的流量比例切分，Istio 还支持更高级的灰度策略，例如：</p><ul><li><strong>基于用户 ID 的灰度：</strong> 将特定用户 ID 的流量路由到新版本。</li><li><strong>基于 HTTP Header 的灰度：</strong> 根据 HTTP Header 中的特定字段，将流量路由到新版本。</li><li><strong>基于 Cookie 的灰度：</strong> 根据 Cookie 中的特定字段，将流量路由到新版本。</li></ul><p>这些高级策略可以帮助我们实现更精细的灰度发布，例如只让内部员工或特定用户体验新版本。</p><p>以下是一个基于 HTTP Header 的灰度示例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># productpage-virtualservice-header.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"productpage"</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">your-gateway</span> <span class="comment"># 替换为你的 Gateway 名称</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        user-agent:</span></span><br><span class="line"><span class="attr">          regex:</span> <span class="string">".*Mobile.*"</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">        subset:</span> <span class="string">v1</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># match：使用 headers 字段匹配 HTTP Header。这里将所有 User-Agent 包含 Mobile 字符串的请求路由到 v2 版本。</span></span><br></pre></td></tr></table></figure><h2 id="istio的核心功能"><a href="#istio的核心功能" class="headerlink" title="istio的核心功能"></a>istio的核心功能</h2><h3 id="熔断-1"><a href="#熔断-1" class="headerlink" title="熔断"></a>熔断</h3><p>熔断的目的是在出现故障或异常情况时，对服务进行自动的限流和隔离，以保护整个系统的稳定性和可用性。</p><p>首先创建一个pod服务进行熔断测试。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#参考使用istio自带的yaml文件</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">cd</span> <span class="string">istio-1.18.2/samples/httpbin/</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">cat</span> <span class="string">httpbin.yaml</span>   <span class="string">//该yaml文件创建了sa账号，service及pod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">      version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">        version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">/kong/httpbin</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">httpbin.yaml</span> </span><br><span class="line"><span class="string">serviceaccount/httpbin</span> <span class="string">created</span></span><br><span class="line"><span class="string">service/httpbin</span> <span class="string">created</span></span><br><span class="line"><span class="string">deployment.apps/httpbin</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="bullet">-owide</span></span><br><span class="line"><span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>              <span class="string">NODE</span>          <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">httpbin-65975d4c6f-2nvnw</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">14</span><span class="string">s</span>   <span class="number">10.244</span><span class="number">.194</span><span class="number">.97</span>   <span class="string">k8s-worker1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">sa</span> </span><br><span class="line"><span class="string">NAME</span>      <span class="string">SECRETS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">httpbin</span>   <span class="number">0</span>         <span class="number">18</span><span class="string">s</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">sve</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span></span><br><span class="line"><span class="string">NAME</span>              <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>    <span class="string">AGE</span></span><br><span class="line"><span class="string">httpbin</span>           <span class="string">ClusterIP</span>   <span class="number">10.98</span><span class="number">.237</span><span class="number">.91</span>   <span class="string">&lt;none&gt;</span>        <span class="number">8000</span><span class="string">/TCP</span>   <span class="number">29</span><span class="string">s</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">httpbin]#</span> <span class="string">kubectl</span> <span class="string">describe</span> <span class="string">svc</span> <span class="string">httpbin</span> <span class="string">| grep -i endpoints</span></span><br><span class="line"><span class="string"></span><span class="attr">Endpoints:</span>         <span class="number">10.244</span><span class="number">.194</span><span class="number">.97</span><span class="string">:80</span>    <span class="string">//确认该service已成功代理到新创建的httpbin的pod</span></span><br></pre></td></tr></table></figure><h4 id="配置熔断规则"><a href="#配置熔断规则" class="headerlink" title="配置熔断规则"></a>配置熔断规则</h4><p>对上方创建的pod服务进行配置熔断规则：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="meta"># vim destinationrule.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span>  /v1beta1</span><br><span class="line"><span class="symbol">kind:</span> DestinationRule</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> httpbin</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  host:</span> httpbin                        <span class="meta">#host指定service的名称，通过service找到它代理的后端pod</span></span><br><span class="line"><span class="symbol">  trafficPolicy:</span>                       <span class="meta">#配置熔断的策略</span></span><br><span class="line"><span class="symbol">    connectionPool:</span>                    <span class="meta">#配置熔断的连接池</span></span><br><span class="line"><span class="symbol">      tcp:</span>                             <span class="meta">#指定限制tcp协议连接的数量</span></span><br><span class="line"><span class="symbol">        maxConnections:</span> <span class="number">1</span>              <span class="meta">#指定每个目标服务最大连接数为1（目标就是上方定义的hosts指定的service所代理的后端pod）</span></span><br><span class="line"><span class="symbol">      http:</span>                            <span class="meta">#指定http协议的连接数</span></span><br><span class="line"><span class="symbol">        http1MaxPendingRequests:</span> <span class="number">1</span>     <span class="meta">#每个连接最大的挂起请求数为1，超过即阻塞</span></span><br><span class="line"><span class="symbol">        maxRequestsPerConnection:</span> <span class="number">1</span>    <span class="meta">#每个连接最大的请求数为1，每个连接最多只能处理一个请求</span></span><br><span class="line"><span class="symbol">    outlierDetection:</span>                  <span class="meta">#检测目标服务的异常情况（目标就是上方定义的hosts指定的service所代理的后端pod）</span></span><br><span class="line"><span class="symbol">      consecutiveGatewayErrors:</span> <span class="number">1</span>      <span class="meta">#访问目标服务的时候，目标会返回结果，如果返回错误大于等于1，则认为它异常</span></span><br><span class="line"><span class="symbol">      interval:</span> <span class="number">1</span>s                     <span class="meta">#探测时间为1秒探测一次</span></span><br><span class="line"><span class="symbol">      baseEjectionTime:</span> <span class="number">3</span>m             <span class="meta">#定义重新连接时间，探测异常之后，三分钟内不进行连接</span></span><br><span class="line"><span class="symbol">      maxEjectionPercent:</span> <span class="number">100</span>          <span class="meta">#100表示，只要探测一次失败，就将连接100%拒绝</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f destinationrule.yaml </span></span><br><span class="line">destinationrule./httpbin created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get DestinationRule</span></span><br><span class="line">NAME                            HOST                                        AGE</span><br><span class="line">httpbin                         httpbin                                     <span class="number">8</span>s</span><br></pre></td></tr></table></figure><h4 id="创建客户端模拟请求"><a href="#创建客户端模拟请求" class="headerlink" title="创建客户端模拟请求"></a>创建客户端模拟请求</h4><p>使用istio工具自带的yaml文件创建一个客户端进行模拟访问httpbin pod服务，从而测试熔断的规则是否生效。</p><p>该pod中运行的服务是fortio，fortio是专门对网站进行压测的。通过该工具调用httpbin服务从而测试熔断规则。</p><h5 id="创建fortio"><a href="#创建fortio" class="headerlink" title="创建fortio"></a>创建fortio</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入到目标路径</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">cd</span> <span class="string">istio-1.18.2/samples/httpbin/sample-client</span></span><br><span class="line"><span class="comment">#找到如下yaml文件</span></span><br><span class="line"><span class="comment">#该文件定义了一个servic，一个deployment控制器，该控制器管理一个pod副本，使用的镜像就是fortio/fortio:latest_release</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">sample-client]#</span> <span class="string">vim</span> <span class="string">fortio-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">fortio</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">fortio</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">fortio</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">fortio</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">fortio-deploy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">fortio</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="comment"># This annotation causes Envoy to serve cluster.outbound statistics via 15000/stats</span></span><br><span class="line">        <span class="comment"># in addition to the stats normally served by Istio. The Circuit Breaking example task</span></span><br><span class="line">        <span class="comment"># gives an example of inspecting Envoy stats via proxy config.</span></span><br><span class="line">        <span class="string">/config:</span> <span class="string">|-</span></span><br><span class="line"><span class="attr">          proxyStatsMatcher:</span></span><br><span class="line"><span class="attr">            inclusionPrefixes:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"cluster.outbound"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"cluster_manager"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"listener_manager"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"server"</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"cluster.xds-grpc"</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">fortio</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">fortio</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">fortio/fortio:latest_release</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">http-fortio</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8079</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">grpc-ping</span></span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line"><span class="comment">#创建</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">sample-client]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">fortio-deploy.yaml</span> </span><br><span class="line"><span class="string">service/fortio</span> <span class="string">created</span></span><br><span class="line"><span class="string">deployment.apps/fortio-deploy</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">sample-client]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> </span><br><span class="line"><span class="string">NAME</span>                             <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">fortio-deploy-77fd47587d-xc2rb</span>   <span class="number">1</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="string">httpbin-65975d4c6f-2nvnw</span>         <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">40</span><span class="string">m</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">sample-client]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> </span><br><span class="line"><span class="string">NAME</span>              <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>    <span class="string">AGE</span></span><br><span class="line"><span class="string">fortio</span>            <span class="string">ClusterIP</span>   <span class="number">10.108</span><span class="number">.185</span><span class="number">.62</span>   <span class="string">&lt;none&gt;</span>        <span class="number">8080</span><span class="string">/TCP</span>   <span class="number">14</span><span class="string">s</span></span><br><span class="line"><span class="string">httpbin</span>           <span class="string">ClusterIP</span>   <span class="number">10.98</span><span class="number">.237</span><span class="number">.91</span>    <span class="string">&lt;none&gt;</span>        <span class="number">8000</span><span class="string">/TCP</span>   <span class="number">40</span><span class="string">m</span></span><br></pre></td></tr></table></figure><h5 id="模拟访问请求"><a href="#模拟访问请求" class="headerlink" title="模拟访问请求"></a>模拟访问请求</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#测试请求一次，如下显示正常</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">sample-client</span>]<span class="comment"># kubectl exec fortio-deploy-77fd47587d-xc2rb -c fortio -- /usr/bin/fortio curl  http://httpbin:8000/get</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"ts"</span>:<span class="number">1731640199.687434</span>,<span class="string">"level"</span>:<span class="string">"info"</span>,<span class="string">"r"</span>:<span class="number">1</span>,<span class="string">"file"</span>:<span class="string">"scli.go"</span>,<span class="string">"line"</span>:<span class="number">122</span>,<span class="string">"msg"</span>:<span class="string">"Starting"</span>,<span class="string">"command"</span>:<span class="string">"Φορτίο"</span>,<span class="string">"version"</span>:<span class="string">"1.66.5 h1:WTJzTGOA12YWZSM5g43602lH+GOsmP3eKHXLnuRW4vs= go1.22.7 amd64 linux"</span>,<span class="string">"go-max-procs"</span>:<span class="number">2</span>&#125;</span><br><span class="line">&#123;<span class="string">"args"</span>:&#123;&#125;,<span class="string">"headers"</span>:&#123;<span class="string">"Host"</span>:<span class="string">"httpbin:8000"</span>,<span class="string">"User-Agent"</span>:<span class="string">"fortio.org/fortio-1.66.5"</span>,<span class="string">"X-B3-Parentspanid"</span>:<span class="string">"5d47d415a942dccc"</span>,<span class="string">"X-B3-Sampled"</span>:<span class="string">"1"</span>,<span class="string">"X-B3-Spanid"</span>:<span class="string">"66b7ec176aec3566"</span>,<span class="string">"X-B3-Traceid"</span>:<span class="string">"ff306f65ca8d3fe35d47d415a942dccc"</span>,<span class="string">"X-Envoy-Attempt-Count"</span>:<span class="string">"1"</span>,<span class="string">"X-Forwarded-Client-Cert"</span>:<span class="string">"By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=492b9ebc73979709b0651c1233de23aa512178f3199b2d3fab9bf9ede8c38232;Subject=\"\";URI=spiffe://cluster.local/ns/default/sa/default"</span>&#125;,<span class="string">"origin"</span>:<span class="string">"127.0.0.6"</span>,<span class="string">"url"</span>:<span class="string">"http://httpbin:8000/get"</span>&#125;</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="keyword">date</span>: Fri, <span class="number">15</span> Nov <span class="number">2024</span> <span class="number">03</span>:<span class="number">09</span>:<span class="number">59</span> GMT</span><br><span class="line">content-<span class="keyword">type</span>: application/json</span><br><span class="line">content-length: <span class="number">516</span></span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: <span class="number">19</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参数解释：</span><br><span class="line"><span class="comment">#exec    // 进入到目标pod   fortio （自己的fortio名称）</span></span><br><span class="line"><span class="comment">#-c      //指定pod中的容器 fortio</span></span><br><span class="line"><span class="comment">#-- /usr/bin/fortio curl  http://httpbin:8000/get //使用该命令请求httpbin</span></span><br></pre></td></tr></table></figure><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#测试多次请求，测试熔断中设置的http协议访问规则最大请求数及并发数等规则是否生效。</span></span><br><span class="line">[root@k8s-master sample-client]# kubectl exec -it fortio-deploy<span class="number">-77</span>fd47587d-xc2rb -c fortio -- /usr/bin/fortio load  -c <span class="number">2</span> -qps <span class="number">0</span> -n <span class="number">20</span> -loglevel Warning http:<span class="comment">//httpbin:8000/get</span></span><br><span class="line"></span><br><span class="line">参数解释：</span><br><span class="line"><span class="meta">#-c 2               //发起两个并发连接</span></span><br><span class="line"><span class="meta">#-qps 0             //每秒请求数为0，零表示不限制，测试请求过程中，每秒内都以最大的速率去请求。</span></span><br><span class="line"><span class="meta">#-n 20              //总的请求数为20次，配合-c 2 ，总共发起20次请求，两个并发。（也就是一个连接请求20次，并发两个）</span></span><br><span class="line"><span class="meta">#-loglevel Warning  //定义日志级别为Warning</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#如下图中的状态码可以看到Code 200 的返回了85.0 %，Code 503 的返回了15.0 %，</span></span><br><span class="line"><span class="meta">#可解释为，第一个请求20次的连接来了后就进行了相应，但是在20次请求中还没响应完成，第二个并发的请求就来了，导致了阻塞。</span></span><br><span class="line"><span class="meta">#由此可见熔断规则确实生效。（每个服务器不同，响应速度也不同，所以返回状态码的百分比也不相同）</span></span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20250912180412249.png"><h3 id="超时-1"><a href="#超时-1" class="headerlink" title="超时"></a>超时</h3><p>在多台服务器互相请求时为了避免等待的响应时间过长，从而堆积大量的请求阻塞了自身服务，造成雪崩的影响，这种情况下可以可以使用istio的“超时”功能。</p><p>如A服务，请求B服务，可以设置超时等待时间，如请求时超过了这个设置的等待时间，那么将不再等待请求，直接返回请求超时错误。</p><h4 id="创建测试超时使用的pod"><a href="#创建测试超时使用的pod" class="headerlink" title="创建测试超时使用的pod"></a>创建测试超时使用的pod</h4><p>这里使用了nginx、tomcat镜像创建pod，并创建svc代理这两个pod。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#使用deployment控制器创建nginx pod副本</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># vim timeout-deploy-nginx.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> apps/v1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> nginx</span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    server:</span> nginx</span><br><span class="line"><span class="symbol">    app:</span> web</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      server:</span> nginx</span><br><span class="line"><span class="symbol">      app:</span> web</span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      name:</span> nginx</span><br><span class="line"><span class="symbol">      labels:</span> </span><br><span class="line"><span class="symbol">        server:</span> nginx</span><br><span class="line"><span class="symbol">        app:</span> web</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - name: nginx</span><br><span class="line"><span class="symbol">        image:</span> nginx</span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line">        </span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f timeout-deploy-nginx.yaml </span></span><br><span class="line">deployment.apps/nginx created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get pods | egrep -i <span class="string">"name|nginx"</span></span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS      AGE</span><br><span class="line">nginx<span class="number">-9</span>d6c758bb<span class="number">-98</span>l49            <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>             <span class="number">23</span>s</span><br><span class="line">[root@k8s-master ~]<span class="meta"># </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#使用deployment控制器创建tomcat pod副本</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># vim timeout-deploy-tomcat.yaml</span></span><br><span class="line"><span class="symbol">apiVersion:</span> apps/v1</span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> tomcat</span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    server:</span> tomcat</span><br><span class="line"><span class="symbol">    app:</span> web</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      server:</span> tomcat</span><br><span class="line"><span class="symbol">      app:</span> web</span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      name:</span> tomcat</span><br><span class="line"><span class="symbol">      labels:</span> </span><br><span class="line"><span class="symbol">        server:</span> tomcat</span><br><span class="line"><span class="symbol">        app:</span> web</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">      - name: tomcat</span><br><span class="line"><span class="symbol">        image:</span> tomcat</span><br><span class="line"><span class="symbol">        imagePullPolicy:</span> IfNotPresent</span><br><span class="line">        </span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f timeout-deploy-tomcat.yaml</span></span><br><span class="line">deployment.apps/tomcat created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get pods | egrep -i <span class="string">"name|nginx|tomcat"</span></span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS      AGE</span><br><span class="line">nginx<span class="number">-9</span>d6c758bb<span class="number">-98</span>l49            <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>             <span class="number">4</span>m14s</span><br><span class="line">tomcat<span class="number">-5</span>fb5bd59cd<span class="number">-86</span>jwr          <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>             <span class="number">8</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#创建servic 代理nginx及tomcat pod。</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># vim timeout-nginx-tomcat-service.yaml</span></span><br><span class="line"> </span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Service</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> nginx-svc</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    server:</span> nginx</span><br><span class="line"><span class="symbol">  ports:</span></span><br><span class="line">  - name: http</span><br><span class="line"><span class="symbol">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="symbol">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="symbol">    protocol:</span> TCP</span><br><span class="line">---</span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Service</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> tomcat-svc</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    server:</span> tomcat</span><br><span class="line"><span class="symbol">  ports:</span></span><br><span class="line">  - name: http</span><br><span class="line"><span class="symbol">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="symbol">    targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="symbol">    protocol:</span> TCP</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">#创建</span></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl apply -f timeout-nginx-tomcat-service.yaml </span></span><br><span class="line">service/nginx-svc created</span><br><span class="line">service/tomcat-svc created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="meta"># kubectl get svc | egrep -i <span class="string">"nginx|tomcat"</span></span></span><br><span class="line">istio-pod-nginx   ClusterIP   <span class="number">10.96</span><span class="number">.179</span><span class="number">.74</span>     <span class="params">&lt;none&gt;</span>        <span class="number">80</span>/TCP     <span class="number">6</span>d21h</span><br><span class="line">nginx-svc         ClusterIP   <span class="number">10.97</span><span class="number">.48</span><span class="number">.223</span>     <span class="params">&lt;none&gt;</span>        <span class="number">80</span>/TCP     <span class="number">24</span>s</span><br><span class="line">tomcat-svc        ClusterIP   <span class="number">10.111</span><span class="number">.194</span><span class="number">.112</span>   <span class="params">&lt;none&gt;</span>        <span class="number">8080</span>/TCP   <span class="number">24</span>s</span><br></pre></td></tr></table></figure><h4 id="配置超时"><a href="#配置超时" class="headerlink" title="配置超时"></a>配置超时</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建pod</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">timeout-virtual-nginx-tomcat.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-vs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span>                    <span class="comment">#指定svc</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx-svc</span>               <span class="comment">#指定作用在nginx-svc，相当于作用的是它代理的nginx的pod</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span>          <span class="comment">#指定超时时间</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">nginx-svc</span>     <span class="comment">#指定目标</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">2</span><span class="string">s</span>             <span class="comment">#指定超时时间2秒</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-vs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">tomcat-svc</span>              <span class="comment">#同上，这里指定的是tomcat-svc</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - fault:</span>                  <span class="comment">#模拟注入配置故障规则</span></span><br><span class="line"><span class="attr">      delay:</span>                <span class="comment">#配置延迟响应的规则</span></span><br><span class="line"><span class="attr">        percentage:</span>         <span class="comment">#指定延迟流量的百分比</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">100</span>        <span class="comment">#这里指定100，表示100%的流量都会收到延迟响应</span></span><br><span class="line"><span class="attr">        fixedDelay:</span> <span class="number">10</span><span class="string">s</span>     <span class="comment">#指定延迟响应时间为10秒</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span>          <span class="comment">#指定访问的目标主机</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">tomcat-svc</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#创建</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">timeout-virtual-nginx-tomcat.yaml</span> </span><br><span class="line"><span class="string">virtualservice./nginx-vs</span> <span class="string">created</span></span><br><span class="line"><span class="string">virtualservice./tomcat-vs</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">VirtualService</span> <span class="string">| egrep -i "nginx|tomcat"</span></span><br><span class="line"><span class="string">nginx-vs                                    ["nginx-svc"]    21s</span></span><br><span class="line"><span class="string">tomcat-vs                                   ["tomcat-svc"]   21s</span></span><br></pre></td></tr></table></figure><h4 id="nginx配置反向代理tomcat"><a href="#nginx配置反向代理tomcat" class="headerlink" title="nginx配置反向代理tomcat"></a>nginx配置反向代理tomcat</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入到nginx  pod配置反向代理，将nginx请求代理到tomcat</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl exec -it nginx-9d6c758bb-98l49 -c nginx -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># vi /etc/nginx/conf.d/default.conf     //修改配置文件增加两行内容，如下图片所示：proxy_pass http://tomcat-svc:8080;proxy_http_version 1.1;</span></span><br><span class="line">/ <span class="comment"># nginx -t</span></span><br><span class="line">/ <span class="comment"># nginx -s reload                       //重启nginx</span></span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20250912180748969.png"><h4 id="测试超时规则"><a href="#测试超时规则" class="headerlink" title="测试超时规则"></a>测试超时规则</h4><p>这里使用了busybox镜像运行pod去访问nginx测试超时规则是否生效。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> run busybox --<span class="attr">image=</span>busybox --<span class="attr">restart=</span>Never --rm -it --<span class="attr">image-pull-policy=</span>IfNotPresent -- sh</span><br><span class="line">If you don\'t see a command prompt, try pressing enter.</span><br><span class="line">/ <span class="comment"># time wget -q -O - http://nginx-svc:80</span></span><br><span class="line">wget: server returned error: HTTP/<span class="number">1.1</span> <span class="number">504</span> Gateway Timeout</span><br><span class="line">//这里的<span class="number">504</span>超时，是因为超时规则设置的是最多等待两秒。tomcat配置的是延迟十秒，超过两秒则等待超时</span><br><span class="line"></span><br><span class="line">Command exited with non-zero status <span class="number">1</span></span><br><span class="line">real	<span class="number">0m</span> <span class="number">2.01s</span>          //这里显示的是实际执行时间。（<span class="number">2</span>秒）</span><br><span class="line"><span class="keyword">user</span>	<span class="title">0m</span> <span class="number">0.00s</span></span><br><span class="line">sys	<span class="number">0m</span> <span class="number">0.00s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试tomcat响应时间</span></span><br><span class="line">/ <span class="comment"># time wget -q -O - http://tomcat-svc:8080 | tail -n 3</span></span><br><span class="line">real	<span class="number">0m</span> <span class="number">10.01s</span>     //这里可看到，执行了十秒才响应。</span><br><span class="line"><span class="keyword">user</span>	<span class="title">0m</span> <span class="number">0.00s</span></span><br><span class="line">sys	<span class="number">0m</span> <span class="number">0.00s</span></span><br></pre></td></tr></table></figure><h3 id="故障注入和重试"><a href="#故障注入和重试" class="headerlink" title="故障注入和重试"></a>故障注入和重试</h3><p>“重试”，顾名思义，当第一次连接失败之后，可以根据配置的重试规则次数，在连接失败之后重新连接几次</p><p>根据上方测试”超时“时使用的nginx代理tomcat为例，测试“故障注入和重试”：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#因为需要配置“重试”规则，需要将上方测试“超时”时创建的VirtualService资源删除</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> delete -f timeout-virtual-nginx-tomcat.yaml </span><br><span class="line">virtualservice. <span class="string">"nginx-vs"</span> deleted</span><br><span class="line">virtualservice. <span class="string">"tomcat-vs"</span> deleted</span><br></pre></td></tr></table></figure><h4 id="配置重试规则并注入故障规则"><a href="#配置重试规则并注入故障规则" class="headerlink" title="配置重试规则并注入故障规则"></a>配置重试规则并注入故障规则</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置重试规则</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">vim</span> <span class="string">timeout-virtual-nginx-tomcat-02.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-vs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx-svc</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span></span><br><span class="line"><span class="attr">    - destination:</span>          <span class="comment">#指定作用的目标</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">nginx-svc</span></span><br><span class="line"><span class="attr">    retries:</span></span><br><span class="line"><span class="attr">      attempts:</span> <span class="number">3</span>           <span class="comment">#指定重试次数</span></span><br><span class="line"><span class="attr">      perTryTimeout:</span> <span class="number">2</span><span class="string">s</span>     <span class="comment">#指定每两秒重试一次</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">tomcat-vs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">tomcat-svc</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - fault:</span>                  <span class="comment">#模拟注入故障规则</span></span><br><span class="line"><span class="attr">      abort:</span></span><br><span class="line"><span class="attr">        percentage:</span>         <span class="comment">#指定访问流量百分比</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">        httpStatus:</span> <span class="number">503</span>     <span class="comment">#指定请求返回错误结果为503</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span>          <span class="comment">#指定目标</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">tomcat-svc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建</span></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">timeout-virtual-nginx-tomcat-02.yaml</span> </span><br><span class="line"><span class="string">virtualservice./nginx-vs</span> <span class="string">created</span></span><br><span class="line"><span class="string">virtualservice./tomcat-vs</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">VirtualService</span> <span class="string">| egrep -i "nginx|tomcat"</span></span><br><span class="line"><span class="string">nginx-vs                                    ["nginx-svc"]    12s</span></span><br><span class="line"><span class="string">tomcat-vs                                   ["tomcat-svc"]   12s</span></span><br></pre></td></tr></table></figure><h4 id="测试重试规则"><a href="#测试重试规则" class="headerlink" title="测试重试规则"></a>测试重试规则</h4><p>继续使用busybox镜像进行访问测试：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> run busybox --<span class="attr">image=</span>busybox --<span class="attr">restart=</span>Never --rm -it --<span class="attr">image-pull-policy=</span>IfNotPresent -- sh</span><br><span class="line">If you don\'t see a command prompt, try pressing enter.</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># wget -q -O - http://nginx-svc:80          //访问测试</span></span><br><span class="line">wget: server returned error: HTTP/<span class="number">1.1</span> <span class="number">503</span> Service Unavailable</span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#观察nginx pod中的istio代理容器日志查看是否发生了重试</span></span><br><span class="line">[root@k8s-<span class="keyword">master</span> <span class="title">~]# kubectl</span> logs -f nginx-<span class="number">9</span>d6c758bb-<span class="number">98</span>l49 -c istio-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment">#日志内容如下图所示，重试了四次，且每次都返回了503（首次访问失败并按照配置的重试规则进行重新访问了3次，一共4次）</span></span><br></pre></td></tr></table></figure><img src="/2025/098b941b9d/image-20250912181138747.png"><h2 id="Istio网关额外配置"><a href="#Istio网关额外配置" class="headerlink" title="Istio网关额外配置"></a>Istio网关额外配置</h2><h3 id="IP黑白名单"><a href="#IP黑白名单" class="headerlink" title="IP黑白名单"></a>IP黑白名单</h3><p>当<strong>服务受到攻击</strong>，或者<strong>只允许服务在某些 IP 下才可以访问</strong>的时候，通常的做法是为服务加上 <strong>IP 黑白名单</strong>。</p><p>在配置好Gateway，virtualservice后可以从集群外访问集群内的服务，如果想限制特定的IP访问不了可以加入黑名单：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: security.istio.io/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: AuthorizationPolicy</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: ingress-policy</span><br><span class="line">  <span class="attribute">namespace</span>: istio-system</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">matchLabels</span>:</span><br><span class="line">      <span class="attribute">app</span>: istio-ingressgateway</span><br><span class="line">  <span class="attribute">action</span>: DENY</span><br><span class="line">  <span class="attribute">rules</span>:</span><br><span class="line">  - <span class="attribute">from</span>:</span><br><span class="line">    - <span class="attribute">source</span>:</span><br><span class="line">       <span class="attribute">ipBlocks</span>: [<span class="string">"38.75.137.213"</span>]</span><br><span class="line">    <span class="attribute">to</span>:</span><br><span class="line">    - <span class="attribute">operation</span>:</span><br><span class="line">        <span class="attribute">hosts</span>:</span><br><span class="line">        - httpbin.makeoptim.com</span><br></pre></td></tr></table></figure><p>这里，我的 IP 是 <code>38.75.137.213</code>，而在 <code>AuthorizationPolicy</code> 中，设置了 <code>DENY</code> 并指向 <code>httpbin.makeoptim.com</code>。</p><p>这时，再次访问 <code>httpbin.makeoptim.com</code> 就会返回 <code>RBAC: access denied</code>，表示已经成功设置了黑名单。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ curl httpbin<span class="selector-class">.makeoptim</span><span class="selector-class">.com</span>/get</span><br><span class="line">RBAC: access denied</span><br></pre></td></tr></table></figure><p>注：</p><p>1.<code>ipBlocks</code> 可以支持单个 IP (e.g. “1.2.3.4”) 和 CIDR (e.g. “1.2.3.0/24”)</p><p>2.上面的例子为设置黑名单，白名单就是把 <code>DENY</code> 变成 <code>ALLOW</code></p><p>3.to/operation/hosts 可以指定某些 host，这样可以只对某些服务做黑白名单，而不影响到整个服务网格。</p><h3 id="限制请求体大小"><a href="#限制请求体大小" class="headerlink" title="限制请求体大小"></a>限制请求体大小</h3><p><strong>对所有 ingressgateway 生效</strong></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> networking.istio.io/v1alpha3</span><br><span class="line"><span class="symbol">kind:</span> EnvoyFilter</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> limit-request-size</span><br><span class="line"><span class="symbol">  namespace:</span> istio-system <span class="meta"># istio-system 表示针对所有命名空间生效</span></span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  workloadSelector:</span> <span class="meta"># 选中所有 ingressgateway</span></span><br><span class="line"><span class="symbol">    labels:</span></span><br><span class="line"><span class="symbol">      istio:</span> ingressgateway <span class="meta"># 所有 ingressgateway 都带此 label</span></span><br><span class="line"><span class="symbol">  configPatches:</span></span><br><span class="line">    - applyTo: HTTP_FILTER</span><br><span class="line"><span class="symbol">      match:</span></span><br><span class="line"><span class="symbol">        context:</span> GATEWAY</span><br><span class="line"><span class="symbol">        listener:</span></span><br><span class="line"><span class="symbol">          filterChain:</span></span><br><span class="line"><span class="symbol">            filter:</span></span><br><span class="line"><span class="symbol">              name:</span> <span class="string">"envoy.http_connection_manager"</span></span><br><span class="line"><span class="symbol">      patch:</span></span><br><span class="line"><span class="symbol">        operation:</span> INSERT_BEFORE</span><br><span class="line"><span class="symbol">        value:</span></span><br><span class="line"><span class="symbol">          name:</span> <span class="string">"envoy.filters.http.buffer"</span></span><br><span class="line"><span class="symbol">          typed_config:</span></span><br><span class="line">            <span class="string">"@type"</span>: <span class="string">"type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer"</span></span><br><span class="line"><span class="symbol">            max_request_bytes:</span> <span class="number">1048576</span> <span class="meta"># 1MB, 请求最大限制</span></span><br></pre></td></tr></table></figure><p><strong>对指定 ingressgateway 生效</strong></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> networking.istio.io/v1alpha3</span><br><span class="line"><span class="symbol">kind:</span> EnvoyFilter</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> limit-request-size</span><br><span class="line"><span class="symbol">  namespace:</span> prod <span class="meta"># 选择指定 ingressgateway 所在的命名空间</span></span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  workloadSelector:</span> <span class="meta"># 选中指定 ingressgateway</span></span><br><span class="line"><span class="symbol">    labels:</span></span><br><span class="line"><span class="symbol">      app:</span> istio-ingressgateway-public <span class="meta"># 替换指定 ingressgateway 的 label</span></span><br><span class="line"><span class="symbol">  configPatches:</span></span><br><span class="line">    - applyTo: HTTP_FILTER</span><br><span class="line"><span class="symbol">      match:</span></span><br><span class="line"><span class="symbol">        context:</span> GATEWAY</span><br><span class="line"><span class="symbol">        listener:</span></span><br><span class="line"><span class="symbol">          filterChain:</span></span><br><span class="line"><span class="symbol">            filter:</span></span><br><span class="line"><span class="symbol">              name:</span> <span class="string">"envoy.http_connection_manager"</span></span><br><span class="line"><span class="symbol">      patch:</span></span><br><span class="line"><span class="symbol">        operation:</span> INSERT_BEFORE</span><br><span class="line"><span class="symbol">        value:</span></span><br><span class="line"><span class="symbol">          name:</span> <span class="string">"envoy.filters.http.buffer"</span></span><br><span class="line"><span class="symbol">          typed_config:</span></span><br><span class="line">            <span class="string">"@type"</span>: <span class="string">"type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer"</span></span><br><span class="line"><span class="symbol">            max_request_bytes:</span> <span class="number">1048576</span> <span class="meta"># 1MB, 请求最大限制</span></span><br></pre></td></tr></table></figure></div><div><div id="reward-container"><div>Thank you for your accept. mua！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/reward/wechatpay.png" alt="丨逸贤丨 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/reward/alipay.png" alt="丨逸贤丨 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>丨逸贤丨</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://yixian12580.github.io/2025/098b941b9d.html" title="服务网格Istio安装及使用">https://yixian12580.github.io/2025/098b941b9d.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:16px">-------------本文结束<i class="fa fa-heart"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/服务网格/" rel="tag"><i class="fa fa-tag"></i> 服务网格</a> <a href="/tags/Istio/" rel="tag"><i class="fa fa-tag"></i> Istio</a> <a href="/tags/灰度发布/" rel="tag"><i class="fa fa-tag"></i> 灰度发布</a> <a href="/tags/熔断/" rel="tag"><i class="fa fa-tag"></i> 熔断</a> <a href="/tags/超时/" rel="tag"><i class="fa fa-tag"></i> 超时</a> <a href="/tags/故障注入/" rel="tag"><i class="fa fa-tag"></i> 故障注入</a> <a href="/tags/重试/" rel="tag"><i class="fa fa-tag"></i> 重试</a></div><div class="post-widgets"><div class="social_share"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2025/09f71c8c0e.html" rel="next" title="k8s更新应用版本优雅终止旧pod"><i class="fa fa-chevron-left"></i> k8s更新应用版本优雅终止旧pod</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2025/09872234a1.html" rel="prev" title="Istio灰度发布的流量策略">Istio灰度发布的流量策略 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div><div style="text-align:center"><a href="https://github.com/yixian12580/blog-source/edit/main/source/_posts/服务网格Istio安装及使用.md" target="_blank">编辑文章✏</a></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC81NzIwNy8zMzY3MQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="丨逸贤丨"><p class="site-author-name" itemprop="name">丨逸贤丨</p><div class="site-description motion-element" itemprop="description">三十年众生牛马，搏十年丰功伟绩。</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">149</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">137</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/yixian12580" title="GitHub &rarr; https://github.com/yixian12580" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1083662409@qq.com" title="E-Mail &rarr; mailto:1083662409@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://weibo.com/u/5107819265" title="Weibo &rarr; https://weibo.com/u/5107819265" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="tencent://message/?uin=1083662409&Site=&menu=yes" title="QQ &rarr; tencent://message/?uin=1083662409&Site=&menu=yes" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-book"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://www.ttlsa.com/" title="http://www.ttlsa.com/" rel="noopener" target="_blank">运维生存时间</a></li><li class="links-of-blogroll-item"><a href="https://www.iyunw.cn" title="https://www.iyunw.cn" rel="noopener" target="_blank">爱运维</a></li><li class="links-of-blogroll-item"><a href="https://nginxconfig.io/" title="https://nginxconfig.io/" rel="noopener" target="_blank">Nginxconfig</a></li><li class="links-of-blogroll-item"><a href="http://linux.51yip.com/" title="http://linux.51yip.com/" rel="noopener" target="_blank">Linux命令手册</a></li><li class="links-of-blogroll-item"><a href="https://echarts.apache.org/index.html" title="https://echarts.apache.org/index.html" rel="noopener" target="_blank">echarts可视化库</a></li><li class="links-of-blogroll-item"><a href="https://yixian12580.netlify.app/admin/" title="https://yixian12580.netlify.app/admin/" rel="noopener" target="_blank">博客管理</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#流量管理"><span class="nav-number">1.</span> <span class="nav-text">流量管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#熔断"><span class="nav-number">1.1.</span> <span class="nav-text">熔断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#超时"><span class="nav-number">1.2.</span> <span class="nav-text">超时</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Istio组件"><span class="nav-number">2.</span> <span class="nav-text">Istio组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pilot"><span class="nav-number">2.1.</span> <span class="nav-text">pilot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#envoy"><span class="nav-number">2.2.</span> <span class="nav-text">envoy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#galley"><span class="nav-number">2.3.</span> <span class="nav-text">galley</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ingressgateway"><span class="nav-number">2.4.</span> <span class="nav-text">Ingressgateway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#egressgateway"><span class="nav-number">2.5.</span> <span class="nav-text">egressgateway</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-卸载istio"><span class="nav-number">3.</span> <span class="nav-text">安装/卸载istio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s集群小于等于1-23版本安装istio"><span class="nav-number">3.1.</span> <span class="nav-text">k8s集群小于等于1.23版本安装istio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s集群大于等于1-24版本安装istio"><span class="nav-number">3.2.</span> <span class="nav-text">k8s集群大于等于1.24版本安装istio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置外部ip"><span class="nav-number">3.3.</span> <span class="nav-text">配置外部ip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#卸载istio"><span class="nav-number">3.4.</span> <span class="nav-text">卸载istio</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s集群部署在线书店，启用istio"><span class="nav-number">4.</span> <span class="nav-text">k8s集群部署在线书店，启用istio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置istio自动注入代理容器功能"><span class="nav-number">4.1.</span> <span class="nav-text">配置istio自动注入代理容器功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-istio自动注入代理容器功能"><span class="nav-number">4.2.</span> <span class="nav-text">关闭 istio自动注入代理容器功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署应用"><span class="nav-number">4.3.</span> <span class="nav-text">部署应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问验证"><span class="nav-number">4.4.</span> <span class="nav-text">访问验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过Istio实现灰度发布"><span class="nav-number">5.</span> <span class="nav-text">通过Istio实现灰度发布</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建pod"><span class="nav-number">5.1.</span> <span class="nav-text">创建pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建service"><span class="nav-number">5.2.</span> <span class="nav-text">创建service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Gateway"><span class="nav-number">5.3.</span> <span class="nav-text">创建Gateway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建虚拟服务VirtualService"><span class="nav-number">5.4.</span> <span class="nav-text">创建虚拟服务VirtualService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建目标规则"><span class="nav-number">5.5.</span> <span class="nav-text">创建目标规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#逐步增加-v2-版本的流量比例"><span class="nav-number">5.6.</span> <span class="nav-text">逐步增加 v2 版本的流量比例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高级灰度策略"><span class="nav-number">5.7.</span> <span class="nav-text">高级灰度策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#istio的核心功能"><span class="nav-number">6.</span> <span class="nav-text">istio的核心功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#熔断-1"><span class="nav-number">6.1.</span> <span class="nav-text">熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置熔断规则"><span class="nav-number">6.1.1.</span> <span class="nav-text">配置熔断规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建客户端模拟请求"><span class="nav-number">6.1.2.</span> <span class="nav-text">创建客户端模拟请求</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建fortio"><span class="nav-number">6.1.2.1.</span> <span class="nav-text">创建fortio</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#模拟访问请求"><span class="nav-number">6.1.2.2.</span> <span class="nav-text">模拟访问请求</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#超时-1"><span class="nav-number">6.2.</span> <span class="nav-text">超时</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建测试超时使用的pod"><span class="nav-number">6.2.1.</span> <span class="nav-text">创建测试超时使用的pod</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置超时"><span class="nav-number">6.2.2.</span> <span class="nav-text">配置超时</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx配置反向代理tomcat"><span class="nav-number">6.2.3.</span> <span class="nav-text">nginx配置反向代理tomcat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试超时规则"><span class="nav-number">6.2.4.</span> <span class="nav-text">测试超时规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障注入和重试"><span class="nav-number">6.3.</span> <span class="nav-text">故障注入和重试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置重试规则并注入故障规则"><span class="nav-number">6.3.1.</span> <span class="nav-text">配置重试规则并注入故障规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试重试规则"><span class="nav-number">6.3.2.</span> <span class="nav-text">测试重试规则</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Istio网关额外配置"><span class="nav-number">7.</span> <span class="nav-text">Istio网关额外配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IP黑白名单"><span class="nav-number">7.1.</span> <span class="nav-text">IP黑白名单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#限制请求体大小"><span class="nav-number">7.2.</span> <span class="nav-text">限制请求体大小</span></a></li></ol></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><style>.aplayer .aplayer-lrc{height:35px}.aplayer .aplayer-lrc p{font-size:16px;font-weight:700;line-height:19.2px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{color:#ff1493}.aplayer.aplayer-narrow .aplayer-body{left:-66px!important}</style><div class="aplayer" data-id="7622186670" data-server="netease" data-type="playlist" data-fixed="true" data-order="random" data-autoplay="false"></div><script src="/dist/Meting.min.js"></script></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright" style="text-align:center">&copy; 2022 – <span itemprop="copyrightYear">2026</span> <span class="with-love" id="animate"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">逸贤</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart">站点字数合计:</i> </span><span title="站点总字数">1.1m</span></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="run_time" style="text-align:center"><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("09/08/2022 10:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="本站已安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒"}setInterval("createtime()",250)</script></div><div class="busuanzi-count" style="text-align:center"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/js/utils.js?v=7.1.1"></script><script src="/js/motion.js?v=7.1.1"></script><script src="/js/schemes/muse.js?v=7.1.1"></script><script src="/js/scrollspy.js?v=7.1.1"></script><script src="/js/post-details.js?v=7.1.1"></script><script src="/js/next-boot.js?v=7.1.1"></script><script>window.livereOptions={refer:"2025/098b941b9d.html"},function(e,t){var n,r=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,r.parentNode.insertBefore(n,r))}(document,"script")</script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={iconStyle:"box",boxForm:"horizontal",position:"bottomCenter",networks:"Weibo,Wechat,Douban,QQZone,Twitter,Facebook"},new needShareButton("#needsharebutton-postbottom",pbOptions)</script><script src="/lib/bookmark/bookmark.min.js?v=1.0"></script><script>bookmark.scrollToMark("auto","#更多")</script><script>$(".highlight").not(".gist .highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=e,document.body.appendChild(n),n.select(),n.setSelectionRange(0,e.length),n.readOnly=!1,document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script></body></html><script type="text/javascript" src="/js/src/clicklove.js"></script><script type="text/javascript" src="/js/click_show_text.js"></script><script type="text/javascript" src="/js/FunnyTitle.js"></script><script src="/live2d-widget/autoload.js"></script>